<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>trader_koo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #0b0f16;
      --panel: #121927;
      --muted: #8ea0bd;
      --text: #e9eef8;
      --line: #25334f;
      --green: #38d39f;
      --red: #ff6b6b;
      --amber: #f8c24e;
      --blue: #6aa9ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "IBM Plex Sans", ui-monospace, SFMono-Regular, Menlo, monospace;
      background: radial-gradient(1200px 600px at 10% -10%, #1d2740 0%, var(--bg) 45%);
      color: var(--text);
    }
    .wrap { max-width: 1360px; margin: 0 auto; padding: 24px; }

    /* ── Nav ── */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0 16px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 0;
      font-family: 'Inter', sans-serif;
    }
    .nav-logo {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--text);
      text-decoration: none;
    }
    .nav-links { display: flex; gap: 28px; }
    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 13.5px;
      letter-spacing: .02em;
      transition: color .2s;
    }
    .nav-links a:hover { color: var(--text); }

    /* ── Hero ── */
    .hero {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 18px;
      padding: 22px 0 20px;
      font-family: 'Inter', sans-serif;
    }
    .hero-title {
      font-size: clamp(30px, 6vw, 46px);
      font-weight: 700;
      line-height: 1.05;
      letter-spacing: -.03em;
      margin: 0 0 6px;
      background: linear-gradient(135deg, #e9eef8 28%, #6aa9ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-sub {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
      font-weight: 400;
    }
    .status-pill {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 12px;
      padding: 8px 14px;
      color: var(--muted);
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      word-break: break-word;
    }
    input, select, button, textarea {
      width: 100%;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }
    textarea {
      min-height: 110px;
      resize: vertical;
      font-family: inherit;
    }
    .status { color: var(--muted); font-size: 0.9rem; }
    .top-disclaimer {
      margin-bottom: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(248, 194, 78, 0.32);
      background: linear-gradient(180deg, rgba(248, 194, 78, 0.08), rgba(255, 107, 107, 0.05));
      border-radius: 12px;
      color: #f3dfb1;
      font-size: 0.82rem;
      line-height: 1.5;
    }
    .top-disclaimer b { color: #ffe2a1; }
    .tabs { display: flex; gap: 8px; margin-bottom: 14px; }
    .tab-btn {
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--muted);
      padding: 9px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .tab-btn.active {
      color: white;
      background: linear-gradient(90deg, #1f7bff, #4e9cff);
      border: none;
    }
    .hidden { display: none; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
    }
    .op-toolbar {
      display: grid;
      grid-template-columns: 170px 150px 150px 140px 170px minmax(170px, 1fr) 120px 120px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .preset-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 0 10px 0;
    }
    .preset-toolbar button {
      width: auto;
      padding: 8px 12px;
      border-radius: 9px;
      font-size: 0.82rem;
      background: #0f1624;
      color: var(--text);
      border: 1px solid var(--line);
      cursor: pointer;
    }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { color: var(--muted); font-size: 0.72rem; }
    .op-help {
      margin-bottom: 8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0f1624;
    }
    .op-help-title {
      color: var(--text);
      font-size: 0.82rem;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .op-help-grid {
      display: grid;
      grid-template-columns: 170px 1fr;
      gap: 6px 10px;
      align-items: start;
    }
    .op-help-key { color: var(--muted); font-size: 0.8rem; }
    .op-help-val { color: var(--text); font-size: 0.82rem; }
    .op-status {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      min-height: 34px;
      max-width: 100%;
      overflow-x: auto;
      padding: 2px 0;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.78rem;
      white-space: normal;
      word-break: break-word;
    }
    .status-chip .k { color: var(--muted); }
    .status-chip .v { color: var(--text); font-weight: 700; }
    .status-plain {
      color: var(--muted);
      font-size: 0.88rem;
    }
    .chart-toolbar {
      display: grid;
      grid-template-columns: 180px 150px 125px 125px 135px 135px 110px 75px 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 10px;
      margin: 10px 0 14px;
    }
    .card {
      background: linear-gradient(180deg, #141d2f, #101726);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      min-height: 72px;
    }
    .report-list {
      margin: 0;
      padding-left: 20px;
      line-height: 1.6;
      color: var(--text);
      font-size: 0.84rem;
    }
    .report-list li { margin-bottom: 6px; }
    .mini-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .mini-actions button {
      width: auto;
      padding: 5px 9px;
      border-radius: 8px;
      font-size: 0.74rem;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      cursor: pointer;
    }
    .mini-actions button:hover { border-color: var(--blue); }
    .report-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 8px 0;
    }
    .report-toggle-btn {
      width: auto;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.76rem;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--muted);
      cursor: pointer;
    }
    .report-toggle-btn.active {
      color: #fff;
      border-color: transparent;
      background: linear-gradient(90deg, #1f7bff, #4e9cff);
    }
    .report-inline-note {
      color: var(--muted);
      font-size: 0.78rem;
      line-height: 1.5;
    }
    .report-watch-wrap {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    .report-watch-wrap input {
      flex: 1 1 180px;
      min-width: 160px;
      width: auto;
    }
    .report-watch-wrap button {
      width: auto;
      padding: 8px 10px;
      font-size: 0.76rem;
    }
    .heatmap-grid {
      display: grid;
      gap: 6px;
      margin-bottom: 8px;
    }
    .heat-row {
      display: grid;
      grid-template-columns: 120px 1fr 70px;
      gap: 8px;
      align-items: center;
      font-size: 0.78rem;
    }
    .heat-track {
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #0f1624;
      overflow: hidden;
      position: relative;
    }
    .heat-fill {
      height: 100%;
      border-radius: 999px;
    }
    .admin-shell {
      display: grid;
      gap: 12px;
    }
    .admin-top {
      display: grid;
      grid-template-columns: minmax(280px, 420px) minmax(0, 1fr);
      gap: 12px;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: minmax(320px, 0.95fr) minmax(0, 1.45fr);
      gap: 12px;
    }
    .admin-grid.admin-lower {
      grid-template-columns: minmax(0, 1.1fr) minmax(300px, 0.9fr);
    }
    .admin-panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .admin-subtle {
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.5;
    }
    .admin-inline-status {
      color: var(--muted);
      font-size: 0.78rem;
    }
    .admin-login-grid,
    .admin-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .admin-form-grid .field.full,
    .admin-login-grid .field.full {
      grid-column: 1 / -1;
    }
    .admin-form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }
    .admin-form-actions button {
      width: auto;
      min-width: 130px;
    }
    .admin-checks {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 10px 0 12px;
    }
    .admin-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      font-size: 0.76rem;
      white-space: normal;
      word-break: break-word;
    }
    .admin-chip.ok {
      border-color: rgba(56, 211, 159, 0.35);
      color: #9ee7ca;
    }
    .admin-chip.bad {
      border-color: rgba(255, 107, 107, 0.35);
      color: #ffb3b3;
    }
    .admin-meta {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-bottom: 8px;
    }
    .admin-meta-item {
      min-width: 0;
    }
    .admin-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }
    .admin-links a {
      color: var(--blue);
      text-decoration: none;
      font-size: 0.8rem;
    }
    .admin-links a:hover {
      text-decoration: underline;
    }
    .admin-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .admin-detail-block {
      min-width: 0;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #0f1624;
      padding: 10px;
    }
    .json-block {
      margin: 8px 0 0;
      max-height: 280px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.77rem;
      line-height: 1.55;
      color: var(--text);
    }
    .admin-empty {
      color: var(--muted);
      font-size: 0.82rem;
      padding: 12px 0;
    }
    #tabAdmin table {
      width: max-content;
      min-width: 100%;
      font-size: 0.82rem;
    }
    #tabAdmin th,
    #tabAdmin td {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: top;
    }
    .label { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .value { font-size: 1.05rem; font-weight: 700; margin-top: 8px; }
    #chart { width: 100%; height: 760px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tr.clickable:hover { background: rgba(106,169,255,0.12); cursor: pointer; }
    .table-wrap { margin-top: 12px; display: grid; grid-template-columns: repeat(2, minmax(420px, 1fr)); gap: 12px; }
    .table-wrap > .panel { min-width: 0; overflow-x: auto; }
    #tabReport .panel { min-width: 0; overflow-x: auto; }
    #tabReport table {
      width: max-content;
      min-width: 100%;
      font-size: 0.82rem;
    }
    #reportSetupCompactTable {
      width: 100%;
      min-width: 100%;
      table-layout: fixed;
    }
    #tabReport th,
    #tabReport td {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: top;
    }
    #reportStatus,
    #reportBreadthSummary,
    #reportYoloDeltaSummary,
    #reportSetupSummary,
    #reportWatchHint {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .guide,
    .guide p,
    .guide li,
    .guide-v,
    .guide summary,
    .guide-callout,
    .site-footnote {
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .mkt-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }
    .mkt-bar button {
      width: auto;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
      background: #0f1624;
      color: var(--muted);
      border: 1px solid var(--line);
      cursor: pointer;
    }
    .mkt-bar button:hover { color: var(--text); border-color: var(--blue); }
    @media (max-width: 1100px) {
      .op-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
      .op-toolbar .field { flex: 1 1 140px; }
      .op-toolbar button { flex: 0 0 auto; width: auto; }
      .chart-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
      .chart-toolbar > * { flex: 1 1 130px; min-width: 0; }
      .chart-toolbar button { flex: 0 0 auto; width: auto; }
      .admin-top,
      .admin-grid,
      .admin-grid.admin-lower,
      .admin-detail-grid,
      .admin-meta {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 640px) {
      .wrap { padding: 12px; }
      #chart { height: 420px; }
      .table-wrap { grid-template-columns: 1fr; }
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .card { min-height: 64px; padding: 8px 10px; }
      .label { font-size: 0.68rem; }
      .value { font-size: 0.95rem; }
      .hero { flex-direction: column; align-items: flex-start; gap: 12px; }
      .status-pill { width: 100%; border-radius: 10px; }
      nav { flex-wrap: wrap; gap: 10px; }
      .nav-links { gap: 14px; flex-wrap: wrap; }
      .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .tab-btn { padding: 8px 10px; font-size: 0.82rem; }
      #tabReport .panel { padding: 8px; overflow-x: auto; }
      #tabReport table { min-width: 560px; font-size: 0.78rem; }
      #report52wHigh span, #report52wLow span {
        display: block !important;
        margin-right: 0 !important;
      }
      .report-watch-wrap { flex-direction: column; align-items: stretch; }
      .report-watch-wrap input, .report-watch-wrap button { width: 100%; }
      .mini-actions button { flex: 1 1 calc(50% - 6px); }
      .heat-row { grid-template-columns: 86px 1fr 58px; gap: 6px; font-size: 0.74rem; }
      .admin-login-grid,
      .admin-form-grid {
        grid-template-columns: 1fr;
      }
      .admin-form-actions button {
        width: 100%;
      }
      #tabAdmin table {
        min-width: 560px;
        font-size: 0.78rem;
      }
    }
    @media (max-width: 420px) {
      .tabs { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
      .mini-actions button { flex: 1 1 100%; }
      #tabReport table { min-width: 500px; }
    }
    .guide {
      line-height: 1.55;
      color: var(--text);
      font-size: 0.92rem;
      overflow-x: hidden;
    }
    .guide h3 {
      margin: 12px 0 8px;
      font-size: 1rem;
      color: var(--text);
    }
    .guide p {
      margin: 0 0 8px;
      color: var(--muted);
    }
    .guide-list {
      margin: 0 0 10px 18px;
      padding: 0;
      color: var(--muted);
    }
    .guide-list li { margin: 0 0 6px; }
    .guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .guide-grid,
    .guide-card,
    .guide details,
    .guide summary,
    .guide-callout {
      min-width: 0;
      max-width: 100%;
    }
    .guide-card {
      background: #0f1624;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .guide-k {
      color: var(--muted);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }
    .guide-v {
      color: var(--text);
      font-size: 0.84rem;
      line-height: 1.45;
    }
    .guide-callout {
      background: rgba(255,107,107,0.12);
      border: 1px solid #ff6b6b;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .guide-callout-title {
      color: #ff8a8a;
      font-weight: 700;
      font-size: 0.92rem;
      margin-bottom: 4px;
    }
    .guide details {
      background: #0f1624;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
    }
    .guide summary {
      display: block;
      cursor: pointer;
      color: var(--text);
      font-weight: 600;
      font-size: 0.86rem;
      outline: none;
    }
    .guide details p,
    .guide details ul { margin-top: 8px; }
    .site-footnote {
      margin: 14px auto 24px;
      max-width: 1360px;
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.5;
      text-align: center;
    }
    .site-footnote strong {
      color: #ff8a8a;
      font-weight: 700;
    }
    @media (max-width: 640px) {
      .guide { font-size: 0.88rem; }
      .guide-grid { grid-template-columns: 1fr; }
      .guide-list { margin-left: 14px; }
      .guide details { padding: 8px; }
      .guide summary { font-size: 0.82rem; }
      .site-footnote { padding: 10px 12px; font-size: 0.76rem; }
      .top-disclaimer { font-size: 0.76rem; padding: 9px 10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a class="nav-logo" href="https://kooexperience.com">HK</a>
      <div class="nav-links">
        <a href="https://kooexperience.com">Home</a>
        <a href="https://github.com/haomingkoo" target="_blank" rel="noopener">GitHub</a>
      </div>
    </nav>
    <div class="top-disclaimer">
      <b>Research only. Not financial advice.</b> This dashboard can be wrong, stale, or incomplete. Treat it as a decision-support tool, not an instruction to buy or sell.
    </div>
    <section class="hero">
      <div>
        <h1 class="hero-title">trader_koo</h1>
        <p class="hero-sub">S&amp;P 500 swing dashboard — AI pattern detection, valuation screening, and after-close signals.</p>
      </div>
      <div id="serviceStatus" class="status-pill">Connecting...</div>
    </section>
    <div id="globalStatus" class="status" style="margin-bottom: 10px; font-size: 0.82rem;"></div>
    <input id="apiBase" type="hidden" value="" />


    <div class="tabs">
      <button id="tabAdminBtn" class="tab-btn">Control Center</button>
      <button id="tabGuideBtn" class="tab-btn active">Guide</button>
      <button id="tabReportBtn" class="tab-btn">Daily Report</button>
      <button id="tabChartBtn" class="tab-btn">Chart + Levels</button>
      <button id="tabOpBtn" class="tab-btn">Opportunities (PEG)</button>
    </div>

    <section id="tabOp" class="panel hidden">
      <div id="opFilterHelp" class="op-help">
        Default is full S&P500 universe. Use presets for quick screens, then sort/search table.
      </div>
      <div class="preset-toolbar">
        <button id="presetAllBtn" type="button">All S&P 500</button>
        <button id="presetUndervaluedBtn" type="button">Undervalued</button>
        <button id="presetDeepValueBtn" type="button">Deep Value</button>
        <button id="presetOvervaluedBtn" type="button">Overvalued</button>
        <button id="presetResetBtn" type="button">Reset</button>
      </div>
      <div class="op-toolbar">
        <div class="field">
          <label for="opView">View</label>
          <select id="opView">
            <option value="undervalued">Undervalued</option>
            <option value="deep_value">Deep Value</option>
            <option value="overvalued">Overvalued</option>
            <option value="all" selected>All (Full Universe)</option>
          </select>
        </div>
        <div class="field">
          <label for="minDiscount">Min Discount %</label>
          <input id="minDiscount" type="number" step="1" value="10" />
        </div>
        <div class="field">
          <label for="maxPeg">Max PEG</label>
          <input id="maxPeg" type="number" step="0.1" value="2.0" />
        </div>
        <div class="field">
          <label for="overvaluedThreshold">Overvalued Threshold %</label>
          <input id="overvaluedThreshold" type="number" step="1" value="-10" />
        </div>
        <div class="field">
          <label for="limitRows">Max Rows</label>
          <input id="limitRows" type="number" step="1" value="500" />
        </div>
        <div class="field">
          <label for="opSearch">Search Table</label>
          <input id="opSearch" type="text" placeholder="ticker, reason, etc" />
        </div>
        <button id="clearOpSearchBtn" type="button">Clear Search</button>
        <button id="loadOpBtn">Load</button>
      </div>
      <div id="opStatus" class="op-status"><span class="status-plain">Auto-loading full S&P500 table...</span></div>
      <div style="overflow-x: auto; max-width: 100%;"><table id="opTable"></table></div>
    </section>

    <section id="tabChart" class="hidden">
      <div class="panel">
        <div class="chart-toolbar">
          <input id="ticker" list="tickerList" value="SPY" placeholder="Ticker e.g. NVDA" />
          <datalist id="tickerList"></datalist>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showTrendlines" type="checkbox" style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Show Trendlines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showPatterns" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Show Patterns</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showRuleClassLines" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Rule/Hybrid Lines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showBollinger" type="checkbox" style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Bollinger Bands</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showYoloPatterns" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">YOLO Patterns</span>
          </label>
          <div class="field" style="display:flex; flex-direction:row; align-items:center; gap:4px;">
            <span style="font-size:0.75rem; color:var(--muted);">Bars:</span>
            <button id="tfDailyBtn" style="padding:2px 9px; font-size:0.78rem; background:var(--blue); color:#fff; border:none; border-radius:3px; cursor:pointer;">D</button>
            <button id="tfWeeklyBtn" style="padding:2px 9px; font-size:0.78rem; background:var(--card); color:var(--muted); border:1px solid var(--border); border-radius:3px; cursor:pointer;">W</button>
          </div>
          <button id="loadChartBtn">Load</button>
          <div id="chartStatus" class="status">Select ticker and load</div>
        </div>
        <div class="mkt-bar">
          <span style="color:var(--muted); font-size:0.75rem;">Market:</span>
          <button onclick="loadTickerQuick('SPY')">SPY</button>
          <button onclick="loadTickerQuick('QQQ')">QQQ</button>
          <button onclick="loadTickerQuick('^VIX')">VIX</button>
          <button onclick="loadTickerQuick('SVIX')">SVIX</button>
          <button onclick="loadTickerQuick('^GSPC')">SPX</button>
          <button onclick="loadTickerQuick('^DJI')">DJI</button>
          <button onclick="loadTickerQuick('^TNX')">TNX</button>
        </div>

        <div class="cards">
          <div class="card"><div class="label">Price</div><div id="c-price" class="value">-</div></div>
          <div class="card"><div class="label">PE</div><div id="c-pe" class="value">-</div></div>
          <div class="card"><div class="label">PEG</div><div id="c-peg" class="value">-</div></div>
          <div class="card"><div class="label">Target</div><div id="c-target" class="value">-</div></div>
          <div class="card"><div class="label">Discount %</div><div id="c-discount" class="value">-</div></div>
          <div class="card"><div class="label">Put/Call OI</div><div id="c-pcr" class="value">-</div></div>
        </div>

        <div id="chart"></div>
      </div>

      <div class="table-wrap">
        <div class="panel">
          <div class="label">Levels</div>
          <table id="levelsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Open Gaps</div>
          <table id="gapsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Trendlines</div>
          <table id="trendlinesTable"></table>
        </div>
        <div class="panel">
          <div class="label">Pattern Candidates</div>
          <table id="patternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Hybrid Pattern Scores</div>
          <table id="hybridPatternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Pattern Overlays (Drawn)</div>
          <table id="patternOverlaysTable"></table>
        </div>
        <div class="panel">
          <div class="label">Candlestick Signals</div>
          <table id="candlesTable"></table>
        </div>
        <div class="panel">
          <div class="label">YOLO AI Patterns</div>
          <table id="yoloPatternsTable"></table>
        </div>
      </div>
    </section>

    <section id="tabReport" class="panel hidden">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:1.1rem;">Daily Report</h2>
        <span id="reportStatus" style="font-size:0.8rem; color:var(--muted);"></span>
      </div>
      <div id="reportSummaryCards" class="cards" style="margin-bottom:14px;"></div>
      <div id="reportYoloCards" class="cards" style="margin-bottom:14px;"></div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Tonight's 5 Key Changes</div>
        <ol id="reportKeyChangesList" class="report-list"></ol>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">No-Trade Conditions</div>
        <div id="reportRiskSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:8px;"></div>
        <ul id="reportRiskList" class="report-list"></ul>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Watchlist</div>
        <div class="report-watch-wrap">
          <input id="reportWatchTickerInput" type="text" placeholder="Add ticker (e.g. NVDA)" />
          <button id="reportWatchAddBtn" type="button">Add</button>
          <button id="reportWatchImportBtn" type="button">Import Top 5 Setups</button>
          <button id="reportWatchClearBtn" type="button">Clear</button>
        </div>
        <div id="reportWatchHint" style="font-size:0.78rem; color:var(--muted); margin-bottom:8px;"></div>
        <table id="reportWatchTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Confluence Score</div>
        <div id="reportSetupSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:8px;"></div>
        <div id="reportSetupExplain" class="report-inline-note"></div>
        <div class="report-actions">
          <button id="reportSetupCompactBtn" class="report-toggle-btn active" type="button" aria-pressed="true">Compact View</button>
          <button id="reportSetupMoreBtn" class="report-toggle-btn" type="button" aria-pressed="false">More Metrics</button>
        </div>
        <div id="reportSetupQuickAdds" class="mini-actions"></div>
        <table id="reportSetupCompactTable"></table>
        <div id="reportSetupDetailWrap" class="hidden" style="margin-top:10px;">
          <div class="report-inline-note" style="margin-bottom:8px;">Advanced view adds raw volatility and YOLO aging metrics so you can audit why a name ranked where it did.</div>
          <table id="reportSetupQualityTable"></table>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Sector Heatmap</div>
        <div id="reportSectorHeatmap" class="heatmap-grid"></div>
        <table id="reportSectorHeatTable"></table>
      </div>

      <!-- YOLO delta -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">YOLO Changes vs Previous Run</div>
        <div id="reportYoloDeltaSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEW PATTERNS</div>
            <table id="reportYoloNewTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NO LONGER DETECTED</div>
            <table id="reportYoloLostTable"></table>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">YOLO Pattern Persistence</div>
        <div id="reportYoloPersistenceSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--blue); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">DAILY</div>
            <table id="reportYoloPersistenceDailyTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--blue); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">WEEKLY</div>
            <table id="reportYoloPersistenceWeeklyTable"></table>
          </div>
        </div>
      </div>

      <!-- Large moves + breadth -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Large Moves Today (vs Prior Close)</div>
        <div id="reportBreadthSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">TOP GAINERS</div>
            <table id="reportMoversUpTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">TOP LOSERS</div>
            <table id="reportMoversDownTable"></table>
          </div>
        </div>
      </div>

      <!-- 52W Extremes -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">52-Week Extremes (within 3% of high/low)</div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEAR 52W HIGH</div>
            <div id="report52wHigh" style="font-size:0.82rem; line-height:1.7;"></div>
          </div>
          <div style="flex:1; min-width:220px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEAR 52W LOW</div>
            <div id="report52wLow" style="font-size:0.82rem; line-height:1.7;"></div>
          </div>
        </div>
      </div>

      <!-- Top YOLO patterns at close -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Top AI Patterns at Close (YOLO)</div>
        <table id="reportYoloTopTable"></table>
      </div>

      <!-- Candle signals at close -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Candle Signals at Close</div>
        <table id="reportCandleTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label">Report History</div>
        <table id="reportHistoryTable"></table>
      </div>
      <div id="reportNoData" style="display:none; color:var(--muted); padding:20px 0;">
        No reports generated yet. Reports are written after the first daily cron run (22:00 UTC Mon–Fri).
      </div>
    </section>

    <section id="tabAdmin" class="panel hidden">
      <div class="admin-shell">
        <div class="admin-top">
          <div class="panel">
            <div class="admin-panel-head">
              <div>
                <div class="label">Private Admin</div>
                <div style="font-size:1rem; font-weight:700; margin-top:6px;">Control Center</div>
              </div>
              <div id="adminSessionStatus" class="admin-inline-status">Checking auth...</div>
            </div>
            <div class="admin-subtle">One place to manage `trader_koo` now, then plug in your other apps without rewriting the control surface.</div>

            <div id="adminLoginWrap" class="admin-login-grid">
              <div class="field">
                <label for="adminUsername">Username</label>
                <input id="adminUsername" type="text" value="admin" autocomplete="username" />
              </div>
              <div class="field">
                <label for="adminPassword">Password</label>
                <input id="adminPassword" type="password" autocomplete="current-password" />
              </div>
              <div class="field full">
                <button id="adminLoginBtn" type="button">Log In</button>
              </div>
            </div>

            <div id="adminActiveSessionWrap" class="hidden">
              <div id="adminWhoami" class="admin-subtle" style="margin-top:10px;"></div>
              <div class="admin-form-actions">
                <button id="adminRefreshBtn" type="button">Refresh Overview</button>
                <button id="adminLogoutBtn" type="button">Log Out</button>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="admin-panel-head">
              <div>
                <div class="label">Fleet Overview</div>
                <div id="adminOverviewStatus" class="admin-inline-status" style="margin-top:6px;">Waiting for admin login.</div>
              </div>
            </div>
            <div id="adminSummaryCards" class="cards"></div>
          </div>
        </div>

        <div class="admin-grid">
          <div class="panel">
            <div class="admin-panel-head">
              <div class="label">Managed Services</div>
              <div id="adminServiceTableHint" class="admin-inline-status">Select a row for details.</div>
            </div>
            <table id="adminServicesTable"></table>
          </div>

          <div class="panel">
            <div class="admin-panel-head">
              <div>
                <div class="label">Selected Service</div>
                <div id="adminSelectedServiceName" style="font-size:1rem; font-weight:700; margin-top:6px;">Choose a service</div>
              </div>
              <div id="adminSelectedServiceStatus" class="admin-inline-status"></div>
            </div>
            <div id="adminServiceMeta" class="admin-meta"></div>
            <div id="adminServiceLinks" class="admin-links"></div>
            <div id="adminServiceChecks" class="admin-checks"></div>
            <div id="adminServiceActions" class="mini-actions"></div>
            <div id="adminServiceEmpty" class="admin-empty">No service selected yet.</div>
            <div id="adminServiceDetailGrid" class="admin-detail-grid hidden">
              <div class="admin-detail-block">
                <div class="label">Health</div>
                <pre id="adminHealthJson" class="json-block"></pre>
              </div>
              <div class="admin-detail-block">
                <div class="label">Status</div>
                <pre id="adminStatusJson" class="json-block"></pre>
              </div>
              <div class="admin-detail-block">
                <div class="label">Pipeline</div>
                <pre id="adminPipelineJson" class="json-block"></pre>
              </div>
              <div class="admin-detail-block">
                <div class="label">Cost</div>
                <pre id="adminCostJson" class="json-block"></pre>
              </div>
              <div class="admin-detail-block">
                <div class="label">Report</div>
                <pre id="adminReportJson" class="json-block"></pre>
              </div>
              <div class="admin-detail-block">
                <div class="label">Logs</div>
                <pre id="adminLogsJson" class="json-block"></pre>
              </div>
            </div>
          </div>
        </div>

        <div class="admin-grid admin-lower">
          <div class="panel">
            <div class="admin-panel-head">
              <div>
                <div class="label">Service Registry</div>
                <div class="admin-inline-status" style="margin-top:6px;">Use `__self__` as the base URL for this app. Secrets stay server-side via env var names.</div>
              </div>
            </div>
            <div class="admin-form-grid">
              <div class="field">
                <label for="ccServiceId">Service ID</label>
                <input id="ccServiceId" type="text" placeholder="billing-api" />
              </div>
              <div class="field">
                <label for="ccName">Name</label>
                <input id="ccName" type="text" placeholder="Billing API" />
              </div>
              <div class="field">
                <label for="ccServiceType">Service Type</label>
                <input id="ccServiceType" type="text" value="generic" />
              </div>
              <div class="field">
                <label for="ccBaseUrl">Base URL</label>
                <input id="ccBaseUrl" type="text" placeholder="https://app.example.com or __self__" />
              </div>
              <div class="field">
                <label for="ccAppUrl">App URL</label>
                <input id="ccAppUrl" type="text" placeholder="https://app.example.com" />
              </div>
              <div class="field">
                <label for="ccRepoUrl">Repo URL</label>
                <input id="ccRepoUrl" type="text" placeholder="https://github.com/org/repo" />
              </div>
              <div class="field">
                <label for="ccHealthPath">Health Path</label>
                <input id="ccHealthPath" type="text" value="/api/health" />
              </div>
              <div class="field">
                <label for="ccStatusPath">Status Path</label>
                <input id="ccStatusPath" type="text" value="/api/status" />
              </div>
              <div class="field">
                <label for="ccCostPath">Cost Path</label>
                <input id="ccCostPath" type="text" placeholder="/api/admin/cost" />
              </div>
              <div class="field">
                <label for="ccPipelinePath">Pipeline Path</label>
                <input id="ccPipelinePath" type="text" placeholder="/api/admin/pipeline-status" />
              </div>
              <div class="field">
                <label for="ccReportPath">Report Path</label>
                <input id="ccReportPath" type="text" placeholder="/api/admin/report" />
              </div>
              <div class="field">
                <label for="ccLogsPath">Logs Path</label>
                <input id="ccLogsPath" type="text" placeholder="/api/admin/logs" />
              </div>
              <div class="field">
                <label for="ccAuthType">Auth Type</label>
                <select id="ccAuthType">
                  <option value="none">none</option>
                  <option value="x_api_key" selected>x_api_key</option>
                  <option value="bearer">bearer</option>
                </select>
              </div>
              <div class="field">
                <label for="ccAuthHeader">Auth Header</label>
                <input id="ccAuthHeader" type="text" value="X-API-Key" />
              </div>
              <div class="field">
                <label for="ccSecretEnvVar">Secret Env Var</label>
                <input id="ccSecretEnvVar" type="text" placeholder="BILLING_ADMIN_KEY" />
              </div>
              <div class="field">
                <label for="ccTags">Tags</label>
                <input id="ccTags" type="text" placeholder="internal, critical" />
              </div>
              <div class="field">
                <label for="ccSortOrder">Sort Order</label>
                <input id="ccSortOrder" type="number" step="1" value="100" />
              </div>
              <div class="field">
                <label for="ccTimeoutSec">Timeout Sec</label>
                <input id="ccTimeoutSec" type="number" step="1" value="10" />
              </div>
              <div class="field full" style="display:flex; flex-direction:row; align-items:center; gap:8px; padding-top:22px;">
                <input id="ccEnabled" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
                <label for="ccEnabled" style="margin:0; color:var(--text); font-size:0.84rem;">Enabled</label>
              </div>
              <div class="field full">
                <label for="ccActionsJson">Actions JSON</label>
                <textarea id="ccActionsJson" placeholder='[{"id":"refresh","label":"Refresh","method":"POST","path":"/api/admin/refresh"}]'></textarea>
              </div>
              <div class="field full">
                <label for="ccNotes">Notes</label>
                <textarea id="ccNotes" placeholder="Purpose, gotchas, cost notes, runbook reminders."></textarea>
              </div>
            </div>
            <div class="admin-form-actions">
              <button id="ccSaveBtn" type="button">Save Service</button>
              <button id="ccResetBtn" type="button">New Blank</button>
              <span id="ccFormStatus" class="admin-inline-status"></span>
            </div>
          </div>

          <div class="panel">
            <div class="admin-panel-head">
              <div>
                <div class="label">Audit Log</div>
                <div class="admin-inline-status" style="margin-top:6px;">Each admin action is recorded here.</div>
              </div>
            </div>
            <table id="adminAuditTable"></table>
          </div>
        </div>
      </div>
    </section>

    <section id="tabGuide" class="panel">
      <div class="guide">
        <div class="guide-callout">
          <div class="guide-callout-title">Not Financial Advice</div>
          <p style="margin:0;">This dashboard is for research only. Signals can be wrong, delayed, or incomplete. You are responsible for risk management and execution decisions.</p>
        </div>

        <h3>Quick Start (2 Minutes)</h3>
        <ol class="guide-list">
          <li>Start here. Read the risk note above so the dashboard is used as research support, not as a trading instruction.</li>
          <li>Open <b>Daily Report</b> after the nightly run completes.</li>
          <li>Review <b>Tonight's 5 Key Changes</b> first for the fast market summary.</li>
          <li>Check <b>YOLO Changes</b> for new patterns and patterns no longer detected.</li>
          <li>Use <b>Confluence Score</b> and <b>Sector Heatmap</b> to prioritize candidates.</li>
          <li>Click any ticker to jump into <b>Chart + Levels</b> and inspect structure.</li>
          <li>Use <b>Bollinger Bands</b> toggle when you want volatility context.</li>
          <li>Add names to <b>Watchlist</b> so you can revisit the same basket quickly.</li>
        </ol>

        <h3>What Each Tab Does</h3>
        <div class="guide-grid">
          <div class="guide-card">
            <div class="guide-k">Guide</div>
            <div class="guide-v">How to use the app, read signals, and avoid common mistakes.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Daily Report</div>
            <div class="guide-v">Nightly summary of what changed, strongest setups, market regime, and YOLO deltas.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Chart + Levels</div>
            <div class="guide-v">Per-ticker chart with support/resistance, gaps, trendlines, rule/hybrid overlays, candlestick signals, optional Bollinger Bands, and YOLO boxes.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Opportunities (PEG)</div>
            <div class="guide-v">Valuation screener for S&amp;P 500. Use it after report/chart review, not before.</div>
          </div>
        </div>

        <h3>Daily Report Read Order</h3>
        <ol class="guide-list">
          <li><b>Tonight's 5 Key Changes</b>: one-screen summary of what materially changed.</li>
          <li><b>Confluence Score</b>: start in compact view, then open <b>More Metrics</b> only when you need to audit volatility and aging inputs.</li>
          <li><b>Sector Heatmap</b>: identify leadership/laggards and rotation.</li>
          <li><b>YOLO Changes vs Previous Run</b>: actionable delta, not raw count noise.</li>
          <li><b>Large Moves + 52-week Extremes</b>: momentum continuation or exhaustion candidates.</li>
        </ol>

        <h3>Chart + Levels Workflow</h3>
        <ol class="guide-list">
          <li>Load ticker from report or search box.</li>
          <li>Mark location versus <b>primary/secondary support/resistance</b>.</li>
          <li>Check <b>open gaps</b> and <b>trendlines</b> for context.</li>
          <li>Enable <b>Rule/Hybrid Lines</b> and <b>YOLO Patterns</b> to compare machine + rule signals.</li>
          <li>Turn on <b>Bollinger Bands</b> if you want to gauge stretch/squeeze conditions.</li>
          <li>Decide only when multiple signals agree (structure + momentum + valuation).</li>
        </ol>

        <h3>Chart Toggles (How to Use)</h3>
        <ul class="guide-list">
          <li><b>Show Trendlines</b>: reveal support/resistance line geometry from recent pivots.</li>
          <li><b>Show Patterns</b>: display top pattern overlays detected by rule/hybrid logic.</li>
          <li><b>Rule/Hybrid Lines</b>: keep this on for primary pattern structure.</li>
          <li><b>Bollinger Bands</b>: optional volatility envelope (20, 2) around price.</li>
          <li><b>YOLO Patterns</b>: AI-detected pattern windows (daily + weekly labels).</li>
          <li><b>Bars D/W</b>: switch between daily and weekly candles for timeframe alignment.</li>
        </ul>

        <h3>Signal Glossary (Short)</h3>
        <details open>
          <summary>YOLO Patterns</summary>
          <ul class="guide-list">
            <li>Computer-vision detections on candlestick images (daily/weekly timeframe).</li>
            <li><b>x0_date/x1_date</b> define the detected pattern window.</li>
            <li><b>age_days</b> shows how old the pattern end-date is relative to run date.</li>
            <li>Use <b>YOLO Changes</b> to identify truly new or invalidated patterns.</li>
          </ul>
        </details>
        <details>
          <summary>Valuation Fields</summary>
          <ul class="guide-list">
            <li><b>Discount %</b>: upside/downside versus analyst target.</li>
            <li><b>PEG</b>: P/E adjusted for growth; lower can indicate better value for growth.</li>
            <li><b>Deep Value</b> preset is stricter than Undervalued.</li>
          </ul>
        </details>
        <details>
          <summary>Technical Structure</summary>
          <ul class="guide-list">
            <li><b>Support</b>: area where buyers previously stepped in.</li>
            <li><b>Resistance</b>: area where sellers previously stepped in.</li>
            <li><b>Gaps</b>: unfilled zones often retested later.</li>
          </ul>
        </details>

        <h3>Run Schedule</h3>
        <ul class="guide-list">
          <li>Daily pipeline: weekdays at <b>22:00 UTC</b> (ingest → YOLO → report).</li>
          <li>Weekly YOLO pass: Saturday (regenerates report after run).</li>
          <li>Report tab always shows the latest completed run; no manual refresh button is required.</li>
        </ul>

        <h3>Common Mistakes</h3>
        <ul class="guide-list">
          <li>Trading one signal in isolation.</li>
          <li>Ignoring timeframe mismatch (weekly pattern vs short-term trade horizon).</li>
          <li>Treating old patterns as fresh without checking <b>age_days</b>.</li>
          <li>Ignoring liquidity/volume when evaluating breakouts.</li>
        </ul>

        <div style="margin-top:14px; padding:10px 14px; border-top:1px solid var(--line); color:var(--muted); font-size:0.82rem;">
          trader_koo uses public market data and may contain delays or gaps. Past performance is not indicative of future results.
        </div>
      </div>
    </section>
  </div>
  <footer class="site-footnote">
    <strong>Not Financial Advice.</strong> trader_koo is a research dashboard only. Market data and model outputs may be delayed, incomplete, or incorrect. Any investment decision and risk taken is solely your responsibility.
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const tabAdminBtn = $("tabAdminBtn");
    const tabOpBtn = $("tabOpBtn");
    const tabChartBtn = $("tabChartBtn");
    const tabGuideBtn = $("tabGuideBtn");
    const tabReportBtn = $("tabReportBtn");
    const tabAdmin = $("tabAdmin");
    const tabOp = $("tabOp");
    const tabChart = $("tabChart");
    const tabGuide = $("tabGuide");
    const tabReport = $("tabReport");
    const API_BASE_STORAGE_KEY = "trader_koo_api_base";
    const ADMIN_KEY_STORAGE_KEY = "trader_koo_admin_api_key";
    const WATCHLIST_STORAGE_KEY = "trader_koo_watchlist";
    const TABLE_STATE = {};
    const DEFAULT_MONTHS = 3;
    let LAST_CHART_PAYLOAD = null;
    let LAST_REPORT_SETUP_ROWS = [];
    let REPORT_SETUP_SHOW_MORE = false;
    let CHART_TIMEFRAME = "daily"; // "daily" | "weekly"
    let ADMIN_SESSION = null;
    let CONTROL_CENTER_OVERVIEW = null;
    let SELECTED_CONTROL_SERVICE_ID = "";
    let _apiKey = "";

    function fmt(v, d = 2) {
      if (v === null || v === undefined || v === "" || Number.isNaN(Number(v))) return "-";
      return Number(v).toFixed(d);
    }

    function escHtml(v) {
      return String(v ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function prettyJson(value) {
      if (value === null || value === undefined || value === "") return "No data";
      if (typeof value === "string") return value;
      try {
        return JSON.stringify(value, null, 2);
      } catch {
        return String(value);
      }
    }

    const PERCENT_COLUMNS = new Set([
      "discount_pct",
      "eps_growth_5y",
      "atr_pct",
      "atr_pct_14",
      "realized_vol_20",
      "bb_width_20",
      "pct_change",
      "pct_advancing",
      "pct_from_high",
      "pct_from_low",
    ]);
    const DECIMAL_BY_COLUMN = {
      price: 2,
      pe: 2,
      peg: 2,
      target_price: 2,
      discount_pct: 2,
      eps_growth_5y: 2,
      level: 2,
      zone_low: 2,
      zone_high: 2,
      gap_low: 2,
      gap_high: 2,
      score: 2,
      touches: 0,
      touch_count: 0,
      contracts: 0,
      call_oi: 0,
      put_oi: 0,
    };

    function fmtPctText(raw, digits = 2) {
      const n = Number(raw);
      if (!Number.isFinite(n)) return "-";
      return `${n.toFixed(digits)}%`;
    }

    function buildSetupReason(row) {
      const reasons = [];
      const discount = Number(row.discount_pct);
      const peg = Number(row.peg);
      const move = Number(row.pct_change);
      const yoloConf = Number(row.yolo_confidence);
      const yoloPattern = String(row.yolo_pattern || "").trim();
      const age = Number(row.yolo_age_days);
      const rv20 = Number(row.realized_vol_20);

      if (Number.isFinite(discount)) {
        if (discount >= 25) reasons.push("deep discount");
        else if (discount >= 15) reasons.push("discounted");
      }
      if (Number.isFinite(peg)) {
        if (peg <= 0.8) reasons.push("low PEG");
        else if (peg <= 1.2) reasons.push("reasonable PEG");
      }
      if (Number.isFinite(move)) {
        if (move >= 3) reasons.push("strong up day");
        else if (move <= -3) reasons.push("washout move");
        else if (Math.abs(move) >= 1.5) reasons.push("meaningful move");
      }
      if (yoloPattern) {
        const label = yoloConf >= 0.75 ? "strong YOLO" : "YOLO signal";
        reasons.push(`${label}: ${yoloPattern}`);
      }
      if (Number.isFinite(age) && age <= 10) reasons.push("fresh pattern");
      if (Number.isFinite(rv20)) {
        if (rv20 <= 30) reasons.push("contained vol");
        else if (rv20 >= 55) reasons.push("high vol");
      }
      return reasons.slice(0, 3).join(" • ") || "balanced multi-factor setup";
    }

    function buildCompactSetupRows(rows) {
      return (rows || []).map((row) => ({
        ticker: row.ticker,
        score: row.score,
        setup_tier: row.setup_tier,
        why_high: buildSetupReason(row),
        pct_change: row.pct_change,
        value_case: `${fmtPctText(row.discount_pct)} / PEG ${fmt(row.peg)}`,
        yolo: row.yolo_pattern
          ? `${row.yolo_pattern} (${fmt(row.yolo_confidence)})`
          : "-",
      }));
    }

    function setReportSetupMode(showMore) {
      REPORT_SETUP_SHOW_MORE = !!showMore;
      const compactBtn = $("reportSetupCompactBtn");
      const moreBtn = $("reportSetupMoreBtn");
      const detailWrap = $("reportSetupDetailWrap");
      if (compactBtn) {
        compactBtn.classList.toggle("active", !REPORT_SETUP_SHOW_MORE);
        compactBtn.setAttribute("aria-pressed", String(!REPORT_SETUP_SHOW_MORE));
      }
      if (moreBtn) {
        moreBtn.classList.toggle("active", REPORT_SETUP_SHOW_MORE);
        moreBtn.setAttribute("aria-pressed", String(REPORT_SETUP_SHOW_MORE));
      }
      if (detailWrap) {
        detailWrap.classList.toggle("hidden", !REPORT_SETUP_SHOW_MORE);
      }
    }

    function formatTableValue(col, raw) {
      if (raw === null || raw === undefined || raw === "") return "-";
      if (typeof raw === "string" && /^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
      const n = Number(raw);
      if (!Number.isFinite(n)) return String(raw);

      if (PERCENT_COLUMNS.has(col)) {
        let v = n;
        if (col === "eps_growth_5y" && Math.abs(v) <= 2) v *= 100;
        return `${v.toFixed(DECIMAL_BY_COLUMN[col] ?? 2)}%`;
      }

      const d = DECIMAL_BY_COLUMN[col] ?? 2;
      return n.toLocaleString(undefined, {
        minimumFractionDigits: d,
        maximumFractionDigits: d,
      });
    }

    function renderOpFilterHelp(help) {
      const el = $("opFilterHelp");
      if (!el) return;
      if (!help) {
        el.innerHTML = `<div class="op-help-title">Filter Guide</div><div class="status-plain">Use presets, then refine using the fields.</div>`;
        return;
      }
      const rows = [
        ["View", help.view],
        ["Min Discount %", help.min_discount],
        ["Max PEG", help.max_peg],
        ["Overvalued Threshold %", help.overvalued_threshold],
      ];
      el.innerHTML = `
        <div class="op-help-title">Filter Guide</div>
        <div class="op-help-grid">
          ${rows.map(([k, v]) => `<div class="op-help-key">${escHtml(k)}</div><div class="op-help-val">${escHtml(v)}</div>`).join("")}
        </div>
      `;
    }

    function renderOpStatus(payload, view, rowCount) {
      const el = $("opStatus");
      if (!el) return;
      const snapRaw = payload.snapshot_ts || "";
      const snapDate = snapRaw ? new Date(snapRaw) : null;
      const hasSnap = snapDate && !Number.isNaN(snapDate.getTime());
      const snapUtc = hasSnap
        ? snapDate.toISOString().slice(0, 16).replace("T", " ") + " UTC"
        : (snapRaw || "-");
      const snapLocal = hasSnap
        ? snapDate.toLocaleString(undefined, {
            year: "numeric",
            month: "short",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
            timeZoneName: "short",
          })
        : "-";
      const sc = payload.source_counts || {};
      const chips = [
        ["Snapshot (UTC)", snapUtc],
        ["Local Time", snapLocal],
        ["View", view],
        ["Shown", rowCount ?? 0],
        ["Eligible", payload.eligible_count ?? "-"],
        ["Universe", payload.universe_count ?? "-"],
        ["Analyst", sc.analyst_target ?? 0],
        ["Model", sc.model_eps_pe ?? 0],
        ["Other", sc.other ?? 0],
      ];
      el.innerHTML = chips
        .map(([k, v]) => `<span class="status-chip"><span class="k">${escHtml(k)}</span><span class="v">${escHtml(v)}</span></span>`)
        .join("");
    }

    function normalizeBase(base) {
      return String(base || "").trim().replace(/\/+$/, "");
    }

    function getApiBase() {
      return normalizeBase($("apiBase").value);
    }

    function apiFetch(url, opts = {}) {
      const headers = { ...(opts.headers || {}) };
      if (_apiKey) headers["X-API-Key"] = _apiKey;
      const credentials = opts.credentials || "include";
      return fetch(url, { ...opts, headers, credentials });
    }

    function setAdminApiKey(key) {
      _apiKey = String(key || "").trim();
      if (_apiKey) sessionStorage.setItem(ADMIN_KEY_STORAGE_KEY, _apiKey);
      else sessionStorage.removeItem(ADMIN_KEY_STORAGE_KEY);
    }

    async function adminFetch(url, opts = {}) {
      const resp = await apiFetch(url, { ...opts, credentials: "include" });
      if (resp.status === 401) {
        ADMIN_SESSION = { authenticated: false };
        renderAdminSession();
      }
      return resp;
    }

    async function initApiKey() {
      const params = new URLSearchParams(window.location.search);
      if (params.has("admin_key")) {
        // Never load admin keys from URL; strip if user pasted one.
        params.delete("admin_key");
        const qs = params.toString();
        const next = qs ? `${window.location.pathname}?${qs}${window.location.hash}` : `${window.location.pathname}${window.location.hash}`;
        window.history.replaceState({}, document.title, next);
      }
      setAdminApiKey(sessionStorage.getItem(ADMIN_KEY_STORAGE_KEY) || "");
    }

    function setApiBase(base, persist = true) {
      const clean = normalizeBase(base);
      $("apiBase").value = clean;
      if (persist && clean) localStorage.setItem(API_BASE_STORAGE_KEY, clean);
    }

    function buildApiCandidates() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = normalizeBase(params.get("api"));
      const fromStorage = normalizeBase(localStorage.getItem(API_BASE_STORAGE_KEY));
      const fromInput = normalizeBase($("apiBase").value);
      const isHttp = window.location.protocol === "http:" || window.location.protocol === "https:";
      const sameOrigin = isHttp ? normalizeBase(window.location.origin) : "";
      const host = window.location.hostname || "127.0.0.1";
      const host8000 = `http://${host}:8000`;
      const defaults = ["http://127.0.0.1:8000", "http://localhost:8000"];
      const candidates = [fromInput, fromQuery, fromStorage, sameOrigin, host8000, ...defaults].filter(Boolean);
      return [...new Set(candidates)];
    }

    async function probeApi(base, timeoutMs = 1200) {
      try {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        const resp = await fetch(`${base}/api/health`, { signal: controller.signal });
        clearTimeout(timer);
        return resp.ok;
      } catch {
        return false;
      }
    }

    async function initApiBase() {
      const candidates = buildApiCandidates();
      for (const c of candidates) {
        if (await probeApi(c)) {
          setApiBase(c, true);
          return;
        }
      }
      setApiBase(candidates[0] || "http://127.0.0.1:8000", true);
    }

    function setGlobalStatus(s) { $("globalStatus").textContent = s; }
    function setServiceStatus(s, bad = false) {
      const el = $("serviceStatus");
      el.textContent = s;
      el.style.color = bad ? "#ff8a8a" : "#8ea0bd";
    }

    async function refreshServiceStatus() {
      if (document.visibilityState === "hidden") return;
      const base = getApiBase();
      if (!base) {
        setServiceStatus("Service status: missing API base", true);
        return;
      }
      try {
        const resp = await apiFetch(`${base}/api/status`);
        if (!resp.ok) throw new Error(`${resp.status}`);
        const payload = await resp.json();
        const run = payload.latest_run || {};
        const pipe = payload.pipeline || {};
        const processed = run.tickers_processed ?? null;
        const total = run.tickers_total ?? null;
        const progress = (processed !== null && total !== null) ? `${processed}/${total}` : null;
        const txt = [
          `Connected`,
          `run=${run.status || "n/a"}`,
          `stage=${pipe.stage || payload.pipeline_stage || "n/a"}`,
          progress ? `progress=${progress}` : null,
          `tickers=${payload.counts?.tracked_tickers ?? "-"}`,
          `price_age=${payload.freshness?.price_age_days ?? "-"}d`
        ].filter(Boolean).join(" • ");
        setServiceStatus(txt, false);
      } catch (err) {
        setServiceStatus(`Offline (${err.message})`, true);
      }
    }

    async function triggerUpdate() {
      const base = getApiBase();
      if (!base) { alert("API base not resolved yet."); return; }
      const btn = $("triggerUpdateBtn");
      btn.disabled = true;
      btn.textContent = "Triggering...";
      try {
        const resp = await adminFetch(`${base}/api/admin/trigger-update`, { method: "POST" });
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        btn.textContent = "Triggered ✓";
        setTimeout(() => { btn.textContent = "Run Update"; btn.disabled = false; }, 5000);
      } catch (err) {
        alert(`Failed: ${err.message}`);
        btn.textContent = "Run Update";
        btn.disabled = false;
      }
    }

    function activateTab(which) {
      const all = {
        admin: [tabAdminBtn, tabAdmin],
        op: [tabOpBtn, tabOp],
        chart: [tabChartBtn, tabChart],
        guide: [tabGuideBtn, tabGuide],
        report: [tabReportBtn, tabReport],
      };
      for (const [k, [btn, sec]] of Object.entries(all)) {
        if (k === which) { btn.classList.add("active"); sec.classList.remove("hidden"); }
        else             { btn.classList.remove("active"); sec.classList.add("hidden"); }
      }
      if (which === "report") loadReport();
      if (which === "admin") {
        refreshAdminSession(true).then(() => loadControlCenterOverview());
      }
    }

    tabAdminBtn.addEventListener("click", () => activateTab("admin"));
    tabOpBtn.addEventListener("click", () => activateTab("op"));
    tabChartBtn.addEventListener("click", () => activateTab("chart"));
    tabGuideBtn.addEventListener("click", () => activateTab("guide"));
    tabReportBtn.addEventListener("click", () => activateTab("report"));

    function fillCards(payload) {
      const f = payload.fundamentals || {};
      const o = payload.options_summary || {};
      $("c-price").textContent = fmt(f.price);
      $("c-pe").textContent = fmt(f.pe);
      $("c-peg").textContent = fmt(f.peg);
      $("c-target").textContent = fmt(f.target_price);
      $("c-discount").textContent = fmt(f.discount_pct);
      $("c-pcr").textContent = fmt(o.put_call_oi_ratio, 3);
    }

    function renderSimpleTable(elId, columns, rows, clickable = false, onClick = null, opts = {}) {
      const state = TABLE_STATE[elId] || { sortCol: null, sortAsc: false };
      TABLE_STATE[elId] = state;
      const el = $(elId);
      const colDefs = columns.map((col) => (
        typeof col === "string"
          ? { key: col, label: col }
          : { key: col.key, label: col.label || col.key }
      ));
      let viewRows = [...rows];
      const searchId = opts.searchInputId || "";
      if (searchId && $(searchId)) {
        const q = String($(searchId).value || "").trim().toLowerCase();
        if (q) {
          viewRows = viewRows.filter((r) =>
            colDefs.some(({ key }) => String(r[key] ?? "").toLowerCase().includes(q))
          );
        }
      }

      if (opts.sortable && state.sortCol) {
        const col = state.sortCol;
        const dir = state.sortAsc ? 1 : -1;
        viewRows.sort((a, b) => {
          const av = a[col], bv = b[col];
          const an = Number(av), bn = Number(bv);
          if (Number.isFinite(an) && Number.isFinite(bn)) return (an - bn) * dir;
          return String(av ?? "").localeCompare(String(bv ?? "")) * dir;
        });
      }

      const head = `<tr>${colDefs.map(({ key, label }) => {
        if (!opts.sortable) return `<th>${label}</th>`;
        const marker = state.sortCol === key ? (state.sortAsc ? " ▲" : " ▼") : "";
        return `<th data-sort-col="${key}" style="cursor:pointer;">${label}${marker}</th>`;
      }).join("")}</tr>`;

      const body = viewRows.length
        ? viewRows.map((r, idx) => {
            const cls = clickable ? "clickable" : "";
            return `<tr class="${cls}" data-idx="${idx}">${colDefs.map(({ key }) => `<td>${formatTableValue(key, r[key])}</td>`).join("")}</tr>`;
          }).join("")
        : `<tr><td colspan="${colDefs.length}">No data</td></tr>`;
      el.innerHTML = head + body;

      if (opts.sortable) {
        el.querySelectorAll("th[data-sort-col]").forEach((th) => {
          th.addEventListener("click", () => {
            const c = th.getAttribute("data-sort-col");
            if (!c) return;
            if (state.sortCol === c) state.sortAsc = !state.sortAsc;
            else {
              state.sortCol = c;
              state.sortAsc = true;
            }
            renderSimpleTable(elId, columns, rows, clickable, onClick, opts);
          });
        });
      }

      if (searchId && $(searchId)) {
        $(searchId).oninput = () => renderSimpleTable(elId, columns, rows, clickable, onClick, opts);
      }

      if (clickable && onClick) {
        el.querySelectorAll("tr.clickable").forEach((tr) => {
          tr.addEventListener("click", () => {
            const idx = Number(tr.getAttribute("data-idx"));
            onClick(viewRows[idx]);
          });
        });
      }
    }

    function resetControlCenterForm() {
      $("ccServiceId").value = "";
      $("ccName").value = "";
      $("ccServiceType").value = "generic";
      $("ccBaseUrl").value = "";
      $("ccAppUrl").value = "";
      $("ccRepoUrl").value = "";
      $("ccHealthPath").value = "/api/health";
      $("ccStatusPath").value = "/api/status";
      $("ccCostPath").value = "";
      $("ccPipelinePath").value = "";
      $("ccReportPath").value = "";
      $("ccLogsPath").value = "";
      $("ccAuthType").value = "x_api_key";
      $("ccAuthHeader").value = "X-API-Key";
      $("ccSecretEnvVar").value = "";
      $("ccTags").value = "";
      $("ccSortOrder").value = "100";
      $("ccTimeoutSec").value = "10";
      $("ccEnabled").checked = true;
      $("ccActionsJson").value = "";
      $("ccNotes").value = "";
      $("ccFormStatus").textContent = "";
    }

    function populateControlCenterForm(service) {
      if (!service) return;
      $("ccServiceId").value = service.service_id || "";
      $("ccName").value = service.name || "";
      $("ccServiceType").value = service.service_type || "generic";
      $("ccBaseUrl").value = service.base_url || "";
      $("ccAppUrl").value = service.app_url || "";
      $("ccRepoUrl").value = service.repo_url || "";
      $("ccHealthPath").value = service.health_path || "";
      $("ccStatusPath").value = service.status_path || "";
      $("ccCostPath").value = service.cost_path || "";
      $("ccPipelinePath").value = service.pipeline_path || "";
      $("ccReportPath").value = service.report_path || "";
      $("ccLogsPath").value = service.logs_path || "";
      $("ccAuthType").value = service.auth_type || "none";
      $("ccAuthHeader").value = service.auth_header || "X-API-Key";
      $("ccSecretEnvVar").value = service.secret_env_var || "";
      $("ccTags").value = Array.isArray(service.tags) ? service.tags.join(", ") : "";
      $("ccSortOrder").value = String(service.sort_order ?? 100);
      $("ccTimeoutSec").value = String(service.timeout_sec ?? 10);
      $("ccEnabled").checked = Boolean(service.enabled);
      $("ccActionsJson").value = Array.isArray(service.actions) && service.actions.length
        ? prettyJson(service.actions)
        : "";
      $("ccNotes").value = service.notes || "";
    }

    function blankControlCenterPanels(reason = "Log in to load services.") {
      $("adminOverviewStatus").textContent = reason;
      $("adminSummaryCards").innerHTML = [
        ["Services", "—"],
        ["Healthy", "—"],
        ["Needs Attention", "—"],
        ["Cost Reporting", "—"],
      ].map(([label, value]) => `<div class="card"><div class="label">${label}</div><div class="value">${value}</div></div>`).join("");
      renderSimpleTable("adminServicesTable", ["name", "health", "stage", "checked_ts"], []);
      renderSimpleTable("adminAuditTable", ["action_ts", "event_type", "service_id", "status"], []);
      $("adminSelectedServiceName").textContent = "Choose a service";
      $("adminSelectedServiceStatus").textContent = "";
      $("adminServiceMeta").innerHTML = "";
      $("adminServiceLinks").innerHTML = "";
      $("adminServiceChecks").innerHTML = "";
      $("adminServiceActions").innerHTML = "";
      $("adminServiceEmpty").textContent = reason;
      $("adminServiceEmpty").classList.remove("hidden");
      $("adminServiceDetailGrid").classList.add("hidden");
      $("adminHealthJson").textContent = "";
      $("adminStatusJson").textContent = "";
      $("adminPipelineJson").textContent = "";
      $("adminCostJson").textContent = "";
      $("adminReportJson").textContent = "";
      $("adminLogsJson").textContent = "";
    }

    function renderAdminSession() {
      const session = ADMIN_SESSION || {};
      const authenticated = Boolean(session.authenticated);
      const loginEnabled = session.login_enabled !== false;
      $("adminLoginWrap").classList.toggle("hidden", authenticated || !loginEnabled);
      $("adminActiveSessionWrap").classList.toggle("hidden", !authenticated);
      $("adminLoginBtn").disabled = !loginEnabled;
      if (!loginEnabled) {
        $("adminSessionStatus").textContent = "Login disabled on server";
      } else if (authenticated) {
        $("adminSessionStatus").textContent = `Authenticated (${session.identity?.mode || "session"})`;
      } else {
        $("adminSessionStatus").textContent = "Not logged in";
      }
      $("adminWhoami").textContent = authenticated
        ? `Signed in as ${session.identity?.username || "admin"}${session.identity?.expires_ts ? ` • expires ${session.identity.expires_ts.replace("T", " ").slice(0, 16)} UTC` : ""}`
        : "";
    }

    async function refreshAdminSession(silent = false) {
      const base = getApiBase();
      if (!base) return null;
      try {
        const resp = await apiFetch(`${base}/api/admin/session`, { credentials: "include" });
        if (!resp.ok) throw new Error(`${resp.status}`);
        ADMIN_SESSION = await resp.json();
      } catch (err) {
        ADMIN_SESSION = {
          ok: false,
          authenticated: false,
          login_enabled: true,
          error: err.message,
        };
        if (!silent) $("adminSessionStatus").textContent = `Auth unavailable (${err.message})`;
      }
      renderAdminSession();
      return ADMIN_SESSION;
    }

    async function loginAdmin() {
      const base = getApiBase();
      if (!base) return;
      const username = String($("adminUsername").value || "").trim();
      const password = String($("adminPassword").value || "");
      if (!username || !password) {
        $("adminSessionStatus").textContent = "Username and password are required";
        return;
      }
      $("adminLoginBtn").disabled = true;
      $("adminSessionStatus").textContent = "Logging in...";
      try {
        const resp = await apiFetch(`${base}/api/admin/session/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
          credentials: "include",
        });
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        $("adminPassword").value = "";
        await refreshAdminSession(true);
        await loadControlCenterOverview();
      } catch (err) {
        $("adminSessionStatus").textContent = `Login failed (${err.message})`;
      } finally {
        $("adminLoginBtn").disabled = false;
      }
    }

    async function logoutAdmin() {
      const base = getApiBase();
      if (!base) return;
      try {
        await apiFetch(`${base}/api/admin/session/logout`, {
          method: "POST",
          credentials: "include",
        });
      } catch {}
      ADMIN_SESSION = { authenticated: false, login_enabled: true };
      CONTROL_CENTER_OVERVIEW = null;
      SELECTED_CONTROL_SERVICE_ID = "";
      renderAdminSession();
      blankControlCenterPanels("Log in to load services.");
    }

    async function ensureAdminAuthenticated() {
      const session = ADMIN_SESSION && typeof ADMIN_SESSION.authenticated === "boolean"
        ? ADMIN_SESSION
        : await refreshAdminSession(true);
      renderAdminSession();
      return Boolean(session && session.authenticated);
    }

    function renderControlCenterAudit(rows) {
      renderSimpleTable(
        "adminAuditTable",
        [
          { key: "action_ts", label: "When (UTC)" },
          { key: "event_type", label: "Event" },
          { key: "service_id", label: "Service" },
          { key: "action_id", label: "Action" },
          { key: "status", label: "Status" },
          { key: "message", label: "Message" },
        ],
        rows || [],
        false,
        null,
        { sortable: true },
      );
    }

    function renderControlCenterOverview(data) {
      CONTROL_CENTER_OVERVIEW = data || null;
      const counts = data?.counts || {};
      const makeCard = (label, val) =>
        `<div class="card"><div class="label">${label}</div><div class="value">${escHtml(val ?? "—")}</div></div>`;
      $("adminSummaryCards").innerHTML = [
        makeCard("Services", counts.total_services ?? "0"),
        makeCard("Healthy", counts.healthy_services ?? "0"),
        makeCard("Needs Attention", counts.unhealthy_services ?? "0"),
        makeCard("Cost Reporting", counts.cost_reporting_services ?? "0"),
      ].join("");
      $("adminOverviewStatus").textContent = data?.generated_ts
        ? `Overview refreshed ${String(data.generated_ts).replace("T", " ").slice(0, 16)} UTC`
        : "No overview data";

      const serviceRows = (data?.services || []).map((row) => {
        const service = row.service || {};
        const summary = row.summary || {};
        const rawCost = summary.cost_value;
        const cost = Number.isFinite(Number(rawCost)) ? Number(rawCost).toFixed(2) : (rawCost ?? "-");
        const health = summary.health_ok === true ? "ok" : (summary.health_ok === false ? "issue" : "-");
        const stage = summary.pipeline_stage || summary.latest_run_status || summary.status || "-";
        return {
          service_id: service.service_id,
          name: service.name || service.service_id,
          service_type: service.service_type || "generic",
          enabled: service.enabled ? "yes" : "no",
          health,
          stage,
          cost,
          checked_ts: summary.checked_ts ? String(summary.checked_ts).replace("T", " ").slice(0, 16) : "-",
        };
      });
      $("adminServiceTableHint").textContent = serviceRows.length
        ? `${serviceRows.length} service(s) registered`
        : "No managed services yet.";
      renderSimpleTable(
        "adminServicesTable",
        [
          { key: "name", label: "Service" },
          { key: "service_type", label: "Type" },
          { key: "enabled", label: "Enabled" },
          { key: "health", label: "Health" },
          { key: "stage", label: "Stage" },
          { key: "cost", label: "Cost" },
          { key: "checked_ts", label: "Checked (UTC)" },
        ],
        serviceRows,
        true,
        (row) => loadControlCenterServiceSnapshot(row.service_id),
        { sortable: true },
      );
      renderControlCenterAudit(data?.recent_audit || []);
    }

    function serviceSummaryChip(label, summary) {
      if (!summary) return "";
      const value = summary.value ?? summary.detail ?? summary.error ?? "-";
      const tone = summary.ok === false ? "bad" : "ok";
      return `<span class="admin-chip ${tone}"><span>${escHtml(label)}</span><strong>${escHtml(value)}</strong></span>`;
    }

    function checkPayloadToText(check) {
      if (!check) return "No data";
      if (check.payload !== undefined && check.payload !== null && check.payload !== "") {
        return prettyJson(check.payload);
      }
      if (check.text) return String(check.text);
      if (check.error) return String(check.error);
      return "No data";
    }

    function renderControlCenterSnapshot(data) {
      const service = data?.service || {};
      const summary = data?.summary || {};
      const checks = data?.checks || {};
      SELECTED_CONTROL_SERVICE_ID = service.service_id || "";
      $("adminSelectedServiceName").textContent = service.name || service.service_id || "Choose a service";
      $("adminSelectedServiceStatus").textContent = summary.checked_ts
        ? `Checked ${String(summary.checked_ts).replace("T", " ").slice(0, 16)} UTC`
        : "";
      $("adminServiceEmpty").classList.add("hidden");
      $("adminServiceDetailGrid").classList.remove("hidden");
      $("adminServiceMeta").innerHTML = [
        ["Service ID", service.service_id || "-"],
        ["Base URL", service.base_url || "-"],
        ["Auth", `${service.auth_type || "none"}${service.secret_env_var ? ` • ${service.secret_env_var}` : ""}`],
        ["Timeout", `${service.timeout_sec ?? "-"} sec`],
        ["Status", summary.latest_run_status || summary.status || "-"],
        ["Pipeline", summary.pipeline_stage || "-"],
        ["Notes", service.notes || "-"],
        ["Tags", Array.isArray(service.tags) && service.tags.length ? service.tags.join(", ") : "-"],
      ].map(([label, value]) => (
        `<div class="admin-meta-item"><div class="label">${escHtml(label)}</div><div style="margin-top:6px; font-size:0.84rem;">${escHtml(value)}</div></div>`
      )).join("");
      const links = [];
      if (service.app_url) links.push(`<a href="${escHtml(service.app_url)}" target="_blank" rel="noopener">Open App</a>`);
      if (service.repo_url) links.push(`<a href="${escHtml(service.repo_url)}" target="_blank" rel="noopener">Open Repo</a>`);
      $("adminServiceLinks").innerHTML = links.join("");
      $("adminServiceChecks").innerHTML = [
        serviceSummaryChip("Health", summary.checks?.health),
        serviceSummaryChip("Status", summary.checks?.status),
        serviceSummaryChip("Pipeline", summary.checks?.pipeline),
        serviceSummaryChip("Cost", summary.checks?.cost),
        serviceSummaryChip("Report", summary.checks?.report),
      ].filter(Boolean).join("");
      $("adminServiceActions").innerHTML = Array.isArray(service.actions) && service.actions.length
        ? service.actions.map((action) => (
            `<button type="button" data-service-action="${escHtml(action.id)}" title="${escHtml(action.description || "")}">${escHtml(action.label || action.id)}</button>`
          )).join("")
        : `<span class="admin-inline-status">No remote actions configured.</span>`;
      $("adminServiceActions").querySelectorAll("button[data-service-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const actionId = btn.getAttribute("data-service-action");
          if (!actionId) return;
          const action = (service.actions || []).find((item) => item.id === actionId) || {};
          if (action.confirm_text && !window.confirm(action.confirm_text)) return;
          btn.disabled = true;
          const original = btn.textContent;
          btn.textContent = "Running...";
          try {
            await invokeControlCenterAction(service.service_id, actionId);
          } finally {
            btn.textContent = original;
            btn.disabled = false;
          }
        });
      });
      $("adminHealthJson").textContent = checkPayloadToText(checks.health);
      $("adminStatusJson").textContent = checkPayloadToText(checks.status);
      $("adminPipelineJson").textContent = checkPayloadToText(checks.pipeline);
      $("adminCostJson").textContent = checkPayloadToText(checks.cost);
      $("adminReportJson").textContent = checkPayloadToText(checks.report);
      $("adminLogsJson").textContent = checkPayloadToText(checks.logs);
      populateControlCenterForm(service);
    }

    async function loadControlCenterOverview(selectServiceId = "") {
      if (!(await ensureAdminAuthenticated())) {
        blankControlCenterPanels("Log in to load services.");
        return;
      }
      const base = getApiBase();
      if (!base) return;
      $("adminOverviewStatus").textContent = "Loading services...";
      try {
        const resp = await adminFetch(`${base}/api/admin/control-center/overview?refresh=true&include_disabled=true&audit_limit=25`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        renderControlCenterOverview(data);
        const availableIds = new Set((data.services || []).map((row) => row.service?.service_id).filter(Boolean));
        const requestedId = selectServiceId || SELECTED_CONTROL_SERVICE_ID || "";
        const nextServiceId = availableIds.has(requestedId)
          ? requestedId
          : (data.services?.[0]?.service?.service_id || "");
        if (nextServiceId) {
          await loadControlCenterServiceSnapshot(nextServiceId);
        } else {
          blankControlCenterPanels("No managed services registered yet.");
          renderControlCenterOverview(data);
        }
      } catch (err) {
        $("adminOverviewStatus").textContent = `Overview failed (${err.message})`;
      }
    }

    async function loadControlCenterServiceSnapshot(serviceId) {
      if (!serviceId) return;
      if (!(await ensureAdminAuthenticated())) return;
      const base = getApiBase();
      if (!base) return;
      SELECTED_CONTROL_SERVICE_ID = serviceId;
      $("adminSelectedServiceStatus").textContent = "Loading service...";
      try {
        const resp = await adminFetch(`${base}/api/admin/control-center/services/${encodeURIComponent(serviceId)}/snapshot`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        renderControlCenterSnapshot(data);
      } catch (err) {
        $("adminSelectedServiceStatus").textContent = `Snapshot failed (${err.message})`;
      }
    }

    async function invokeControlCenterAction(serviceId, actionId) {
      const base = getApiBase();
      if (!base) return;
      const resp = await adminFetch(`${base}/api/admin/control-center/services/${encodeURIComponent(serviceId)}/actions/${encodeURIComponent(actionId)}`, {
        method: "POST",
      });
      if (!resp.ok) {
        throw new Error(`${resp.status} ${await resp.text()}`);
      }
      const data = await resp.json();
      $("adminSelectedServiceStatus").textContent = data.ok
        ? `Action ${actionId} queued`
        : `Action ${actionId} failed`;
      await loadControlCenterOverview(serviceId);
    }

    async function saveControlCenterService() {
      if (!(await ensureAdminAuthenticated())) return;
      const base = getApiBase();
      if (!base) return;
      const serviceId = String($("ccServiceId").value || "").trim();
      const name = String($("ccName").value || "").trim();
      if (!serviceId || !name) {
        $("ccFormStatus").textContent = "Service ID and name are required";
        return;
      }
      let actions = [];
      const actionsText = String($("ccActionsJson").value || "").trim();
      if (actionsText) {
        try {
          actions = JSON.parse(actionsText);
          if (!Array.isArray(actions)) throw new Error("Actions JSON must be an array");
        } catch (err) {
          $("ccFormStatus").textContent = `Invalid actions JSON: ${err.message}`;
          return;
        }
      }
      const payload = {
        service_id: serviceId,
        name,
        service_type: String($("ccServiceType").value || "generic").trim() || "generic",
        base_url: String($("ccBaseUrl").value || "").trim(),
        app_url: String($("ccAppUrl").value || "").trim(),
        repo_url: String($("ccRepoUrl").value || "").trim(),
        health_path: String($("ccHealthPath").value || "").trim(),
        status_path: String($("ccStatusPath").value || "").trim(),
        cost_path: String($("ccCostPath").value || "").trim(),
        pipeline_path: String($("ccPipelinePath").value || "").trim(),
        report_path: String($("ccReportPath").value || "").trim(),
        logs_path: String($("ccLogsPath").value || "").trim(),
        auth_type: String($("ccAuthType").value || "none").trim(),
        auth_header: String($("ccAuthHeader").value || "").trim(),
        secret_env_var: String($("ccSecretEnvVar").value || "").trim(),
        tags: String($("ccTags").value || "").split(",").map((x) => x.trim()).filter(Boolean),
        sort_order: Number($("ccSortOrder").value || 100),
        timeout_sec: Number($("ccTimeoutSec").value || 10),
        enabled: Boolean($("ccEnabled").checked),
        actions,
        notes: String($("ccNotes").value || "").trim(),
      };
      const exists = (CONTROL_CENTER_OVERVIEW?.services || []).some((row) => row.service?.service_id === serviceId);
      const method = exists ? "PUT" : "POST";
      const url = exists
        ? `${base}/api/admin/control-center/services/${encodeURIComponent(serviceId)}`
        : `${base}/api/admin/control-center/services`;
      $("ccSaveBtn").disabled = true;
      $("ccFormStatus").textContent = "Saving...";
      try {
        const resp = await adminFetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        $("ccFormStatus").textContent = "Saved";
        await loadControlCenterOverview(serviceId);
      } catch (err) {
        $("ccFormStatus").textContent = `Save failed (${err.message})`;
      } finally {
        $("ccSaveBtn").disabled = false;
      }
    }

    function computeYRangeForXWindow(x, low, high, x0, x1) {
      if (!x.length) return null;
      const t0 = x0 ? new Date(x0).getTime() : -Infinity;
      const t1 = x1 ? new Date(x1).getTime() : Infinity;
      let minY = Number.POSITIVE_INFINITY;
      let maxY = Number.NEGATIVE_INFINITY;
      for (let i = 0; i < x.length; i++) {
        const t = new Date(x[i]).getTime();
        if (Number.isNaN(t) || t < t0 || t > t1) continue;
        const lo = Number(low[i]);
        const hi = Number(high[i]);
        if (Number.isFinite(lo)) minY = Math.min(minY, lo);
        if (Number.isFinite(hi)) maxY = Math.max(maxY, hi);
      }
      if (!Number.isFinite(minY) || !Number.isFinite(maxY)) {
        const allLow = low.filter(Number.isFinite);
        const allHigh = high.filter(Number.isFinite);
        if (!allLow.length || !allHigh.length) return null;
        minY = Math.min(...allLow);
        maxY = Math.max(...allHigh);
      }
      const span = Math.max(maxY - minY, Math.abs(maxY) * 0.01, 1e-6);
      const pad = span * 0.08;
      return [minY - pad, maxY + pad];
    }

    function extendYRangeWithLevelValues(range, levelValues) {
      if (!range || !Array.isArray(range) || range.length !== 2) return range;
      const baseLo = Number(range[0]);
      const baseHi = Number(range[1]);
      if (!Number.isFinite(baseLo) || !Number.isFinite(baseHi)) return range;
      const span = Math.max(baseHi - baseLo, Math.abs(baseHi) * 0.01, 1e-6);
      const nearLo = baseLo - span * 0.35;
      const nearHi = baseHi + span * 0.35;

      let lo = baseLo;
      let hi = baseHi;
      for (const vRaw of (levelValues || [])) {
        const v = Number(vRaw);
        if (!Number.isFinite(v)) continue;
        if (v < nearLo || v > nearHi) continue;
        lo = Math.min(lo, v);
        hi = Math.max(hi, v);
      }
      const newSpan = Math.max(hi - lo, Math.abs(hi) * 0.01, 1e-6);
      const pad = newSpan * 0.08;
      return [lo - pad, hi + pad];
    }

    function resampleToWeekly(chart) {
      // ISO week key → use last trading day of that week as the bar date
      const isoWeek = (ds) => {
        const d = new Date(ds + "T12:00:00Z");
        const day = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - day); // Thursday anchor
        const yr = d.getUTCFullYear();
        const jan4 = new Date(Date.UTC(yr, 0, 4));
        const wk = Math.ceil(((d - jan4) / 864e5 + (jan4.getUTCDay() || 7)) / 7);
        return `${yr}-${String(wk).padStart(2, "0")}`;
      };
      const weeks = new Map();
      for (const row of chart) {
        const key = isoWeek(row.date);
        if (!weeks.has(key)) {
          weeks.set(key, { date: row.date, open: Number(row.open), high: Number(row.high), low: Number(row.low), close: Number(row.close), volume: Number(row.volume) || 0 });
        } else {
          const w = weeks.get(key);
          w.high = Math.max(w.high, Number(row.high));
          w.low  = Math.min(w.low,  Number(row.low));
          w.close = Number(row.close);
          w.date  = row.date; // last trading day of the week
          w.volume += Number(row.volume) || 0;
        }
      }
      return Array.from(weeks.values()).sort((a, b) => String(a.date).localeCompare(String(b.date)));
    }

    function buildMissingWeekdayRangebreakValues(dateList) {
      const unique = Array.from(new Set((dateList || []).map((d) => String(d || "").slice(0, 10)).filter(Boolean))).sort();
      if (!unique.length) return [];

      const seen = new Set(unique);
      const missing = [];
      const cur = new Date(`${unique[0]}T12:00:00Z`);
      const end = new Date(`${unique[unique.length - 1]}T12:00:00Z`);
      if (Number.isNaN(cur.getTime()) || Number.isNaN(end.getTime())) return [];

      while (cur <= end) {
        const dow = cur.getUTCDay();
        if (dow !== 0 && dow !== 6) {
          const y = cur.getUTCFullYear();
          const m = String(cur.getUTCMonth() + 1).padStart(2, "0");
          const d = String(cur.getUTCDate()).padStart(2, "0");
          const key = `${y}-${m}-${d}`;
          if (!seen.has(key)) missing.push(key);
        }
        cur.setUTCDate(cur.getUTCDate() + 1);
      }
      return missing;
    }

    function renderChart(payload) {
      LAST_CHART_PAYLOAD = payload;
      const isWeeklyChart = CHART_TIMEFRAME === "weekly";
      const rawChart = payload.chart || [];
      const chart = isWeeklyChart ? resampleToWeekly(rawChart) : rawChart;
      const levels = payload.levels || [];
      const gaps = payload.gaps || [];
      const trendlines = payload.trendlines || [];
      const patterns = payload.patterns || [];
      const patternOverlays = payload.pattern_overlays || [];
      const yoloPatterns = payload.yolo_patterns || [];
      const ticker = payload.ticker || "N/A";
      const showTrendlines = $("showTrendlines") ? Boolean($("showTrendlines").checked) : false;
      const showPatterns = $("showPatterns") ? Boolean($("showPatterns").checked) : true;
      const showRuleClassLines = $("showRuleClassLines") ? Boolean($("showRuleClassLines").checked) : true;
      const showBollinger = $("showBollinger") ? Boolean($("showBollinger").checked) : false;
      const showYoloPatterns = $("showYoloPatterns") ? Boolean($("showYoloPatterns").checked) : true;

      const x = chart.map(r => r.date);
      const open = chart.map(r => Number(r.open));
      const high = chart.map(r => Number(r.high));
      const low = chart.map(r => Number(r.low));
      const close = chart.map(r => Number(r.close));
      const vol = chart.map(r => Number(r.volume || 0));
      const volColor = chart.map(r => Number(r.close) >= Number(r.open) ? "rgba(56,211,159,0.7)" : "rgba(255,107,107,0.7)");
      const missingWeekdayBreaks = buildMissingWeekdayRangebreakValues(x);

      const ma = (arr, n) => arr.map((_, i) => {
        if (i < n - 1) return null;
        let s = 0;
        for (let j = i - n + 1; j <= i; j++) s += arr[j];
        return s / n;
      });
      const bollinger = (arr, n = 20, k = 2) => {
        const upper = new Array(arr.length).fill(null);
        const lower = new Array(arr.length).fill(null);
        for (let i = n - 1; i < arr.length; i++) {
          let sum = 0;
          for (let j = i - n + 1; j <= i; j++) sum += arr[j];
          const mean = sum / n;
          let varSum = 0;
          for (let j = i - n + 1; j <= i; j++) {
            const d = arr[j] - mean;
            varSum += d * d;
          }
          const std = Math.sqrt(varSum / n);
          upper[i] = mean + k * std;
          lower[i] = mean - k * std;
        }
        return { upper, lower };
      };

      const traces = [
        {
          type: "candlestick",
          x, open, high, low, close,
          name: ticker, xaxis: "x", yaxis: "y",
          increasing: {line: {color: "#38d39f"}, fillcolor: "rgba(56,211,159,0.85)"},
          decreasing: {line: {color: "#ff6b6b"}, fillcolor: "rgba(255,107,107,0.85)"}
        },
        { type: "scatter", mode: "lines", x, y: ma(close, 20), name: "MA20", line: {color:"#6aa9ff", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 50), name: "MA50", line: {color:"#f8c24e", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 100), name: "MA100", line: {color:"#38d39f", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 200), name: "MA200", line: {color:"#c07bff", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "bar", x, y: vol, name: "Volume", marker: {color: volColor}, xaxis:"x2", yaxis:"y2" }
      ];
      if (showBollinger) {
        const bb = bollinger(close, 20, 2);
        traces.push({
          type: "scatter",
          mode: "lines",
          x,
          y: bb.upper,
          name: "BB Upper (20,2)",
          line: { color: "rgba(106,169,255,0.75)", width: 1.1, dash: "dot" },
          xaxis: "x",
          yaxis: "y",
        });
        traces.push({
          type: "scatter",
          mode: "lines",
          x,
          y: bb.lower,
          name: "BB Lower (20,2)",
          line: { color: "rgba(106,169,255,0.75)", width: 1.1, dash: "dot" },
          fill: "tonexty",
          fillcolor: "rgba(106,169,255,0.08)",
          xaxis: "x",
          yaxis: "y",
        });
      }

      const candlePatterns = payload.candlestick_patterns || [];
      if (candlePatterns.length > 0) {
        const bullish = candlePatterns.filter(p => String(p.bias || "").toLowerCase() === "bullish");
        const bearish = candlePatterns.filter(p => String(p.bias || "").toLowerCase() === "bearish");
        if (bullish.length > 0) {
          traces.push({
            type: "scatter", mode: "markers",
            x: bullish.map(p => p.date),
            y: bullish.map(p => { const i = x.indexOf(p.date); return i >= 0 ? low[i] * 0.994 : null; }),
            name: "Bullish Signal",
            marker: {symbol: "triangle-up", size: 9, color: "#38d39f"},
            hovertext: bullish.map(p => `${p.pattern} (${fmt(p.confidence)})`),
            hoverinfo: "text+x", xaxis: "x", yaxis: "y"
          });
        }
        if (bearish.length > 0) {
          traces.push({
            type: "scatter", mode: "markers",
            x: bearish.map(p => p.date),
            y: bearish.map(p => { const i = x.indexOf(p.date); return i >= 0 ? high[i] * 1.006 : null; }),
            name: "Bearish Signal",
            marker: {symbol: "triangle-down", size: 9, color: "#ff6b6b"},
            hovertext: bearish.map(p => `${p.pattern} (${fmt(p.confidence)})`),
            hoverinfo: "text+x", xaxis: "x", yaxis: "y"
          });
        }
      }

      const lastDate = x.length ? x[x.length - 1] : null;
      const selectedMonths = DEFAULT_MONTHS; // default view window; use rangeselector to zoom
      const defaultX0 = (() => {
        if (!lastDate) return null;
        if (selectedMonths <= 0) return x.length ? x[0] : null;
        const d = new Date(lastDate);
        d.setMonth(d.getMonth() - selectedMonths);
        return d.toISOString().slice(0, 10);
      })();
      const defaultX1 = lastDate || null;
      const levelValues = levels.map((r) => Number(r.level)).filter(Number.isFinite);
      const baseDefaultY = computeYRangeForXWindow(x, low, high, defaultX0, defaultX1);
      const defaultY = extendYRangeWithLevelValues(baseDefaultY, levelValues);

      const isMobile = window.innerWidth < 640;
      const shapes = [];
      const annotations = [];

      levels.forEach(r => {
        const lvl = Number(r.level);
        if (Number.isNaN(lvl)) return;
        const color = r.type === "support" ? "#3f8cff" : "#ff7b5b";
        const tier = (r.tier || "primary").toLowerCase();
        const dash = tier === "primary" ? "solid" : (tier === "secondary" ? "dot" : "dash");
        const width = tier === "primary" ? 2 : (tier === "secondary" ? 1 : 1.5);
        const tierLabel = tier === "primary" ? "PRIMARY" : (tier === "secondary" ? "SECONDARY" : "FALLBACK");
        const z0 = Number(r.zone_low);
        const z1 = Number(r.zone_high);
        if (!Number.isNaN(z0) && !Number.isNaN(z1)) {
          shapes.push({
            type: "rect", xref: "paper", yref: "y",
            x0: 0, x1: 1, y0: Math.min(z0, z1), y1: Math.max(z0, z1),
            fillcolor: r.type === "support" ? "rgba(63,140,255,0.10)" : "rgba(255,123,91,0.10)",
            line: {width: 0}
          });
        }
        shapes.push({
          type: "line", xref: "paper", yref: "y",
          x0: 0, x1: 1, y0: lvl, y1: lvl,
          line: {color, width, dash}
        });
        annotations.push({
          xref: "paper", yref: "y", x: 1.0, y: lvl,
          text: isMobile
            ? fmt(lvl)
            : `${tierLabel} ${String(r.type).toUpperCase()}<br>${fmt(lvl)} (${r.touches ?? "-"})`,
          showarrow: false, xanchor: "left", yanchor: "middle", align: "left",
          xshift: 4, borderpad: 2,
          bgcolor: "rgba(18,25,39,0.9)", bordercolor: color,
          font: {color, size: isMobile ? 10 : 11}
        });
      });

      gaps.forEach(g => {
        const y0 = Number(g.gap_low), y1 = Number(g.gap_high);
        if (Number.isNaN(y0) || Number.isNaN(y1)) return;
        shapes.push({
          type: "rect", xref: "x", yref: "y",
          x0: g.date, x1: x[x.length - 1], y0, y1,
          fillcolor: g.type === "bull_gap" ? "rgba(248,194,78,0.22)" : "rgba(106,169,255,0.20)",
          line: {width: 1, color: "rgba(142,160,189,0.6)"}
        });
      });

      if (showTrendlines) trendlines.forEach(t => {
        const y0 = Number(t.y0);
        const y1 = Number(t.y1);
        if (Number.isNaN(y0) || Number.isNaN(y1)) return;
        const color = String(t.type || "").includes("support") ? "#38d39f" : "#ff6b6b";
        shapes.push({
          type: "line",
          xref: "x",
          yref: "y",
          x0: t.x0_date,
          x1: t.x1_date,
          y0,
          y1,
          line: {color, width: 1.6, dash: "dot"}
        });
      });

      if (showPatterns) {
        const patternColor = (nameRaw) => {
          const name = String(nameRaw || "").toLowerCase();
          if (
            name.includes("bull")
            || name.includes("falling_wedge")
            || name.includes("ascending_triangle")
            || name.includes("double_bottom")
            || name.includes("inv_head")
          ) return "#38d39f";
          if (
            name.includes("bear")
            || name.includes("rising_wedge")
            || name.includes("descending_triangle")
            || name.includes("double_top")
            || name.includes("head_and_shoulders")
          ) return "#ff6b6b";
          return "#f8c24e";
        };
        const sourceDash = (sRaw) => {
          const s = String(sRaw || "").toLowerCase();
          if (s === "hybrid_rule") return "solid";
          return "dot";
        };

        let overlays = patternOverlays.filter((p) => {
          const src = String(p.source || "");
          if (src === "cv_proxy") return false;
          if (!showRuleClassLines && (src === "rule" || src === "hybrid_rule")) return false;
          return true;
        });

        if (!overlays.length) {
          overlays = patterns.slice(0, 4).map((p) => ({
            source: "rule",
            class_name: p.pattern,
            status: p.status,
            confidence: p.confidence,
            x0_date: p.x0_date,
            x1_date: p.x1_date,
            y0: p.y0,
            y1: p.y1,
            y0b: p.y0b,
            y1b: p.y1b,
            notes: p.notes,
          }));
        }

        overlays = overlays
          .slice()
          .sort((a, b) => Number(b.confidence || 0) - Number(a.confidence || 0))
          .slice(0, 10);

        overlays.forEach((p, idx) => {
          const y0 = Number(p.y0);
          const y1 = Number(p.y1);
          const y0b = Number(p.y0b);
          const y1b = Number(p.y1b);
          if ([y0, y1, y0b, y1b].some(Number.isNaN)) return;
          const className = String(p.class_name || p.pattern || "pattern");
          const status = String(p.status || "forming");
          const source = String(p.source || "rule");
          const conf = Number(p.confidence);
          const color = patternColor(className);
          const dash = sourceDash(source);
          const width = source === "hybrid_rule" ? 2.1 : 1.7;
          const shortSrc = source === "hybrid_rule" ? "HYB" : "RULE";

          shapes.push({
            type: "line",
            xref: "x",
            yref: "y",
            x0: p.x0_date,
            x1: p.x1_date,
            y0,
            y1,
            line: {color, width, dash},
          });
          shapes.push({
            type: "line",
            xref: "x",
            yref: "y",
            x0: p.x0_date,
            x1: p.x1_date,
            y0: y0b,
            y1: y1b,
            line: {color, width, dash},
          });
          if (!isMobile) {
            annotations.push({
              xref: "paper",
              yref: "paper",
              x: 0.01,
              y: 0.98 - idx * 0.045,
              text: `${className.replaceAll("_", " ")} • ${shortSrc} • ${status} • ${fmt(conf, 2)}`,
              showarrow: false,
              xanchor: "left",
              yanchor: "top",
              bgcolor: "rgba(18,25,39,0.85)",
              bordercolor: color,
              font: {color, size: 11},
            });
          }
        });
      }

      if (showYoloPatterns && yoloPatterns.length > 0) {
        const yoloColorMap = {
          bull: {stroke: "#38d39f", fill: "rgba(56,211,159,0.07)"},
          bear: {stroke: "#ff6b6b", fill: "rgba(255,107,107,0.07)"},
          neutral: {stroke: "#f8c24e", fill: "rgba(248,194,78,0.07)"},
        };
        const yoloLabel = (nameRaw, compact = false) => {
          const raw = String(nameRaw || "").replaceAll("_", " ").trim();
          const map = {
            "Head and shoulders bottom": "H&S Bottom",
            "Head and shoulders top": "H&S Top",
            "M Head": "M Head",
            "W Bottom": "W Bottom",
            "StockLine": "Stock Line",
          };
          let label = map[raw] || raw || "Pattern";
          if (compact) {
            const compactMap = {
              "H&S Bottom": "H&S Bot",
              "H&S Top":    "H&S Top",
              "W Bottom":   "W Bot",
              "M Head":     "M Head",
              "Stock Line": "StkLine",
              "Triangle":   "Triangle",
            };
            label = compactMap[label] ?? (label.length > 10 ? `${label.slice(0, 10)}…` : label);
          }
          return label;
        };
        const yoloStyle = (nameRaw) => {
          const n = String(nameRaw || "").toLowerCase();
          if (n.includes("bottom") || n.includes("w_bottom") || n.includes("shoulders bottom")) return yoloColorMap.bull;
          if (n.includes("top") || n.includes("m_head") || n.includes("shoulders top")) return yoloColorMap.bear;
          return yoloColorMap.neutral;
        };
        // Separate daily vs weekly so weekly renders with a wider, dashed border
        const dailyPatterns = yoloPatterns.filter(p => (p.timeframe || "daily") === "daily");
        const weeklyPatterns = yoloPatterns.filter(p => p.timeframe === "weekly");

        const renderYoloGroup = (group, isWeekly) => {
          const borderWidth = isWeekly ? 2.2 : 1.5;
          const borderDash = isWeekly ? "dash" : "dot";
          const fillOpacity = isWeekly ? "0.05" : "0.07";
          const maxLabels = isMobile ? (isWeekly ? 2 : 3) : 5;
          let labelCount = 0;
          group.forEach((p) => {
            const y0 = Number(p.y0), y1 = Number(p.y1);
            if (Number.isNaN(y0) || Number.isNaN(y1)) return;
            const baseStyle = yoloStyle(p.pattern);
            // Weekly uses slightly muted colours to not compete with daily boxes
            const stroke = isWeekly ? baseStyle.stroke + "cc" : baseStyle.stroke;
            const fill = baseStyle.fill.replace(/[\d.]+\)$/, `${fillOpacity})`);
            const conf = Number(p.confidence);
            const label = isWeekly ? "W" : "D";
            shapes.push({
              type: "rect",
              xref: "x",
              yref: "y",
              x0: p.x0_date,
              x1: p.x1_date,
              y0: Math.min(y0, y1),
              y1: Math.max(y0, y1),
              line: {color: stroke, width: borderWidth, dash: borderDash},
              fillcolor: fill,
            });
            if (labelCount < maxLabels) {
              const confPct = Number.isFinite(conf) ? `${(conf * 100).toFixed(0)}%` : "";
              const labelName = yoloLabel(p.pattern, isMobile);
              const text = isMobile
                ? `${label}:${labelName} ${confPct}`
                : `[${label}] ${yoloLabel(p.pattern, false)} ${confPct}`;
              const yTop = Math.max(y0, y1);
              annotations.push({
                xref: "x",
                yref: "y",
                x: isMobile ? p.x0_date : p.x1_date,
                y: yTop,
                text,
                showarrow: false,
                xanchor: "left",
                yanchor: isMobile ? "top" : "bottom",
                xshift: isMobile ? 2 : 4,
                yshift: isMobile ? -2 : 0,
                bgcolor: "rgba(18,25,39,0.85)",
                bordercolor: baseStyle.stroke,
                font: {color: baseStyle.stroke, size: isMobile ? 8 : (isWeekly ? 9 : 10)},
              });
              labelCount++;
            }
          });
        };

        renderYoloGroup(dailyPatterns, false);
        renderYoloGroup(weeklyPatterns, true);
      }

      const layout = {
        paper_bgcolor: "#121927",
        plot_bgcolor: "#121927",
        font: {color: "#e9eef8"},
        margin: isMobile ? {t: 40, l: 45, r: 80, b: 40} : {t: 40, l: 60, r: 235, b: 50},
        dragmode: "zoom",
        legend: isMobile
          ? {orientation: "h", y: -0.08, x: 0, xanchor: "left", font: {size: 10}}
          : {orientation: "h", y: -0.04, x: 0, xanchor: "left"},
        xaxis: {
          domain: [0, 1], anchor: "y", rangeslider: {visible: false},
          showgrid: true, gridcolor: "#25334f",
          range: defaultX0 && defaultX1 ? [defaultX0, defaultX1] : undefined,
          rangebreaks: [
            {bounds: ["sat", "mon"]},
            ...(missingWeekdayBreaks.length ? [{values: missingWeekdayBreaks}] : []),
          ],
          rangeselector: {
            bgcolor: "#e9eef8",
            activecolor: "#6aa9ff",
            bordercolor: "#0b0f16",
            borderwidth: 1,
            font: {color: "#0b0f16", size: 12},
            buttons: [
              {count: 3, step: "month", stepmode: "backward", label: "3M"},
              {count: 6, step: "month", stepmode: "backward", label: "6M"},
              {count: 1, step: "year", stepmode: "todate", label: "YTD"},
              {count: 1, step: "year", stepmode: "backward", label: "1Y"},
              {count: 2, step: "year", stepmode: "backward", label: "2Y"},
              {step: "all", label: "ALL"}
            ]
          }
        },
        yaxis: {
          domain: [0.30, 1],
          showgrid: true,
          gridcolor: "#25334f",
          title: "Price",
          range: defaultY || undefined,
          autorange: !defaultY
        },
        xaxis2: {domain: [0, 1], anchor: "y2", matches: "x", showgrid: false},
        yaxis2: {domain: [0, 0.24], showgrid: true, gridcolor: "#25334f", title: "Volume"},
        shapes,
        annotations
      };

      Plotly.newPlot("chart", traces, layout, {responsive: true, scrollZoom: true, displayModeBar: true});
      const chartEl = $("chart");
      let ySyncLock = false;
      chartEl.on("plotly_relayout", (ev) => {
        if (ySyncLock) return;
        const hasXRange = "xaxis.range[0]" in ev || Array.isArray(ev["xaxis.range"]);
        const allX = ev["xaxis.autorange"] === true;
        if (!hasXRange && !allX) return; // ignore Y-only or unrelated events — prevents snap-back
        const r0 = ev["xaxis.range[0]"] ?? (Array.isArray(ev["xaxis.range"]) ? ev["xaxis.range"][0] : null);
        const r1 = ev["xaxis.range[1]"] ?? (Array.isArray(ev["xaxis.range"]) ? ev["xaxis.range"][1] : null);
        const baseYr = allX
          ? computeYRangeForXWindow(x, low, high, x[0], x[x.length - 1])
          : computeYRangeForXWindow(x, low, high, r0 || x[0], r1 || x[x.length - 1]);
        const yr = extendYRangeWithLevelValues(baseYr, levelValues);
        if (!yr) return;
        ySyncLock = true;
        Plotly.relayout("chart", {"yaxis.range": yr})
          .catch(() => {})
          .finally(() => { ySyncLock = false; });
      });
    }

    function setOpportunityFilters({view, minDiscount, maxPeg, overvaluedThreshold, limitRows}) {
      if (view !== undefined) $("opView").value = String(view);
      if (minDiscount !== undefined) $("minDiscount").value = String(minDiscount);
      if (maxPeg !== undefined) $("maxPeg").value = String(maxPeg);
      if (overvaluedThreshold !== undefined) $("overvaluedThreshold").value = String(overvaluedThreshold);
      if (limitRows !== undefined) $("limitRows").value = String(limitRows);
    }

    function applyOpportunityPreset(name) {
      if ($("opSearch")) $("opSearch").value = "";
      if (name === "all") {
        setOpportunityFilters({ view: "all", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "undervalued") {
        setOpportunityFilters({ view: "undervalued", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "deep_value") {
        setOpportunityFilters({ view: "deep_value", minDiscount: 20, maxPeg: 1.5, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "overvalued") {
        setOpportunityFilters({ view: "overvalued", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else {
        setOpportunityFilters({ view: "all", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      }
      loadOpportunities();
    }

    async function loadOpportunities() {
      const base = getApiBase();
      const view = String($("opView").value || "all");
      const apiView = view === "deep_value" ? "undervalued" : view;
      const minDiscount = Number($("minDiscount").value || 10);
      const maxPeg = Number($("maxPeg").value || 2);
      const overvaluedThreshold = Number($("overvaluedThreshold").value || -10);
      const limitRows = Number($("limitRows").value || 500);
      const btn = $("loadOpBtn");
      btn.disabled = true;
      $("opStatus").innerHTML = `<span class="status-plain">Loading opportunities...</span>`;
      setGlobalStatus("Loading opportunities...");
      try {
        const q = new URLSearchParams({
          limit: String(limitRows),
          min_discount: String(minDiscount),
          max_peg: String(maxPeg),
          overvalued_threshold: String(overvaluedThreshold),
          view: apiView,
        });
        const resp = await apiFetch(`${base}/api/opportunities?${q.toString()}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        const rows = payload.rows || [];
        renderOpFilterHelp(payload.filter_help || null);
        renderSimpleTable(
          "opTable",
          ["ticker", "price", "pe", "peg", "target_price", "discount_pct", "valuation_label", "eps_growth_5y"],
          rows,
          true,
          (row) => {
            $("ticker").value = row.ticker;
            activateTab("chart");
            loadChart();
          },
          { sortable: true, searchInputId: "opSearch" }
        );
        renderOpStatus(payload, view, rows.length);
        setGlobalStatus("Opportunities loaded");
      } catch (err) {
        console.error(err);
        $("opStatus").innerHTML = `<span class="status-plain" style="color:#ff8a8a;">Failed: ${escHtml(err.message)}</span>`;
        setGlobalStatus("Failed loading opportunities");
      } finally {
        btn.disabled = false;
      }
    }

    async function loadChart() {
      const ticker = ($("ticker").value || "SPY").trim().toUpperCase();
      const months = 0; // always fetch all data; view window controlled by rangeselector
      const base = getApiBase();
      const btn = $("loadChartBtn");
      btn.disabled = true;
      $("chartStatus").textContent = `Loading ${ticker}...`;
      setGlobalStatus(`Loading ${ticker} dashboard...`);
      try {
        const resp = await apiFetch(`${base}/api/dashboard/${ticker}?months=${months}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        fillCards(payload);
        renderChart(payload);
        renderSimpleTable("levelsTable", ["type", "level", "zone_low", "zone_high", "tier", "touches", "last_touch_date"], payload.levels || [], false, null, { sortable: true });
        renderSimpleTable("gapsTable", ["date", "type", "gap_low", "gap_high"], payload.gaps || [], false, null, { sortable: true });
        renderSimpleTable("trendlinesTable", ["type", "touch_count", "score", "last_touch_date"], payload.trendlines || [], false, null, { sortable: true });
        renderSimpleTable("patternsTable", ["pattern", "status", "confidence", "start_date", "end_date"], payload.patterns || [], false, null, { sortable: true });
        renderSimpleTable(
          "hybridPatternsTable",
          ["pattern", "status", "hybrid_confidence", "base_confidence", "candle_score", "volume_score", "breakout_score", "candle_bias", "vol_ratio", "start_date", "end_date"],
          payload.hybrid_patterns || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable(
          "patternOverlaysTable",
          ["source", "class_name", "status", "confidence", "start_date", "end_date"],
          payload.pattern_overlays || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable("candlesTable", ["date", "pattern", "bias", "confidence", "explanation"], payload.candlestick_patterns || [], false, null, { sortable: true });
        renderSimpleTable("yoloPatternsTable", ["timeframe", "pattern", "confidence", "x0_date", "x1_date", "y0", "y1", "as_of_date"], payload.yolo_patterns || [], false, null, { sortable: true });
        $("chartStatus").textContent = `asof ${payload.asof || "-"} • ${ticker}`;
        setGlobalStatus(`Done (${ticker})`);
      } catch (err) {
        console.error(err);
        $("chartStatus").textContent = `Failed: ${err.message}`;
        setGlobalStatus(`Failed (${ticker})`);
      } finally {
        btn.disabled = false;
      }
    }

    async function loadTickerUniverse() {
      const base = getApiBase();
      try {
        const resp = await apiFetch(`${base}/api/tickers?limit=2000`);
        if (!resp.ok) throw new Error(`${resp.status}`);
        const payload = await resp.json();
        const list = $("tickerList");
        if (!list) return;
        list.innerHTML = "";
        (payload.tickers || []).forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          list.appendChild(opt);
        });
      } catch (err) {
        console.warn("ticker universe load failed", err);
      }
    }

    function loadTickerQuick(t) {
      $("ticker").value = t;
      activateTab("chart");
      loadChart();
    }

    function jumpToTicker(ticker) {
      loadTickerQuick(ticker);
    }
    window.jumpToTicker = jumpToTicker;

    function normalizeTickerSymbol(v) {
      return String(v || "").trim().toUpperCase().replace(/\s+/g, "");
    }

    function getStoredWatchlist() {
      try {
        const raw = localStorage.getItem(WATCHLIST_STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return [...new Set(arr.map(normalizeTickerSymbol).filter(Boolean))];
      } catch {
        return [];
      }
    }

    function saveStoredWatchlist(list) {
      localStorage.setItem(WATCHLIST_STORAGE_KEY, JSON.stringify([...new Set((list || []).map(normalizeTickerSymbol).filter(Boolean))]));
    }

    function addTickerToWatchlist(ticker) {
      const symbol = normalizeTickerSymbol(ticker);
      if (!symbol) return false;
      const list = getStoredWatchlist();
      if (!list.includes(symbol)) list.push(symbol);
      saveStoredWatchlist(list);
      renderWatchlistTable();
      return true;
    }
    window.addTickerToWatchlist = addTickerToWatchlist;

    function removeTickerFromWatchlist(ticker) {
      const symbol = normalizeTickerSymbol(ticker);
      const list = getStoredWatchlist().filter((t) => t !== symbol);
      saveStoredWatchlist(list);
      renderWatchlistTable();
    }
    window.removeTickerFromWatchlist = removeTickerFromWatchlist;

    function renderWatchlistTable() {
      const el = $("reportWatchTable");
      if (!el) return;
      const hint = $("reportWatchHint");
      const list = getStoredWatchlist();
      const setupMap = new Map((LAST_REPORT_SETUP_ROWS || []).map((r) => [String(r.ticker || "").toUpperCase(), r]));

      const head = "<tr><th>ticker</th><th>score</th><th>pct_change</th><th>setup_tier</th><th>yolo_pattern</th><th>actions</th></tr>";
      if (!list.length) {
        el.innerHTML = `${head}<tr><td colspan=\"6\">No watchlist tickers yet</td></tr>`;
        if (hint) hint.textContent = "Tip: Add symbols manually or import top setup candidates.";
        return;
      }

      const rowsHtml = list
        .map((ticker) => {
          const row = setupMap.get(ticker) || {};
          const score = row.score ?? "-";
          const pct = row.pct_change ?? "-";
          const tier = row.setup_tier ?? "-";
          const yolo = row.yolo_pattern || "-";
          return (
            `<tr>` +
            `<td>${escHtml(ticker)}</td>` +
            `<td>${escHtml(score)}</td>` +
            `<td>${escHtml(pct)}</td>` +
            `<td>${escHtml(tier)}</td>` +
            `<td>${escHtml(yolo)}</td>` +
            `<td>` +
            `<button type="button" data-watch-load="${escHtml(ticker)}" style="width:auto; padding:5px 8px; margin-right:6px;">Load</button>` +
            `<button type="button" data-watch-remove="${escHtml(ticker)}" style="width:auto; padding:5px 8px;">Remove</button>` +
            `</td>` +
            `</tr>`
          );
        })
        .join("");
      el.innerHTML = head + rowsHtml;
      if (hint) hint.textContent = `${list.length} ticker(s) saved locally in this browser.`;

      el.querySelectorAll("button[data-watch-load]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-watch-load");
          if (t) loadTickerQuick(t);
        });
      });
      el.querySelectorAll("button[data-watch-remove]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-watch-remove");
          if (t) removeTickerFromWatchlist(t);
        });
      });
    }

    async function loadReport() {
      const base = getApiBase();
      $("reportStatus").textContent = "Loading...";
      try {
        const resp = await apiFetch(`${base}/api/daily-report?limit=20`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        const latest = data.latest || {};
        const counts = latest.counts || {};
        const yoloBlock = latest.yolo || {};
        const yoloSummary = yoloBlock.summary || {};
        const ingestRun = latest.latest_ingest_run || {};
        const signals = latest.signals || {};
        const hasReport = data.ok && Object.keys(latest).length > 0;

        $("reportNoData").style.display = hasReport ? "none" : "block";
        if (!hasReport) { $("reportStatus").textContent = "No report yet"; return; }

        const makeCard = (label, val) =>
          `<div class="card"><div class="label">${label}</div><div class="value">${val ?? "—"}</div></div>`;

        $("reportSummaryCards").innerHTML = [
          makeCard("Generated (UTC)", (latest.generated_ts || "—").slice(0, 16).replace("T", " ")),
          makeCard("Tracked Tickers", counts.tracked_tickers ?? "—"),
          makeCard("Price Rows", (counts.price_rows ?? 0).toLocaleString()),
          makeCard("Latest Price Date", (latest.latest_data || {}).price_date ?? "—"),
          makeCard("Last Ingest", ingestRun.status ?? "—"),
        ].join("");

        const tfDaily  = (yoloBlock.timeframes || []).find(t => t.timeframe === "daily")  || {};
        const tfWeekly = (yoloBlock.timeframes || []).find(t => t.timeframe === "weekly") || {};
        $("reportYoloCards").innerHTML = [
          makeCard("YOLO Total Rows", yoloSummary.rows_total ?? "—"),
          makeCard("YOLO Tickers", yoloSummary.tickers_with_patterns ?? "—"),
          makeCard("Daily Tickers", tfDaily.tickers_with_patterns  ?? "—"),
          makeCard("Weekly Tickers", tfWeekly.tickers_with_patterns ?? "—"),
        ].join("");

        const keyChanges = signals.tonight_key_changes || [];
        $("reportKeyChangesList").innerHTML = keyChanges.length
          ? keyChanges
              .slice(0, 5)
              .map((row) => `<li><b>${escHtml(row.title || "Change")}:</b> ${escHtml(row.detail || "-")}</li>`)
              .join("")
          : "<li>No material changes captured.</li>";

        const risk = latest.risk_filters || {};
        const riskMode = String(risk.trade_mode || "normal");
        const hardBlocks = Number(risk.hard_blocks || 0);
        const softFlags = Number(risk.soft_flags || 0);
        $("reportRiskSummary").innerHTML =
          `Mode: <b>${escHtml(riskMode.toUpperCase())}</b>` +
          ` • Hard blocks: <b>${hardBlocks}</b>` +
          ` • Soft flags: <b>${softFlags}</b>`;
        const riskRows = Array.isArray(risk.conditions) ? risk.conditions : [];
        $("reportRiskList").innerHTML = riskRows.length
          ? riskRows
              .slice(0, 10)
              .map((row) => `<li>[${escHtml(String(row.severity || "soft").toUpperCase())}] ${escHtml(row.reason || row.code || "-")}</li>`)
              .join("")
          : "<li>No active no-trade conditions.</li>";

        const setupRows = (signals.setup_quality_top || []).slice(0, 40);
        const compactSetupRows = buildCompactSetupRows(setupRows.slice(0, 15));
        LAST_REPORT_SETUP_ROWS = setupRows;
        $("reportSetupSummary").textContent = setupRows.length
          ? `Compact view keeps the nightly workflow tight: top ${Math.min(15, setupRows.length)} names first, advanced metrics only when needed.`
          : "No confluence rows available yet.";
        $("reportSetupExplain").textContent = setupRows.length
          ? "Why it ranks: value (discount + PEG), today's move, volatility regime, and YOLO strength/freshness."
          : "";
        renderSimpleTable(
          "reportSetupCompactTable",
          [
            { key: "ticker", label: "Ticker" },
            { key: "score", label: "Score" },
            { key: "setup_tier", label: "Tier" },
            { key: "why_high", label: "Why It Ranks" },
            { key: "pct_change", label: "Today %" },
            { key: "value_case", label: "Value" },
            { key: "yolo", label: "YOLO" },
          ],
          compactSetupRows,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        renderSimpleTable(
          "reportSetupQualityTable",
          [
            { key: "ticker", label: "Ticker" },
            { key: "score", label: "Score" },
            { key: "setup_tier", label: "Tier" },
            { key: "sector", label: "Sector" },
            { key: "pct_change", label: "Today %" },
            { key: "discount_pct", label: "Discount %" },
            { key: "peg", label: "PEG" },
            { key: "atr_pct_14", label: "ATR %" },
            { key: "realized_vol_20", label: "RV20 %" },
            { key: "bb_width_20", label: "BB Width %" },
            { key: "yolo_pattern", label: "YOLO Pattern" },
            { key: "yolo_confidence", label: "YOLO Conf" },
            { key: "yolo_age_days", label: "YOLO Age (d)" },
          ],
          setupRows.slice(0, 25),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        $("reportSetupQuickAdds").innerHTML = setupRows
          .slice(0, 10)
          .map((row) => `<button type="button" data-watch-add="${escHtml(row.ticker)}">+ ${escHtml(row.ticker)}</button>`)
          .join("");
        $("reportSetupQuickAdds").querySelectorAll("button[data-watch-add]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const t = btn.getAttribute("data-watch-add");
            if (!t) return;
            addTickerToWatchlist(t);
          });
        });
        setReportSetupMode(REPORT_SETUP_SHOW_MORE);

        const sectorRows = signals.sector_heatmap || [];
        const maxAbs = Math.max(1, ...sectorRows.map((r) => Math.abs(Number(r.avg_pct_change || 0))));
        $("reportSectorHeatmap").innerHTML = sectorRows
          .slice(0, 12)
          .map((r) => {
            const avg = Number(r.avg_pct_change || 0);
            const width = Math.max(2, Math.round((Math.abs(avg) / maxAbs) * 100));
            const color = avg >= 0 ? "linear-gradient(90deg,#1f8f66,#38d39f)" : "linear-gradient(90deg,#cc5a5a,#ff6b6b)";
            return (
              `<div class="heat-row">` +
              `<div>${escHtml(r.sector || "Unknown")}</div>` +
              `<div class="heat-track"><div class="heat-fill" style="width:${width}%; background:${color};"></div></div>` +
              `<div style="text-align:right;">${escHtml((avg >= 0 ? "+" : "") + avg.toFixed(2) + "%")}</div>` +
              `</div>`
            );
          })
          .join("");
        renderSimpleTable(
          "reportSectorHeatTable",
          ["sector", "avg_pct_change", "pct_advancing", "tickers", "near_high_count", "near_low_count"],
          sectorRows.slice(0, 20),
          false,
          null,
          { sortable: true },
        );
        renderWatchlistTable();

        const yoloDeltaDaily = yoloBlock.delta_daily || yoloBlock.delta || {};
        const yoloDeltaWeekly = yoloBlock.delta_weekly || {};
        const yoloDelta = yoloDeltaDaily;
        const yoloNew = yoloDelta.new_patterns || [];
        const yoloLost = yoloDelta.lost_patterns || [];
        const wkNew = Number(yoloDeltaWeekly.new_count || 0);
        const wkLost = Number(yoloDeltaWeekly.lost_count || 0);
        $("reportYoloDeltaSummary").textContent =
          `Comparing ${yoloDelta.prev_asof || "?"} -> ${yoloDelta.today_asof || "?"}` +
          ` • New: ${yoloDelta.new_count ?? yoloNew.length}` +
          ` • No longer detected: ${yoloDelta.lost_count ?? yoloLost.length}` +
          (yoloDeltaWeekly && Object.keys(yoloDeltaWeekly).length
            ? ` • Weekly: +${wkNew} / -${wkLost}`
            : "");
        renderSimpleTable(
          "reportYoloNewTable",
          ["ticker", "timeframe", "pattern", "confidence", "x0_date", "x1_date"],
          yoloNew.slice(0, 20),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        const yoloPersistence = yoloBlock.persistence || {};
        const persistDaily = ((yoloPersistence.daily || {}).rows || []).slice(0, 15);
        const persistWeekly = ((yoloPersistence.weekly || {}).rows || []).slice(0, 15);
        const pDailyMeta = yoloPersistence.daily || {};
        const pWeeklyMeta = yoloPersistence.weekly || {};
        $("reportYoloPersistenceSummary").textContent =
          `Daily window: ${pDailyMeta.lookback_asof ?? "?"} as-ofs (latest ${pDailyMeta.latest_asof || "?"})` +
          ` • Weekly window: ${pWeeklyMeta.lookback_asof ?? "?"} as-ofs (latest ${pWeeklyMeta.latest_asof || "?"})`;
        renderSimpleTable(
          "reportYoloPersistenceDailyTable",
          ["ticker", "pattern", "streak", "seen_in_lookback", "coverage_pct", "latest_confidence"],
          persistDaily,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        renderSimpleTable(
          "reportYoloPersistenceWeeklyTable",
          ["ticker", "pattern", "streak", "seen_in_lookback", "coverage_pct", "latest_confidence"],
          persistWeekly,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        renderSimpleTable(
          "reportYoloLostTable",
          ["ticker", "timeframe", "pattern", "confidence", "x0_date", "x1_date"],
          yoloLost.slice(0, 20),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        const breadth = signals.market_breadth || {};
        const pctAdv = breadth.pct_advancing ?? "—";
        const adv = breadth.advancers ?? 0;
        const dec = breadth.decliners ?? 0;
        const unch = breadth.unchanged ?? 0;
        const avgMove = breadth.avg_pct_change ?? "—";
        const medianMove = breadth.median_pct_change ?? "—";
        const moveThresh = breadth.large_move_threshold_pct ?? "—";
        const moveCount = breadth.large_move_count ?? 0;
        $("reportBreadthSummary").innerHTML =
          `Breadth: <b>${adv}</b> up / <b>${dec}</b> down / <b>${unch}</b> flat` +
          ` • Advancing: <b>${pctAdv}%</b>` +
          ` • Avg move: <b>${avgMove}%</b>` +
          ` • Median move: <b>${medianMove}%</b>` +
          ` • |move| >= ${moveThresh}%: <b>${moveCount}</b>`;

        renderSimpleTable(
          "reportMoversUpTable",
          ["ticker", "pct_change", "close", "prev_close", "pct_from_high"],
          (signals.movers_up_today || []).slice(0, 12),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );
        renderSimpleTable(
          "reportMoversDownTable",
          ["ticker", "pct_change", "close", "prev_close", "pct_from_low"],
          (signals.movers_down_today || []).slice(0, 12),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        // 52W extremes
        const nearHigh = signals.near_52w_high || [];
        const nearLow  = signals.near_52w_low  || [];
        const fmt52w = (arr, field, refField, color) =>
          arr.length
            ? arr.map(t =>
                `<span style="display:inline-block; margin-right:10px;">` +
                `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
                `<span style="color:var(--fg)">$${t.close}</span> ` +
                `<span style="color:var(--muted); font-size:0.75rem;">(${t[field].toFixed(2)}% from ${refField} $${t[refField === 'high_52w' ? 'high_52w' : 'low_52w']})</span>` +
                `</span>`
              ).join("")
            : `<span style="color:var(--muted)">None</span>`;

        $("report52wHigh").innerHTML = nearHigh.length
          ? nearHigh.map(t =>
              `<span style="display:inline-block; margin-right:12px; margin-bottom:2px;">` +
              `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
              `<span>$${t.close}</span> ` +
              `<span style="color:var(--muted); font-size:0.75rem;">(${t.pct_from_high.toFixed(2)}% below $${t.high_52w})</span>` +
              `</span>`
            ).join("")
          : `<span style="color:var(--muted)">None</span>`;

        $("report52wLow").innerHTML = nearLow.length
          ? nearLow.map(t =>
              `<span style="display:inline-block; margin-right:12px; margin-bottom:2px;">` +
              `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
              `<span>$${t.close}</span> ` +
              `<span style="color:var(--muted); font-size:0.75rem;">(${t.pct_from_low.toFixed(2)}% above $${t.low_52w})</span>` +
              `</span>`
            ).join("")
          : `<span style="color:var(--muted)">None</span>`;

        // Top YOLO patterns at close
        renderSimpleTable("reportYoloTopTable",
          ["ticker", "timeframe", "pattern", "confidence", "age_days", "x0_date", "x1_date", "as_of_date"],
          signals.yolo_top_today || [],
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false });

        // Candle signals at close
        renderSimpleTable("reportCandleTable",
          ["ticker", "pattern", "bias", "confidence"],
          signals.candle_patterns_today || [],
          false, null, { sortable: false });

        renderSimpleTable("reportHistoryTable",
          ["file", "size_bytes", "modified_ts"],
          data.history || [],
          false, null, { sortable: false });

        const asOf = `As of ${(latest.generated_ts || "").slice(0, 16).replace("T", " ")} UTC`;
        $("reportStatus").textContent = data.detail ? `${asOf} • ${data.detail}` : asOf;
      } catch (err) {
        $("reportStatus").textContent = `Error: ${err.message}`;
        console.error(err);
      }
    }

    function setChartTimeframe(tf) {
      CHART_TIMEFRAME = tf;
      $("tfDailyBtn").style.background  = tf === "daily"  ? "var(--blue)" : "var(--card)";
      $("tfDailyBtn").style.color        = tf === "daily"  ? "#fff"        : "var(--muted)";
      $("tfDailyBtn").style.border       = tf === "daily"  ? "none"        : "1px solid var(--border)";
      $("tfWeeklyBtn").style.background  = tf === "weekly" ? "var(--blue)" : "var(--card)";
      $("tfWeeklyBtn").style.color        = tf === "weekly" ? "#fff"        : "var(--muted)";
      $("tfWeeklyBtn").style.border       = tf === "weekly" ? "none"        : "1px solid var(--border)";
      if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD);
    }

    $("loadOpBtn").addEventListener("click", loadOpportunities);
    $("presetAllBtn").addEventListener("click", () => applyOpportunityPreset("all"));
    $("presetUndervaluedBtn").addEventListener("click", () => applyOpportunityPreset("undervalued"));
    $("presetDeepValueBtn").addEventListener("click", () => applyOpportunityPreset("deep_value"));
    $("presetOvervaluedBtn").addEventListener("click", () => applyOpportunityPreset("overvalued"));
    $("presetResetBtn").addEventListener("click", () => applyOpportunityPreset("reset"));
    $("clearOpSearchBtn").addEventListener("click", () => {
      if ($("opSearch")) $("opSearch").value = "";
      loadOpportunities();
    });
    $("adminLoginBtn").addEventListener("click", loginAdmin);
    $("adminRefreshBtn").addEventListener("click", () => loadControlCenterOverview(SELECTED_CONTROL_SERVICE_ID));
    $("adminLogoutBtn").addEventListener("click", logoutAdmin);
    $("ccSaveBtn").addEventListener("click", saveControlCenterService);
    $("ccResetBtn").addEventListener("click", () => {
      resetControlCenterForm();
      $("ccName").focus();
    });
    $("adminPassword").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      loginAdmin();
    });
    $("loadChartBtn").addEventListener("click", loadChart);
    $("reportWatchAddBtn").addEventListener("click", () => {
      const input = $("reportWatchTickerInput");
      if (!input) return;
      const symbol = normalizeTickerSymbol(input.value);
      if (!symbol) return;
      addTickerToWatchlist(symbol);
      input.value = "";
    });
    $("reportWatchImportBtn").addEventListener("click", () => {
      const picks = (LAST_REPORT_SETUP_ROWS || []).slice(0, 5).map((r) => r.ticker).filter(Boolean);
      if (!picks.length) return;
      const merged = [...new Set([...getStoredWatchlist(), ...picks])];
      saveStoredWatchlist(merged);
      renderWatchlistTable();
    });
    $("reportWatchClearBtn").addEventListener("click", () => {
      saveStoredWatchlist([]);
      renderWatchlistTable();
    });
    $("reportWatchTickerInput").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      $("reportWatchAddBtn").click();
    });
    $("reportSetupCompactBtn").addEventListener("click", () => setReportSetupMode(false));
    $("reportSetupMoreBtn").addEventListener("click", () => setReportSetupMode(true));
    $("tfDailyBtn").addEventListener("click", () => setChartTimeframe("daily"));
    $("tfWeeklyBtn").addEventListener("click", () => setChartTimeframe("weekly"));
    window.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const active = document.activeElement;
      const tag = String(active?.tagName || "").toLowerCase();
      if (tag === "textarea") return;
      if (active && ["reportWatchTickerInput", "adminUsername", "adminPassword"].includes(active.id)) return;
      if (!tabChart.classList.contains("hidden")) loadChart();
    });
    $("showTrendlines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showPatterns").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showRuleClassLines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showBollinger").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showYoloPatterns").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });

    (async () => {
      await initApiBase();
      await initApiKey();
      resetControlCenterForm();
      await refreshAdminSession(true);
      setReportSetupMode(false);
      activateTab("guide");
      await refreshServiceStatus();
      await loadTickerUniverse();
      await loadOpportunities();
      setInterval(refreshServiceStatus, 120000);
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") refreshServiceStatus();
      });
    })();
  </script>
</body>
</html>
