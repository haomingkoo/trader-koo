<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>trader_koo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #0b0f16;
      --panel: #121927;
      --muted: #8ea0bd;
      --text: #e9eef8;
      --line: #25334f;
      --green: #38d39f;
      --red: #ff6b6b;
      --amber: #f8c24e;
      --blue: #6aa9ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "IBM Plex Sans", ui-monospace, SFMono-Regular, Menlo, monospace;
      background: radial-gradient(1200px 600px at 10% -10%, #1d2740 0%, var(--bg) 45%);
      color: var(--text);
    }
    .wrap { max-width: 1360px; margin: 0 auto; padding: 24px; }

    /* ── Nav ── */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0 16px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 0;
      font-family: 'Inter', sans-serif;
    }
    .nav-logo {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--text);
      text-decoration: none;
    }
    .nav-links { display: flex; gap: 28px; }
    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 13.5px;
      letter-spacing: .02em;
      transition: color .2s;
    }
    .nav-links a:hover { color: var(--text); }

    /* ── Hero ── */
    .hero {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 18px;
      padding: 22px 0 20px;
      font-family: 'Inter', sans-serif;
    }
    .hero-title {
      font-size: clamp(30px, 6vw, 46px);
      font-weight: 700;
      line-height: 1.05;
      letter-spacing: -.03em;
      margin: 0 0 6px;
      background: linear-gradient(135deg, #e9eef8 28%, #6aa9ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-sub {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
      font-weight: 400;
    }
    .status-pill {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 12px;
      padding: 8px 14px;
      color: var(--muted);
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      word-break: break-word;
    }
    input, select, button, textarea {
      width: 100%;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }
    textarea {
      min-height: 110px;
      resize: vertical;
      font-family: inherit;
    }
    .status { color: var(--muted); font-size: 0.9rem; }
    .top-disclaimer {
      margin-bottom: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(248, 194, 78, 0.32);
      background: linear-gradient(180deg, rgba(248, 194, 78, 0.08), rgba(255, 107, 107, 0.05));
      border-radius: 12px;
      color: #f3dfb1;
      font-size: 0.82rem;
      line-height: 1.5;
    }
    .top-disclaimer b { color: #ffe2a1; }
    .tabs { display: flex; gap: 8px; margin-bottom: 14px; }
    .tab-btn {
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--muted);
      padding: 9px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .tab-btn.active {
      color: white;
      background: linear-gradient(90deg, #1f7bff, #4e9cff);
      border: none;
    }
    .hidden { display: none; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
    }
    .op-toolbar {
      display: grid;
      grid-template-columns: 170px 150px 150px 140px 170px minmax(170px, 1fr) 120px 120px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .preset-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 0 10px 0;
    }
    .preset-toolbar button {
      width: auto;
      padding: 8px 12px;
      border-radius: 9px;
      font-size: 0.82rem;
      background: #0f1624;
      color: var(--text);
      border: 1px solid var(--line);
      cursor: pointer;
    }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { color: var(--muted); font-size: 0.72rem; }
    .op-help {
      margin-bottom: 8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0f1624;
    }
    .op-help-title {
      color: var(--text);
      font-size: 0.82rem;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .op-help-grid {
      display: grid;
      grid-template-columns: 170px 1fr;
      gap: 6px 10px;
      align-items: start;
    }
    .op-help-key { color: var(--muted); font-size: 0.8rem; }
    .op-help-val { color: var(--text); font-size: 0.82rem; }
    .op-status {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      min-height: 34px;
      max-width: 100%;
      overflow-x: auto;
      padding: 2px 0;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.78rem;
      white-space: normal;
      word-break: break-word;
    }
    .status-chip .k { color: var(--muted); }
    .status-chip .v { color: var(--text); font-weight: 700; }
    .status-plain {
      color: var(--muted);
      font-size: 0.88rem;
    }
    .chart-toolbar {
      display: grid;
      grid-template-columns: 180px 150px 125px 125px 135px 135px 110px 75px 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 10px;
      margin: 10px 0 14px;
    }
    .card {
      background: linear-gradient(180deg, #141d2f, #101726);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      min-height: 72px;
    }
    .earnings-mode-toggle {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: #0f1624;
      width: auto;
    }
    .earnings-mode-toggle button {
      width: auto;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 0.78rem;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }
    .earnings-mode-toggle button.active {
      background: linear-gradient(90deg, #1f7bff, #4e9cff);
      color: #fff;
      border-color: transparent;
    }
    .earnings-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 14px;
    }
    .earnings-day {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(180deg, #121c2e, #0f1624);
      padding: 14px;
    }
    .earnings-day h3 {
      margin: 0;
      font-size: 1rem;
      line-height: 1.2;
    }
    .earnings-day-sub {
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.75rem;
    }
    .earnings-lanes {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .earnings-lane {
      border: 1px solid rgba(142, 160, 189, 0.14);
      border-radius: 12px;
      background: rgba(11, 15, 22, 0.42);
      padding: 10px;
    }
    .earnings-lane-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .earnings-lane-title {
      color: var(--muted);
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .earnings-lane-count {
      color: var(--muted);
      font-size: 0.72rem;
    }
    .earnings-card {
      border: 1px solid rgba(142, 160, 189, 0.14);
      border-radius: 12px;
      background: rgba(18, 25, 39, 0.9);
      padding: 10px 11px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: border-color .15s ease, transform .15s ease;
      width: 100%;
      text-align: left;
    }
    .earnings-card:hover {
      border-color: rgba(106, 169, 255, 0.7);
      transform: translateY(-1px);
    }
    .earnings-card.active {
      border-color: rgba(106, 169, 255, 0.88);
      box-shadow: 0 0 0 1px rgba(106, 169, 255, 0.28) inset;
    }
    .earnings-card:last-child { margin-bottom: 0; }
    .earnings-card-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 7px;
    }
    .earnings-card-ticker {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.1;
      flex: 1 1 auto;
      min-width: 0;
      overflow-wrap: anywhere;
    }
    .earnings-score {
      border-radius: 999px;
      padding: 4px 8px;
      background: rgba(106, 169, 255, 0.12);
      color: #c9dcff;
      font-size: 0.72rem;
      font-weight: 700;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .earnings-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .earnings-badge {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.68rem;
      font-weight: 700;
      border: 1px solid rgba(142, 160, 189, 0.18);
      background: rgba(142, 160, 189, 0.08);
      color: var(--text);
    }
    .earnings-badge.bullish { color: #baf0dd; border-color: rgba(56, 211, 159, 0.35); background: rgba(56, 211, 159, 0.12); }
    .earnings-badge.bearish { color: #ffd0d0; border-color: rgba(255, 107, 107, 0.35); background: rgba(255, 107, 107, 0.12); }
    .earnings-badge.high { color: #ffd0d0; border-color: rgba(255, 107, 107, 0.35); background: rgba(255, 107, 107, 0.12); }
    .earnings-badge.elevated { color: #f7e1a1; border-color: rgba(248, 194, 78, 0.35); background: rgba(248, 194, 78, 0.12); }
    .earnings-badge.normal { color: #baf0dd; border-color: rgba(56, 211, 159, 0.35); background: rgba(56, 211, 159, 0.10); }
    .earnings-badge.setup_ready,
    .earnings-badge.confirmed { color: #baf0dd; border-color: rgba(56, 211, 159, 0.35); background: rgba(56, 211, 159, 0.12); }
    .earnings-badge.watch,
    .earnings-badge.date_only,
    .earnings-badge.snapshot { color: #f7e1a1; border-color: rgba(248, 194, 78, 0.35); background: rgba(248, 194, 78, 0.12); }
    .earnings-badge.calendar_only,
    .earnings-badge.unverified { color: #d2d9e6; border-color: rgba(142, 160, 189, 0.24); background: rgba(142, 160, 189, 0.10); }
    .earnings-card-sub {
      margin-top: 8px;
      font-size: 0.73rem;
      line-height: 1.35;
      color: var(--muted);
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .earnings-card-sub strong {
      color: var(--text);
      font-weight: 700;
    }
    .earnings-lane-empty {
      color: var(--muted);
      font-size: 0.75rem;
      line-height: 1.45;
      padding-top: 4px;
    }
    .earnings-detail {
      display: grid;
      gap: 12px;
    }
    .earnings-detail-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .earnings-detail-title {
      font-size: 1.05rem;
      font-weight: 800;
      line-height: 1.15;
      margin: 0;
    }
    .earnings-detail-subtitle {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .earnings-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .earnings-detail-block {
      border: 1px solid rgba(142, 160, 189, 0.14);
      border-radius: 12px;
      background: rgba(11, 15, 22, 0.42);
      padding: 12px;
    }
    .earnings-detail-block .label {
      margin-bottom: 6px;
    }
    .earnings-detail-copy {
      font-size: 0.82rem;
      line-height: 1.55;
      color: var(--text);
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .report-list {
      margin: 0;
      padding-left: 20px;
      line-height: 1.6;
      color: var(--text);
      font-size: 0.84rem;
    }
    .report-list li { margin-bottom: 6px; }
    .mini-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .mini-actions button {
      width: auto;
      padding: 5px 9px;
      border-radius: 8px;
      font-size: 0.74rem;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      cursor: pointer;
    }
    .mini-actions button:hover { border-color: var(--blue); }
    .report-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 8px 0;
    }
    .report-toggle-btn {
      width: auto;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.76rem;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--muted);
      cursor: pointer;
    }
    .report-toggle-btn.active {
      color: #fff;
      border-color: transparent;
      background: linear-gradient(90deg, #1f7bff, #4e9cff);
    }
    .report-inline-note {
      color: var(--muted);
      font-size: 0.78rem;
      line-height: 1.5;
    }
    .report-watch-wrap {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    .report-watch-wrap input {
      flex: 1 1 180px;
      min-width: 160px;
      width: auto;
    }
    .report-watch-wrap button {
      width: auto;
      padding: 8px 10px;
      font-size: 0.76rem;
    }
    .heatmap-grid {
      display: grid;
      gap: 6px;
      margin-bottom: 8px;
    }
    .heat-row {
      display: grid;
      grid-template-columns: 120px 1fr 70px;
      gap: 8px;
      align-items: center;
      font-size: 0.78rem;
    }
    .heat-track {
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #0f1624;
      overflow: hidden;
      position: relative;
    }
    .heat-fill {
      height: 100%;
      border-radius: 999px;
    }
    .admin-shell {
      display: grid;
      gap: 12px;
    }
    .admin-top {
      display: grid;
      grid-template-columns: minmax(280px, 420px) minmax(0, 1fr);
      gap: 12px;
    }
    .admin-grid {
      display: grid;
      grid-template-columns: minmax(320px, 0.95fr) minmax(0, 1.45fr);
      gap: 12px;
    }
    .admin-grid.admin-lower {
      grid-template-columns: minmax(0, 1.1fr) minmax(300px, 0.9fr);
    }
    .admin-panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .admin-subtle {
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.5;
    }
    .admin-inline-status {
      color: var(--muted);
      font-size: 0.78rem;
    }
    .admin-login-grid,
    .admin-form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .admin-form-grid .field.full,
    .admin-login-grid .field.full {
      grid-column: 1 / -1;
    }
    .admin-form-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }
    .admin-form-actions button {
      width: auto;
      min-width: 130px;
    }
    .admin-checks {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 10px 0 12px;
    }
    .admin-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      font-size: 0.76rem;
      white-space: normal;
      word-break: break-word;
    }
    .admin-chip.ok {
      border-color: rgba(56, 211, 159, 0.35);
      color: #9ee7ca;
    }
    .admin-chip.bad {
      border-color: rgba(255, 107, 107, 0.35);
      color: #ffb3b3;
    }
    .admin-meta {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      margin-bottom: 8px;
    }
    .admin-meta-item {
      min-width: 0;
    }
    .admin-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }
    .admin-links a {
      color: var(--blue);
      text-decoration: none;
      font-size: 0.8rem;
    }
    .admin-links a:hover {
      text-decoration: underline;
    }
    .admin-detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    .admin-detail-block {
      min-width: 0;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #0f1624;
      padding: 10px;
    }
    .json-block {
      margin: 8px 0 0;
      max-height: 280px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.77rem;
      line-height: 1.55;
      color: var(--text);
    }
    .admin-empty {
      color: var(--muted);
      font-size: 0.82rem;
      padding: 12px 0;
    }
    #tabAdmin table {
      width: max-content;
      min-width: 100%;
      font-size: 0.82rem;
    }
    #tabAdmin th,
    #tabAdmin td {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: top;
    }
    .label { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .value { font-size: 1.05rem; font-weight: 700; margin-top: 8px; }
    #chart { width: 100%; height: 760px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tr.clickable:hover { background: rgba(106,169,255,0.12); cursor: pointer; }
    .table-wrap { margin-top: 12px; display: grid; grid-template-columns: repeat(2, minmax(420px, 1fr)); gap: 12px; }
    .table-wrap > .panel { min-width: 0; overflow-x: auto; }
    #tabReport .panel { min-width: 0; overflow-x: auto; }
    #tabReport table {
      width: max-content;
      min-width: 100%;
      font-size: 0.82rem;
    }
    #reportSetupCompactTable {
      width: 100%;
      min-width: 100%;
      table-layout: fixed;
    }
    #tabReport th,
    #tabReport td {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: top;
    }
    #reportStatus,
    #reportBreadthSummary,
    #reportYoloDeltaSummary,
    #reportSetupSummary,
    #reportWatchHint {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .guide,
    .guide p,
    .guide li,
    .guide-v,
    .guide summary,
    .guide-callout,
    .site-footnote {
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .mkt-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }
    .mkt-bar button {
      width: auto;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
      background: #0f1624;
      color: var(--muted);
      border: 1px solid var(--line);
      cursor: pointer;
    }
    .mkt-bar button:hover { color: var(--text); border-color: var(--blue); }
    @media (max-width: 1100px) {
      .op-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
      .op-toolbar .field { flex: 1 1 140px; }
      .op-toolbar button { flex: 0 0 auto; width: auto; }
      .chart-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
      .chart-toolbar > * { flex: 1 1 130px; min-width: 0; }
      .chart-toolbar button { flex: 0 0 auto; width: auto; }
      .admin-top,
      .admin-grid,
      .admin-grid.admin-lower,
      .admin-detail-grid,
      .admin-meta {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 640px) {
      .wrap { padding: 12px; }
      #chart { height: 420px; }
      .table-wrap { grid-template-columns: 1fr; }
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .card { min-height: 64px; padding: 8px 10px; }
      .label { font-size: 0.68rem; }
      .value { font-size: 0.95rem; }
      .hero { flex-direction: column; align-items: flex-start; gap: 12px; }
      .status-pill { width: 100%; border-radius: 10px; }
      nav { flex-wrap: wrap; gap: 10px; }
      .nav-links { gap: 14px; flex-wrap: wrap; }
      .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .tab-btn { padding: 8px 10px; font-size: 0.82rem; }
      #tabReport .panel { padding: 8px; overflow-x: auto; }
      #tabReport table { min-width: 560px; font-size: 0.78rem; }
      #report52wHigh span, #report52wLow span {
        display: block !important;
        margin-right: 0 !important;
      }
      .report-watch-wrap { flex-direction: column; align-items: stretch; }
      .report-watch-wrap input, .report-watch-wrap button { width: 100%; }
      .mini-actions button { flex: 1 1 calc(50% - 6px); }
      .heat-row { grid-template-columns: 86px 1fr 58px; gap: 6px; font-size: 0.74rem; }
      .admin-login-grid,
      .admin-form-grid {
        grid-template-columns: 1fr;
      }
      .admin-form-actions button {
        width: 100%;
      }
      #tabAdmin table {
        min-width: 560px;
        font-size: 0.78rem;
      }
    }
    @media (max-width: 420px) {
      .tabs { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
      .mini-actions button { flex: 1 1 100%; }
      #tabReport table { min-width: 500px; }
    }
    .guide {
      line-height: 1.55;
      color: var(--text);
      font-size: 0.92rem;
      overflow-x: hidden;
    }
    .guide h3 {
      margin: 12px 0 8px;
      font-size: 1rem;
      color: var(--text);
    }
    .guide p {
      margin: 0 0 8px;
      color: var(--muted);
    }
    .guide-list {
      margin: 0 0 10px 18px;
      padding: 0;
      color: var(--muted);
    }
    .guide-list li { margin: 0 0 6px; }
    .guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .guide-grid,
    .guide-card,
    .guide details,
    .guide summary,
    .guide-callout {
      min-width: 0;
      max-width: 100%;
    }
    .guide-card {
      background: #0f1624;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .guide-k {
      color: var(--muted);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }
    .guide-v {
      color: var(--text);
      font-size: 0.84rem;
      line-height: 1.45;
    }
    .guide-callout {
      background: rgba(255,107,107,0.12);
      border: 1px solid #ff6b6b;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .guide-callout-title {
      color: #ff8a8a;
      font-weight: 700;
      font-size: 0.92rem;
      margin-bottom: 4px;
    }
    .guide details {
      background: #0f1624;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
    }
    .guide summary {
      display: block;
      cursor: pointer;
      color: var(--text);
      font-weight: 600;
      font-size: 0.86rem;
      outline: none;
    }
    .guide details p,
    .guide details ul { margin-top: 8px; }
    .site-footnote {
      margin: 14px auto 24px;
      max-width: 1360px;
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.5;
      text-align: center;
    }
    .site-footnote strong {
      color: #ff8a8a;
      font-weight: 700;
    }
    @media (max-width: 640px) {
      .guide { font-size: 0.88rem; }
      .guide-grid { grid-template-columns: 1fr; }
      .guide-list { margin-left: 14px; }
      .guide details { padding: 8px; }
      .guide summary { font-size: 0.82rem; }
      .site-footnote { padding: 10px 12px; font-size: 0.76rem; }
      .top-disclaimer { font-size: 0.76rem; padding: 9px 10px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a class="nav-logo" href="https://kooexperience.com">HK</a>
      <div class="nav-links">
        <a href="https://kooexperience.com">Home</a>
        <a href="https://github.com/haomingkoo" target="_blank" rel="noopener">GitHub</a>
      </div>
    </nav>
    <div class="top-disclaimer">
      <b>Research only. Not financial advice.</b> This dashboard can be wrong, stale, or incomplete. Treat it as a decision-support tool, not an instruction to buy or sell.
    </div>
    <section class="hero">
      <div>
        <h1 class="hero-title">trader_koo</h1>
        <p class="hero-sub">S&amp;P 500 swing dashboard — AI pattern detection, valuation screening, and after-close signals.</p>
      </div>
      <div id="serviceStatus" class="status-pill">Connecting...</div>
    </section>
    <div id="globalStatus" class="status" style="margin-bottom: 10px; font-size: 0.82rem;"></div>
    <input id="apiBase" type="hidden" value="" />


    <div class="tabs">
      <button id="tabGuideBtn" class="tab-btn active">Guide</button>
      <button id="tabReportBtn" class="tab-btn">Daily Report</button>
      <button id="tabEarningsBtn" class="tab-btn">Earnings Calendar</button>
      <button id="tabChartBtn" class="tab-btn">Chart + Levels</button>
      <button id="tabOpBtn" class="tab-btn">Opportunities (PEG)</button>
    </div>

    <section id="tabOp" class="panel hidden">
      <div id="opFilterHelp" class="op-help">
        Default is full S&P500 universe. Use presets for quick screens, then sort/search table.
      </div>
      <div class="preset-toolbar">
        <button id="presetAllBtn" type="button">All S&P 500</button>
        <button id="presetUndervaluedBtn" type="button">Undervalued</button>
        <button id="presetDeepValueBtn" type="button">Deep Value</button>
        <button id="presetOvervaluedBtn" type="button">Overvalued</button>
        <button id="presetResetBtn" type="button">Reset</button>
      </div>
      <div class="op-toolbar">
        <div class="field">
          <label for="opView">View</label>
          <select id="opView">
            <option value="undervalued">Undervalued</option>
            <option value="deep_value">Deep Value</option>
            <option value="overvalued">Overvalued</option>
            <option value="all" selected>All (Full Universe)</option>
          </select>
        </div>
        <div class="field">
          <label for="minDiscount">Min Discount %</label>
          <input id="minDiscount" type="number" step="1" value="10" />
        </div>
        <div class="field">
          <label for="maxPeg">Max PEG</label>
          <input id="maxPeg" type="number" step="0.1" value="2.0" />
        </div>
        <div class="field">
          <label for="overvaluedThreshold">Overvalued Threshold %</label>
          <input id="overvaluedThreshold" type="number" step="1" value="-10" />
        </div>
        <div class="field">
          <label for="limitRows">Max Rows</label>
          <input id="limitRows" type="number" step="1" value="500" />
        </div>
        <div class="field">
          <label for="opSearch">Search Table</label>
          <input id="opSearch" type="text" placeholder="ticker, reason, etc" />
        </div>
        <button id="clearOpSearchBtn" type="button">Clear Search</button>
        <button id="loadOpBtn">Load</button>
      </div>
      <div id="opStatus" class="op-status"><span class="status-plain">Auto-loading full S&P500 table...</span></div>
      <div style="overflow-x: auto; max-width: 100%;"><table id="opTable"></table></div>
    </section>

    <section id="tabChart" class="hidden">
      <div class="panel">
        <div class="chart-toolbar">
          <input id="ticker" list="tickerList" value="SPY" placeholder="Ticker e.g. NVDA" />
          <datalist id="tickerList"></datalist>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showTrendlines" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span id="showTrendlinesLabel" style="font-size:0.8rem; color:var(--muted);">Trendlines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showPatterns" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span id="showPatternsLabel" style="font-size:0.8rem; color:var(--muted);">Pattern Boxes</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showRuleClassLines" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span id="showRuleClassLinesLabel" style="font-size:0.8rem; color:var(--muted);">Rule/Hybrid Lines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showBollinger" type="checkbox" style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Bollinger Bands</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showYoloPatterns" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">YOLO Patterns</span>
          </label>
          <div class="field" style="display:flex; flex-direction:row; align-items:center; gap:4px;">
            <span style="font-size:0.75rem; color:var(--muted);">Bars:</span>
            <button id="tfDailyBtn" style="padding:2px 9px; font-size:0.78rem; background:var(--blue); color:#fff; border:none; border-radius:3px; cursor:pointer;">D</button>
            <button id="tfWeeklyBtn" style="padding:2px 9px; font-size:0.78rem; background:var(--card); color:var(--muted); border:1px solid var(--border); border-radius:3px; cursor:pointer;">W</button>
          </div>
          <button id="loadChartBtn">Load</button>
          <div id="chartStatus" class="status">Select ticker and load</div>
        </div>
        <div class="mkt-bar">
          <span style="color:var(--muted); font-size:0.75rem;">Market:</span>
          <button onclick="loadTickerQuick('SPY')">SPY</button>
          <button onclick="loadTickerQuick('QQQ')">QQQ</button>
          <button onclick="loadTickerQuick('^VIX')">VIX</button>
          <button onclick="loadTickerQuick('SVIX')">SVIX</button>
          <button onclick="loadTickerQuick('^GSPC')">SPX</button>
          <button onclick="loadTickerQuick('^DJI')">DJI</button>
          <button onclick="loadTickerQuick('^TNX')">TNX</button>
        </div>

        <div class="cards">
          <div class="card"><div class="label">Price</div><div id="c-price" class="value">-</div></div>
          <div class="card"><div class="label">PE</div><div id="c-pe" class="value">-</div></div>
          <div class="card"><div class="label">PEG</div><div id="c-peg" class="value">-</div></div>
          <div class="card"><div class="label">Target</div><div id="c-target" class="value">-</div></div>
          <div class="card"><div class="label">Discount %</div><div id="c-discount" class="value">-</div></div>
          <div class="card"><div class="label">Put/Call OI</div><div id="c-pcr" class="value">-</div></div>
        </div>

        <div id="chart"></div>
      </div>

      <div class="table-wrap">
        <div class="panel">
          <div class="label">Levels</div>
          <table id="levelsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Open Gaps</div>
          <table id="gapsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Trendlines</div>
          <table id="trendlinesTable"></table>
        </div>
        <div class="panel">
          <div class="label">Pattern Candidates</div>
          <table id="patternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Hybrid Pattern Scores</div>
          <table id="hybridPatternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Pattern Overlays (Drawn)</div>
          <table id="patternOverlaysTable"></table>
        </div>
        <div class="panel">
          <div class="label">Candlestick Signals</div>
          <table id="candlesTable"></table>
        </div>
        <div class="panel">
          <div class="label">YOLO AI Patterns</div>
          <table id="yoloPatternsTable"></table>
        </div>
      </div>
    </section>

    <section id="tabReport" class="panel hidden">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:1.1rem;">Daily Report</h2>
        <span id="reportStatus" style="font-size:0.8rem; color:var(--muted);"></span>
      </div>
      <div id="reportSummaryCards" class="cards" style="margin-bottom:14px;"></div>
      <div id="reportYoloCards" class="cards" style="margin-bottom:14px;"></div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Tonight's 5 Key Changes</div>
        <ol id="reportKeyChangesList" class="report-list"></ol>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">No-Trade Conditions</div>
        <div id="reportRiskSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:8px;"></div>
        <ul id="reportRiskList" class="report-list"></ul>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Watchlist</div>
        <div class="report-watch-wrap">
          <input id="reportWatchTickerInput" type="text" placeholder="Add ticker (e.g. NVDA)" />
          <button id="reportWatchAddBtn" type="button">Add</button>
          <button id="reportWatchImportBtn" type="button">Import Top 5 Setups</button>
          <button id="reportWatchClearBtn" type="button">Clear</button>
        </div>
        <div id="reportWatchHint" style="font-size:0.78rem; color:var(--muted); margin-bottom:8px;"></div>
        <table id="reportWatchTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Confluence Score</div>
        <div id="reportSetupSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:8px;"></div>
        <div id="reportSetupExplain" class="report-inline-note"></div>
        <div class="report-actions">
          <button id="reportSetupCompactBtn" class="report-toggle-btn active" type="button" aria-pressed="true">Compact View</button>
          <button id="reportSetupMoreBtn" class="report-toggle-btn" type="button" aria-pressed="false">More Metrics</button>
        </div>
        <div id="reportSetupQuickAdds" class="mini-actions"></div>
        <table id="reportSetupCompactTable"></table>
        <div id="reportSetupDetailWrap" class="hidden" style="margin-top:10px;">
          <div class="report-inline-note" style="margin-bottom:8px;">Advanced view adds raw volatility and YOLO aging metrics so you can audit why a name ranked where it did.</div>
          <table id="reportSetupQualityTable"></table>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Sector Heatmap</div>
        <div id="reportSectorHeatmap" class="heatmap-grid"></div>
        <table id="reportSectorHeatTable"></table>
      </div>

      <!-- YOLO delta -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">YOLO Changes vs Previous Run</div>
        <div id="reportYoloDeltaSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEW PATTERNS</div>
            <table id="reportYoloNewTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NO LONGER DETECTED</div>
            <table id="reportYoloLostTable"></table>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">YOLO Pattern Persistence</div>
        <div id="reportYoloPersistenceSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--blue); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">DAILY</div>
            <table id="reportYoloPersistenceDailyTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--blue); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">WEEKLY</div>
            <table id="reportYoloPersistenceWeeklyTable"></table>
          </div>
        </div>
      </div>

      <!-- Large moves + breadth -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Large Moves Today (vs Prior Close)</div>
        <div id="reportBreadthSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">TOP GAINERS</div>
            <table id="reportMoversUpTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">TOP LOSERS</div>
            <table id="reportMoversDownTable"></table>
          </div>
        </div>
      </div>

      <!-- 52W Extremes -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">52-Week Extremes (within 3% of high/low)</div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEAR 52W HIGH</div>
            <div id="report52wHigh" style="font-size:0.82rem; line-height:1.7;"></div>
          </div>
          <div style="flex:1; min-width:220px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEAR 52W LOW</div>
            <div id="report52wLow" style="font-size:0.82rem; line-height:1.7;"></div>
          </div>
        </div>
      </div>

      <!-- Top YOLO patterns at close -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Top AI Patterns at Close (YOLO)</div>
        <table id="reportYoloTopTable"></table>
      </div>

      <!-- Candle signals at close -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Candle Signals at Close</div>
        <table id="reportCandleTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label">Report History</div>
        <table id="reportHistoryTable"></table>
      </div>
      <div id="reportNoData" style="display:none; color:var(--muted); padding:20px 0;">
        No reports generated yet. Reports are written after the first daily cron run (22:00 UTC Mon–Fri).
      </div>
    </section>

    <section id="tabEarnings" class="panel hidden">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:1.1rem;">Earnings Calendar</h2>
        <span id="earningsStatus" style="font-size:0.8rem; color:var(--muted);"></span>
      </div>
      <div class="panel" style="margin-bottom:12px;">
        <div class="report-watch-wrap">
          <div class="field" style="min-width:140px;">
            <label for="earningsDays">Lookahead Days</label>
            <input id="earningsDays" type="number" min="1" max="90" step="1" value="21" />
          </div>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:8px; min-width:220px;">
            <input id="earningsWatchOnly" type="checkbox" style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Watchlist only</span>
          </label>
          <button id="loadEarningsBtn" type="button">Load</button>
          <div class="earnings-mode-toggle" role="tablist" aria-label="Earnings views">
            <button id="earningsCalendarModeBtn" type="button" class="active">Calendar View</button>
            <button id="earningsListModeBtn" type="button">List View</button>
          </div>
        </div>
        <div id="earningsSummary" class="report-inline-note" style="margin-top:8px;"></div>
      </div>
      <div id="earningsSummaryCards" class="cards" style="margin-bottom:14px;"></div>
      <div class="panel" id="earningsBoardWrap" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Calendar View</div>
        <div id="earningsBoard" class="earnings-board"></div>
      </div>
      <div class="panel" id="earningsDetailWrap" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Selected Catalyst</div>
        <div id="earningsDetail" class="earnings-detail"></div>
      </div>
      <div class="panel hidden" id="earningsTableWrap">
        <div class="label" style="margin-bottom:8px;">List View</div>
        <table id="earningsTable"></table>
      </div>
      <div id="earningsNoData" style="display:none; color:var(--muted); padding:20px 0;">
        No upcoming earnings found for the selected window.
      </div>
    </section>

    <section id="tabGuide" class="panel">
      <div class="guide">
        <div class="guide-callout">
          <div class="guide-callout-title">Not Financial Advice</div>
          <p style="margin:0;">This dashboard is for research only. Signals can be wrong, delayed, or incomplete. You are responsible for risk management and execution decisions.</p>
        </div>

        <h3>Quick Start (2 Minutes)</h3>
        <ol class="guide-list">
          <li>Start here. Read the risk note above so the dashboard is used as research support, not as a trading instruction.</li>
          <li>Open <b>Daily Report</b> after the nightly run completes.</li>
          <li>Review <b>Tonight's 5 Key Changes</b> first for the fast market summary.</li>
          <li>Check <b>YOLO Changes</b> for new patterns and patterns no longer detected.</li>
          <li>Use <b>Confluence Score</b> and <b>Sector Heatmap</b> to prioritize candidates.</li>
          <li>Click any ticker to jump into <b>Chart + Levels</b> and inspect structure.</li>
          <li>Use <b>Bollinger Bands</b> toggle when you want volatility context.</li>
          <li>Add names to <b>Watchlist</b> so you can revisit the same basket quickly.</li>
        </ol>

        <h3>What Each Tab Does</h3>
        <div class="guide-grid">
          <div class="guide-card">
            <div class="guide-k">Guide</div>
            <div class="guide-v">How to use the app, read signals, and avoid common mistakes.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Daily Report</div>
            <div class="guide-v">Nightly summary of what changed, strongest setups, market regime, and YOLO deltas.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Chart + Levels</div>
            <div class="guide-v">Per-ticker chart with support/resistance, gaps, trendlines, rule/hybrid overlays, candlestick signals, optional Bollinger Bands, and YOLO boxes.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Opportunities (PEG)</div>
            <div class="guide-v">Valuation screener for S&amp;P 500. Use it after report/chart review, not before.</div>
          </div>
        </div>

        <h3>Daily Report Read Order</h3>
        <ol class="guide-list">
          <li><b>Tonight's 5 Key Changes</b>: one-screen summary of what materially changed.</li>
          <li><b>Confluence Score</b>: start in compact view, then open <b>More Metrics</b> only when you need to audit volatility and aging inputs.</li>
          <li><b>Sector Heatmap</b>: identify leadership/laggards and rotation.</li>
          <li><b>YOLO Changes vs Previous Run</b>: actionable delta, not raw count noise.</li>
          <li><b>Large Moves + 52-week Extremes</b>: momentum continuation or exhaustion candidates.</li>
        </ol>

        <h3>Chart + Levels Workflow</h3>
        <ol class="guide-list">
          <li>Load ticker from report or search box.</li>
          <li>Mark location versus <b>primary/secondary support/resistance</b>.</li>
          <li>Check <b>open gaps</b> and <b>trendlines</b> for context.</li>
          <li>Enable <b>Rule/Hybrid Lines</b> and <b>YOLO Patterns</b> to compare machine + rule signals.</li>
          <li>Turn on <b>Bollinger Bands</b> if you want to gauge stretch/squeeze conditions.</li>
          <li>Decide only when multiple signals agree (structure + momentum + valuation).</li>
        </ol>

        <h3>Chart Toggles (How to Use)</h3>
        <ul class="guide-list">
          <li><b>Show Trendlines</b>: reveal support/resistance line geometry from recent pivots.</li>
          <li><b>Show Patterns</b>: display top pattern overlays detected by rule/hybrid logic.</li>
          <li><b>Rule/Hybrid Lines</b>: keep this on for primary pattern structure.</li>
          <li><b>Bollinger Bands</b>: optional volatility envelope (20, 2) around price.</li>
          <li><b>YOLO Patterns</b>: AI-detected pattern windows (daily + weekly labels).</li>
          <li><b>Bars D/W</b>: switch between daily and weekly candles for timeframe alignment.</li>
        </ul>

        <h3>Signal Glossary (Short)</h3>
        <details open>
          <summary>YOLO Patterns</summary>
          <ul class="guide-list">
            <li>Computer-vision detections on candlestick images (daily/weekly timeframe).</li>
            <li><b>x0_date/x1_date</b> define the detected pattern window.</li>
            <li><b>age_days</b> shows how old the pattern end-date is relative to run date.</li>
            <li>Use <b>YOLO Changes</b> to identify truly new or invalidated patterns.</li>
          </ul>
        </details>
        <details>
          <summary>Valuation Fields</summary>
          <ul class="guide-list">
            <li><b>Discount %</b>: upside/downside versus analyst target.</li>
            <li><b>PEG</b>: P/E adjusted for growth; lower can indicate better value for growth.</li>
            <li><b>Deep Value</b> preset is stricter than Undervalued.</li>
          </ul>
        </details>
        <details>
          <summary>Technical Structure</summary>
          <ul class="guide-list">
            <li><b>Support</b>: area where buyers previously stepped in.</li>
            <li><b>Resistance</b>: area where sellers previously stepped in.</li>
            <li><b>Gaps</b>: unfilled zones often retested later.</li>
          </ul>
        </details>

        <h3>Run Schedule</h3>
        <ul class="guide-list">
          <li>Daily pipeline: weekdays at <b>22:00 UTC</b> (ingest → YOLO → report).</li>
          <li>Weekly YOLO pass: Saturday (regenerates report after run).</li>
          <li>Report tab always shows the latest completed run; no manual refresh button is required.</li>
        </ul>

        <h3>Common Mistakes</h3>
        <ul class="guide-list">
          <li>Trading one signal in isolation.</li>
          <li>Ignoring timeframe mismatch (weekly pattern vs short-term trade horizon).</li>
          <li>Treating old patterns as fresh without checking <b>age_days</b>.</li>
          <li>Ignoring liquidity/volume when evaluating breakouts.</li>
        </ul>

        <div style="margin-top:14px; padding:10px 14px; border-top:1px solid var(--line); color:var(--muted); font-size:0.82rem;">
          trader_koo uses public market data and may contain delays or gaps. Past performance is not indicative of future results.
        </div>
      </div>
    </section>
  </div>
  <footer class="site-footnote">
    <strong>Not Financial Advice.</strong> trader_koo is a research dashboard only. Market data and model outputs may be delayed, incomplete, or incorrect. Any investment decision and risk taken is solely your responsibility.
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const tabOpBtn = $("tabOpBtn");
    const tabChartBtn = $("tabChartBtn");
    const tabGuideBtn = $("tabGuideBtn");
    const tabReportBtn = $("tabReportBtn");
    const tabEarningsBtn = $("tabEarningsBtn");
    const tabOp = $("tabOp");
    const tabChart = $("tabChart");
    const tabGuide = $("tabGuide");
    const tabReport = $("tabReport");
    const tabEarnings = $("tabEarnings");
    const API_BASE_STORAGE_KEY = "trader_koo_api_base";
    const WATCHLIST_STORAGE_KEY = "trader_koo_watchlist";
    const TABLE_STATE = {};
    const DEFAULT_MONTHS = 3;
    let LAST_CHART_PAYLOAD = null;
    let LAST_REPORT_SETUP_ROWS = [];
    let REPORT_SETUP_SHOW_MORE = false;
    let CHART_TIMEFRAME = "daily"; // "daily" | "weekly"
    let EARNINGS_VIEW_MODE = "calendar";
    let LAST_EARNINGS_ROWS = [];
    let LAST_EARNINGS_LOOKUP = {};
    let LAST_EARNINGS_SELECTED = "";

    function fmt(v, d = 2) {
      if (v === null || v === undefined || v === "" || Number.isNaN(Number(v))) return "-";
      return Number(v).toFixed(d);
    }

    function escHtml(v) {
      return String(v ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    const PERCENT_COLUMNS = new Set([
      "discount_pct",
      "eps_growth_5y",
      "atr_pct",
      "atr_pct_14",
      "realized_vol_20",
      "bb_width_20",
      "pct_change",
      "pct_advancing",
      "pct_from_high",
      "pct_from_low",
    ]);
    const DECIMAL_BY_COLUMN = {
      price: 2,
      pe: 2,
      peg: 2,
      target_price: 2,
      discount_pct: 2,
      eps_growth_5y: 2,
      level: 2,
      zone_low: 2,
      zone_high: 2,
      gap_low: 2,
      gap_high: 2,
      score: 2,
      touches: 0,
      touch_count: 0,
      contracts: 0,
      call_oi: 0,
      put_oi: 0,
    };

    function fmtPctText(raw, digits = 2) {
      const n = Number(raw);
      if (!Number.isFinite(n)) return "-";
      return `${n.toFixed(digits)}%`;
    }

    function buildSetupReason(row) {
      const reasons = [];
      const discount = Number(row.discount_pct);
      const peg = Number(row.peg);
      const move = Number(row.pct_change);
      const yoloConf = Number(row.yolo_confidence);
      const yoloPattern = String(row.yolo_pattern || "").trim();
      const age = Number(row.yolo_age_days);
      const rv20 = Number(row.realized_vol_20);

      if (Number.isFinite(discount)) {
        if (discount >= 25) reasons.push("deep discount");
        else if (discount >= 15) reasons.push("discounted");
      }
      if (Number.isFinite(peg)) {
        if (peg <= 0.8) reasons.push("low PEG");
        else if (peg <= 1.2) reasons.push("reasonable PEG");
      }
      if (Number.isFinite(move)) {
        if (move >= 3) reasons.push("strong up day");
        else if (move <= -3) reasons.push("washout move");
        else if (Math.abs(move) >= 1.5) reasons.push("meaningful move");
      }
      if (yoloPattern) {
        if (Number.isFinite(age) && age > 45) reasons.push(`old YOLO context: ${yoloPattern}`);
        else {
          const label = yoloConf >= 0.75 ? "strong YOLO" : "YOLO signal";
          reasons.push(`${label}: ${yoloPattern}`);
        }
      }
      if (Number.isFinite(age) && age <= 10) reasons.push("fresh pattern");
      else if (Number.isFinite(age) && age > 45) reasons.push("pattern already aged");
      if (Number.isFinite(rv20)) {
        if (rv20 <= 30) reasons.push("contained vol");
        else if (rv20 >= 55) reasons.push("high vol");
      }
      return reasons.slice(0, 3).join(" • ") || "balanced multi-factor setup";
    }

    function buildCompactSetupRows(rows) {
      return (rows || []).map((row) => ({
        ticker: row.ticker,
        score: row.score,
        setup_tier: row.setup_tier,
        why_high: row.observation || buildSetupReason(row),
        action: row.action || "Watch only until the setup confirms.",
        pct_change: row.pct_change,
        technical_read: row.technical_read || "-",
      }));
    }

    function setReportSetupMode(showMore) {
      REPORT_SETUP_SHOW_MORE = !!showMore;
      const compactBtn = $("reportSetupCompactBtn");
      const moreBtn = $("reportSetupMoreBtn");
      const detailWrap = $("reportSetupDetailWrap");
      if (compactBtn) {
        compactBtn.classList.toggle("active", !REPORT_SETUP_SHOW_MORE);
        compactBtn.setAttribute("aria-pressed", String(!REPORT_SETUP_SHOW_MORE));
      }
      if (moreBtn) {
        moreBtn.classList.toggle("active", REPORT_SETUP_SHOW_MORE);
        moreBtn.setAttribute("aria-pressed", String(REPORT_SETUP_SHOW_MORE));
      }
      if (detailWrap) {
        detailWrap.classList.toggle("hidden", !REPORT_SETUP_SHOW_MORE);
      }
    }

    function formatTableValue(col, raw) {
      if (raw === null || raw === undefined || raw === "") return "-";
      if (typeof raw === "string" && /^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
      const n = Number(raw);
      if (!Number.isFinite(n)) return String(raw);

      if (PERCENT_COLUMNS.has(col)) {
        let v = n;
        if (col === "eps_growth_5y" && Math.abs(v) <= 2) v *= 100;
        return `${v.toFixed(DECIMAL_BY_COLUMN[col] ?? 2)}%`;
      }

      const d = DECIMAL_BY_COLUMN[col] ?? 2;
      return n.toLocaleString(undefined, {
        minimumFractionDigits: d,
        maximumFractionDigits: d,
      });
    }

    function renderOpFilterHelp(help) {
      const el = $("opFilterHelp");
      if (!el) return;
      if (!help) {
        el.innerHTML = `<div class="op-help-title">Filter Guide</div><div class="status-plain">Use presets, then refine using the fields.</div>`;
        return;
      }
      const rows = [
        ["View", help.view],
        ["Min Discount %", help.min_discount],
        ["Max PEG", help.max_peg],
        ["Overvalued Threshold %", help.overvalued_threshold],
      ];
      el.innerHTML = `
        <div class="op-help-title">Filter Guide</div>
        <div class="op-help-grid">
          ${rows.map(([k, v]) => `<div class="op-help-key">${escHtml(k)}</div><div class="op-help-val">${escHtml(v)}</div>`).join("")}
        </div>
      `;
    }

    function renderOpStatus(payload, view, rowCount) {
      const el = $("opStatus");
      if (!el) return;
      const snapRaw = payload.snapshot_ts || "";
      const snapDate = snapRaw ? new Date(snapRaw) : null;
      const hasSnap = snapDate && !Number.isNaN(snapDate.getTime());
      const snapUtc = hasSnap
        ? snapDate.toISOString().slice(0, 16).replace("T", " ") + " UTC"
        : (snapRaw || "-");
      const snapLocal = hasSnap
        ? snapDate.toLocaleString(undefined, {
            year: "numeric",
            month: "short",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
            timeZoneName: "short",
          })
        : "-";
      const sc = payload.source_counts || {};
      const chips = [
        ["Snapshot (UTC)", snapUtc],
        ["Local Time", snapLocal],
        ["View", view],
        ["Shown", rowCount ?? 0],
        ["Eligible", payload.eligible_count ?? "-"],
        ["Universe", payload.universe_count ?? "-"],
        ["Analyst", sc.analyst_target ?? 0],
        ["Model", sc.model_eps_pe ?? 0],
        ["Other", sc.other ?? 0],
      ];
      el.innerHTML = chips
        .map(([k, v]) => `<span class="status-chip"><span class="k">${escHtml(k)}</span><span class="v">${escHtml(v)}</span></span>`)
        .join("");
    }

    function normalizeBase(base) {
      return String(base || "").trim().replace(/\/+$/, "");
    }

    function getApiBase() {
      return normalizeBase($("apiBase").value);
    }

    function apiFetch(url, opts = {}) {
      const credentials = opts.credentials || "include";
      return fetch(url, { ...opts, credentials });
    }

    function setApiBase(base, persist = true) {
      const clean = normalizeBase(base);
      $("apiBase").value = clean;
      if (persist && clean) localStorage.setItem(API_BASE_STORAGE_KEY, clean);
    }

    function buildApiCandidates() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = normalizeBase(params.get("api"));
      const fromStorage = normalizeBase(localStorage.getItem(API_BASE_STORAGE_KEY));
      const fromInput = normalizeBase($("apiBase").value);
      const isHttp = window.location.protocol === "http:" || window.location.protocol === "https:";
      const sameOrigin = isHttp ? normalizeBase(window.location.origin) : "";
      const host = window.location.hostname || "127.0.0.1";
      const host8000 = `http://${host}:8000`;
      const defaults = ["http://127.0.0.1:8000", "http://localhost:8000"];
      const candidates = [fromInput, fromQuery, fromStorage, sameOrigin, host8000, ...defaults].filter(Boolean);
      return [...new Set(candidates)];
    }

    async function probeApi(base, timeoutMs = 1200) {
      try {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        const resp = await fetch(`${base}/api/health`, { signal: controller.signal });
        clearTimeout(timer);
        return resp.ok;
      } catch {
        return false;
      }
    }

    async function initApiBase() {
      const candidates = buildApiCandidates();
      for (const c of candidates) {
        if (await probeApi(c)) {
          setApiBase(c, true);
          return;
        }
      }
      setApiBase(candidates[0] || "http://127.0.0.1:8000", true);
    }

    function setGlobalStatus(s) { $("globalStatus").textContent = s; }
    function setServiceStatus(s, bad = false) {
      const el = $("serviceStatus");
      el.textContent = s;
      el.style.color = bad ? "#ff8a8a" : "#8ea0bd";
    }

    async function refreshServiceStatus() {
      if (document.visibilityState === "hidden") return;
      const base = getApiBase();
      if (!base) {
        setServiceStatus("Service status: missing API base", true);
        return;
      }
      try {
        const resp = await apiFetch(`${base}/api/status`);
        if (!resp.ok) throw new Error(`${resp.status}`);
        const payload = await resp.json();
        const run = payload.latest_run || {};
        const pipe = payload.pipeline || {};
        const processed = run.tickers_processed ?? null;
        const total = run.tickers_total ?? null;
        const progress = (processed !== null && total !== null) ? `${processed}/${total}` : null;
        const txt = [
          `Connected`,
          `run=${run.status || "n/a"}`,
          `stage=${pipe.stage || payload.pipeline_stage || "n/a"}`,
          progress ? `progress=${progress}` : null,
          `tickers=${payload.counts?.tracked_tickers ?? "-"}`,
          `price_age=${payload.freshness?.price_age_days ?? "-"}d`
        ].filter(Boolean).join(" • ");
        setServiceStatus(txt, false);
      } catch (err) {
        setServiceStatus(`Offline (${err.message})`, true);
      }
    }

    function activateTab(which) {
      const all = {
        op: [tabOpBtn, tabOp],
        chart: [tabChartBtn, tabChart],
        guide: [tabGuideBtn, tabGuide],
        report: [tabReportBtn, tabReport],
        earnings: [tabEarningsBtn, tabEarnings],
      };
      for (const [k, [btn, sec]] of Object.entries(all)) {
        if (k === which) { btn.classList.add("active"); sec.classList.remove("hidden"); }
        else             { btn.classList.remove("active"); sec.classList.add("hidden"); }
      }
      if (which === "report") loadReport();
      if (which === "earnings") loadEarnings();
    }

    tabOpBtn.addEventListener("click", () => activateTab("op"));
    tabChartBtn.addEventListener("click", () => activateTab("chart"));
    tabGuideBtn.addEventListener("click", () => activateTab("guide"));
    tabReportBtn.addEventListener("click", () => activateTab("report"));
    tabEarningsBtn.addEventListener("click", () => activateTab("earnings"));

    function fillCards(payload) {
      const f = payload.fundamentals || {};
      const o = payload.options_summary || {};
      $("c-price").textContent = fmt(f.price);
      $("c-pe").textContent = fmt(f.pe);
      $("c-peg").textContent = fmt(f.peg);
      $("c-target").textContent = fmt(f.target_price);
      $("c-discount").textContent = fmt(f.discount_pct);
      $("c-pcr").textContent = fmt(o.put_call_oi_ratio, 3);
    }

    function renderSimpleTable(elId, columns, rows, clickable = false, onClick = null, opts = {}) {
      const state = TABLE_STATE[elId] || { sortCol: null, sortAsc: false };
      TABLE_STATE[elId] = state;
      const el = $(elId);
      const colDefs = columns.map((col) => (
        typeof col === "string"
          ? { key: col, label: col }
          : { key: col.key, label: col.label || col.key }
      ));
      let viewRows = [...rows];
      const searchId = opts.searchInputId || "";
      if (searchId && $(searchId)) {
        const q = String($(searchId).value || "").trim().toLowerCase();
        if (q) {
          viewRows = viewRows.filter((r) =>
            colDefs.some(({ key }) => String(r[key] ?? "").toLowerCase().includes(q))
          );
        }
      }

      if (opts.sortable && state.sortCol) {
        const col = state.sortCol;
        const dir = state.sortAsc ? 1 : -1;
        viewRows.sort((a, b) => {
          const av = a[col], bv = b[col];
          const an = Number(av), bn = Number(bv);
          if (Number.isFinite(an) && Number.isFinite(bn)) return (an - bn) * dir;
          return String(av ?? "").localeCompare(String(bv ?? "")) * dir;
        });
      }

      const head = `<tr>${colDefs.map(({ key, label }) => {
        if (!opts.sortable) return `<th>${label}</th>`;
        const marker = state.sortCol === key ? (state.sortAsc ? " ▲" : " ▼") : "";
        return `<th data-sort-col="${key}" style="cursor:pointer;">${label}${marker}</th>`;
      }).join("")}</tr>`;

      const body = viewRows.length
        ? viewRows.map((r, idx) => {
            const cls = clickable ? "clickable" : "";
            return `<tr class="${cls}" data-idx="${idx}">${colDefs.map(({ key }) => `<td>${formatTableValue(key, r[key])}</td>`).join("")}</tr>`;
          }).join("")
        : `<tr><td colspan="${colDefs.length}">No data</td></tr>`;
      el.innerHTML = head + body;

      if (opts.sortable) {
        el.querySelectorAll("th[data-sort-col]").forEach((th) => {
          th.addEventListener("click", () => {
            const c = th.getAttribute("data-sort-col");
            if (!c) return;
            if (state.sortCol === c) state.sortAsc = !state.sortAsc;
            else {
              state.sortCol = c;
              state.sortAsc = true;
            }
            renderSimpleTable(elId, columns, rows, clickable, onClick, opts);
          });
        });
      }

      if (searchId && $(searchId)) {
        $(searchId).oninput = () => renderSimpleTable(elId, columns, rows, clickable, onClick, opts);
      }

      if (clickable && onClick) {
        el.querySelectorAll("tr.clickable").forEach((tr) => {
          tr.addEventListener("click", () => {
            const idx = Number(tr.getAttribute("data-idx"));
            onClick(viewRows[idx]);
          });
        });
      }
    }

    function setEarningsViewMode(mode) {
      EARNINGS_VIEW_MODE = mode === "list" ? "list" : "calendar";
      const calendarActive = EARNINGS_VIEW_MODE === "calendar";
      $("earningsCalendarModeBtn").classList.toggle("active", calendarActive);
      $("earningsListModeBtn").classList.toggle("active", !calendarActive);
      $("earningsBoardWrap").classList.toggle("hidden", !calendarActive);
      $("earningsTableWrap").classList.toggle("hidden", calendarActive);
    }

    function earningsToneClass(value) {
      const raw = String(value || "").trim().toLowerCase();
      if ([
        "bullish", "bearish", "high", "elevated", "normal",
        "setup_ready", "watch", "calendar_only",
        "confirmed", "date_only", "snapshot", "unverified"
      ].includes(raw)) return raw;
      return "";
    }

    function formatEarningsProvider(value) {
      const raw = String(value || "").trim().toLowerCase();
      if (raw === "alpha_vantage") return "Alpha Vantage";
      if (raw === "fundamentals_snapshot") return "Snapshot Fallback";
      return value || "—";
    }

    function formatRecommendationState(value) {
      const raw = String(value || "").trim().toLowerCase();
      if (raw === "setup_ready") return "Setup Ready";
      if (raw === "watch") return "Watch";
      if (raw === "calendar_only") return "Calendar Only";
      return value || "—";
    }

    function formatScheduleQuality(value) {
      const raw = String(value || "").trim().toLowerCase();
      if (raw === "confirmed") return "Confirmed";
      if (raw === "date_only") return "Date Only";
      if (raw === "snapshot") return "Snapshot";
      if (raw === "unverified") return "Unverified";
      return value || "—";
    }

    function earningsCardSummary(row) {
      const state = String(row && row.recommendation_state || "").trim().toLowerCase();
      if (state === "setup_ready") {
        return `${formatRecommendationState(row.recommendation_state)} • ${row.setup_family ? String(row.setup_family).replaceAll("_", " ") : "aligned"} • ${formatScheduleQuality(row.schedule_quality)}`;
      }
      if (state === "watch") {
        return `${formatRecommendationState(row.recommendation_state)} • ${row.recommendation_note || "Needs chart confirmation before acting."}`;
      }
      return `${formatRecommendationState(row.recommendation_state)} • ${row.schedule_note || "Verify timing before treating this as a setup."}`;
    }

    function earningsRowKey(row) {
      return [row && row.earnings_date, row && row.earnings_session, row && row.ticker].join("|");
    }

    function renderEarningsDetail(row) {
      const detail = $("earningsDetail");
      if (!row) {
        detail.innerHTML = `<div class="earnings-lane-empty">Select a catalyst card to inspect the setup, action, and risk before opening the chart.</div>`;
        return;
      }
      detail.innerHTML = `
        <div class="earnings-detail-head">
          <div>
            <div class="earnings-detail-title">${escHtml(row.ticker || "-")} • ${escHtml(row.earnings_date || "-")} ${escHtml(String(row.earnings_session || "TBD").toUpperCase())}</div>
            <div class="earnings-detail-subtitle">${escHtml(row.sector || "Unknown")} • ${row.score != null ? `Score ${fmt(row.score)}` : "Unscored"} • ${escHtml(`${row.days_until ?? "-"} day(s) to earnings`)} • ${escHtml(formatRecommendationState(row.recommendation_state))}</div>
          </div>
          <div class="mini-actions" style="margin-top:0;">
            <button type="button" id="earningsOpenChartBtn">Open Chart</button>
          </div>
        </div>
        <div class="earnings-badges">
          <span class="earnings-badge ${earningsToneClass(row.recommendation_state)}">${escHtml(formatRecommendationState(row.recommendation_state).toUpperCase())}</span>
          <span class="earnings-badge ${earningsToneClass(row.schedule_quality)}">${escHtml(formatScheduleQuality(row.schedule_quality).toUpperCase())}</span>
          <span class="earnings-badge ${earningsToneClass(row.signal_bias)}">${escHtml(String(row.signal_bias || "neutral").toUpperCase())}</span>
          <span class="earnings-badge ${earningsToneClass(row.earnings_risk)}">${escHtml(String(row.earnings_risk || "normal").toUpperCase())}</span>
          ${row.yolo_pattern ? `<span class="earnings-badge">${escHtml(String(row.yolo_pattern))}</span>` : ""}
          ${row.actionability ? `<span class="earnings-badge">${escHtml(String(row.actionability).toUpperCase())}</span>` : ""}
        </div>
        <div class="earnings-detail-grid">
          <div class="earnings-detail-block">
            <div class="label">Catalyst State</div>
            <div class="earnings-detail-copy">${escHtml(row.recommendation_note || row.schedule_note || "Review timing and chart confirmation before acting.")}</div>
          </div>
          <div class="earnings-detail-block">
            <div class="label">Observation</div>
            <div class="earnings-detail-copy">${escHtml(row.observation || "Upcoming earnings catalyst; refresh the chart and levels before acting.")}</div>
          </div>
          <div class="earnings-detail-block">
            <div class="label">Reasonable Action</div>
            <div class="earnings-detail-copy">${escHtml(row.action || "Watch into the event window. Do not force a chase ahead of the print.")}</div>
          </div>
          <div class="earnings-detail-block">
            <div class="label">Technical Read</div>
            <div class="earnings-detail-copy">${escHtml(row.technical_read || "Review chart structure, support/resistance, and event risk together before acting.")}</div>
          </div>
          <div class="earnings-detail-block">
            <div class="label">Risk Note</div>
            <div class="earnings-detail-copy">${escHtml(row.risk_note || row.earnings_risk_note || "Earnings can gap through levels; size accordingly.")}</div>
          </div>
        </div>
      `;
      const btn = $("earningsOpenChartBtn");
      if (btn) btn.addEventListener("click", () => row.ticker ? loadTickerQuick(row.ticker) : null);
    }

    function renderEarningsBoard(groups) {
      const board = $("earningsBoard");
      const dayGroups = Array.isArray(groups) ? groups : [];
      if (!dayGroups.length) {
        board.innerHTML = `<div class="earnings-day"><div class="earnings-lane-empty">No upcoming earnings found for the selected window.</div></div>`;
        renderEarningsDetail(null);
        return;
      }
      board.innerHTML = dayGroups.map((group) => {
        const sessions = Array.isArray(group.sessions) ? group.sessions : [];
        const populatedSessions = sessions.filter((session) => Array.isArray(session.rows) && session.rows.length);
        const activeSessions = populatedSessions.length ? populatedSessions : sessions;
        const lanes = activeSessions.map((session) => {
          const rows = Array.isArray(session.rows) ? session.rows : [];
          const body = rows.length
            ? rows.slice(0, 8).map((row) => {
                const key = earningsRowKey(row);
                const active = key === LAST_EARNINGS_SELECTED ? ' active' : '';
                return `
                <button type="button" class="earnings-card${active}" data-earnings-key="${escHtml(key)}">
                  <div class="earnings-card-head">
                    <div class="earnings-card-ticker">${escHtml(row.ticker || "-")}</div>
                    <div class="earnings-score">${row.score != null ? `${escHtml(String(row.setup_tier || "—"))} • ${fmt(row.score)}` : "Unscored"}</div>
                  </div>
                  <div class="earnings-badges">
                    <span class="earnings-badge ${earningsToneClass(row.recommendation_state)}">${escHtml(formatRecommendationState(row.recommendation_state).toUpperCase())}</span>
                    <span class="earnings-badge ${earningsToneClass(row.schedule_quality)}">${escHtml(formatScheduleQuality(row.schedule_quality).toUpperCase())}</span>
                    <span class="earnings-badge ${earningsToneClass(row.signal_bias)}">${escHtml(String(row.signal_bias || "neutral").toUpperCase())}</span>
                    <span class="earnings-badge ${earningsToneClass(row.earnings_risk)}">${escHtml(String(row.earnings_risk || "normal").toUpperCase())}</span>
                    <span class="earnings-badge">${escHtml(`${row.days_until ?? "-"}d`)}</span>
                  </div>
                  <div class="earnings-card-sub">
                    ${escHtml(earningsCardSummary(row))}
                  </div>
                </button>
              `}).join("")
            : `<div class="earnings-lane-empty">No names in this session.</div>`;
          return `
            <div class="earnings-lane">
              <div class="earnings-lane-head">
                <div class="earnings-lane-title">${escHtml(session.label || session.code || "TBD")}</div>
                <div class="earnings-lane-count">${escHtml(`${session.count ?? rows.length} name(s)`)}</div>
              </div>
              ${body}
            </div>
          `;
        }).join("");
        return `
          <div class="earnings-day">
            <h3>${escHtml(group.display_date || group.date || "-")}</h3>
            <div class="earnings-day-sub">${escHtml(`${group.count ?? 0} event(s)`)}</div>
            <div class="earnings-lanes">${lanes}</div>
          </div>
        `;
      }).join("");
      board.querySelectorAll(".earnings-card[data-earnings-key]").forEach((node) => {
        node.addEventListener("click", () => {
          const key = node.getAttribute("data-earnings-key") || "";
          const row = LAST_EARNINGS_LOOKUP[key];
          LAST_EARNINGS_SELECTED = key;
          renderEarningsBoard(dayGroups);
          renderEarningsDetail(row || null);
        });
      });
    }

    function computeYRangeForXWindow(x, low, high, x0, x1) {
      if (!x.length) return null;
      const t0 = x0 ? new Date(x0).getTime() : -Infinity;
      const t1 = x1 ? new Date(x1).getTime() : Infinity;
      let minY = Number.POSITIVE_INFINITY;
      let maxY = Number.NEGATIVE_INFINITY;
      for (let i = 0; i < x.length; i++) {
        const t = new Date(x[i]).getTime();
        if (Number.isNaN(t) || t < t0 || t > t1) continue;
        const lo = Number(low[i]);
        const hi = Number(high[i]);
        if (Number.isFinite(lo)) minY = Math.min(minY, lo);
        if (Number.isFinite(hi)) maxY = Math.max(maxY, hi);
      }
      if (!Number.isFinite(minY) || !Number.isFinite(maxY)) {
        const allLow = low.filter(Number.isFinite);
        const allHigh = high.filter(Number.isFinite);
        if (!allLow.length || !allHigh.length) return null;
        minY = Math.min(...allLow);
        maxY = Math.max(...allHigh);
      }
      const span = Math.max(maxY - minY, Math.abs(maxY) * 0.01, 1e-6);
      const pad = span * 0.08;
      return [minY - pad, maxY + pad];
    }

    function extendYRangeWithLevelValues(range, levelValues) {
      if (!range || !Array.isArray(range) || range.length !== 2) return range;
      const baseLo = Number(range[0]);
      const baseHi = Number(range[1]);
      if (!Number.isFinite(baseLo) || !Number.isFinite(baseHi)) return range;
      const span = Math.max(baseHi - baseLo, Math.abs(baseHi) * 0.01, 1e-6);
      const nearLo = baseLo - span * 0.35;
      const nearHi = baseHi + span * 0.35;

      let lo = baseLo;
      let hi = baseHi;
      for (const vRaw of (levelValues || [])) {
        const v = Number(vRaw);
        if (!Number.isFinite(v)) continue;
        if (v < nearLo || v > nearHi) continue;
        lo = Math.min(lo, v);
        hi = Math.max(hi, v);
      }
      const newSpan = Math.max(hi - lo, Math.abs(hi) * 0.01, 1e-6);
      const pad = newSpan * 0.08;
      return [lo - pad, hi + pad];
    }

    function resampleToWeekly(chart) {
      // ISO week key → use last trading day of that week as the bar date
      const isoWeek = (ds) => {
        const d = new Date(ds + "T12:00:00Z");
        const day = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - day); // Thursday anchor
        const yr = d.getUTCFullYear();
        const jan4 = new Date(Date.UTC(yr, 0, 4));
        const wk = Math.ceil(((d - jan4) / 864e5 + (jan4.getUTCDay() || 7)) / 7);
        return `${yr}-${String(wk).padStart(2, "0")}`;
      };
      const weeks = new Map();
      for (const row of chart) {
        const key = isoWeek(row.date);
        if (!weeks.has(key)) {
          weeks.set(key, { date: row.date, open: Number(row.open), high: Number(row.high), low: Number(row.low), close: Number(row.close), volume: Number(row.volume) || 0 });
        } else {
          const w = weeks.get(key);
          w.high = Math.max(w.high, Number(row.high));
          w.low  = Math.min(w.low,  Number(row.low));
          w.close = Number(row.close);
          w.date  = row.date; // last trading day of the week
          w.volume += Number(row.volume) || 0;
        }
      }
      return Array.from(weeks.values()).sort((a, b) => String(a.date).localeCompare(String(b.date)));
    }

    function buildMissingWeekdayRangebreakValues(dateList) {
      const unique = Array.from(new Set((dateList || []).map((d) => String(d || "").slice(0, 10)).filter(Boolean))).sort();
      if (!unique.length) return [];

      const seen = new Set(unique);
      const missing = [];
      const cur = new Date(`${unique[0]}T12:00:00Z`);
      const end = new Date(`${unique[unique.length - 1]}T12:00:00Z`);
      if (Number.isNaN(cur.getTime()) || Number.isNaN(end.getTime())) return [];

      while (cur <= end) {
        const dow = cur.getUTCDay();
        if (dow !== 0 && dow !== 6) {
          const y = cur.getUTCFullYear();
          const m = String(cur.getUTCMonth() + 1).padStart(2, "0");
          const d = String(cur.getUTCDate()).padStart(2, "0");
          const key = `${y}-${m}-${d}`;
          if (!seen.has(key)) missing.push(key);
        }
        cur.setUTCDate(cur.getUTCDate() + 1);
      }
      return missing;
    }

    function renderChart(payload) {
      LAST_CHART_PAYLOAD = payload;
      const isWeeklyChart = CHART_TIMEFRAME === "weekly";
      const rawChart = payload.chart || [];
      const chart = isWeeklyChart ? resampleToWeekly(rawChart) : rawChart;
      const levels = payload.levels || [];
      const gaps = payload.gaps || [];
      const trendlines = payload.trendlines || [];
      const patterns = payload.patterns || [];
      const patternOverlays = payload.pattern_overlays || [];
      const yoloPatterns = payload.yolo_patterns || [];
      const earningsMarkers = payload.earnings_markers || [];
      const ticker = payload.ticker || "N/A";
      const showTrendlines = $("showTrendlines") ? Boolean($("showTrendlines").checked) : false;
      const showPatterns = $("showPatterns") ? Boolean($("showPatterns").checked) : true;
      const showRuleClassLines = $("showRuleClassLines") ? Boolean($("showRuleClassLines").checked) : true;
      const showBollinger = $("showBollinger") ? Boolean($("showBollinger").checked) : false;
      const showYoloPatterns = $("showYoloPatterns") ? Boolean($("showYoloPatterns").checked) : true;

      const x = chart.map(r => r.date);
      const open = chart.map(r => Number(r.open));
      const high = chart.map(r => Number(r.high));
      const low = chart.map(r => Number(r.low));
      const close = chart.map(r => Number(r.close));
      const vol = chart.map(r => Number(r.volume || 0));
      const volColor = chart.map(r => Number(r.close) >= Number(r.open) ? "rgba(56,211,159,0.7)" : "rgba(255,107,107,0.7)");
      const missingWeekdayBreaks = isWeeklyChart ? [] : buildMissingWeekdayRangebreakValues(x);

      const ma = (arr, n) => arr.map((_, i) => {
        if (i < n - 1) return null;
        let s = 0;
        for (let j = i - n + 1; j <= i; j++) s += arr[j];
        return s / n;
      });
      const bollinger = (arr, n = 20, k = 2) => {
        const upper = new Array(arr.length).fill(null);
        const lower = new Array(arr.length).fill(null);
        for (let i = n - 1; i < arr.length; i++) {
          let sum = 0;
          for (let j = i - n + 1; j <= i; j++) sum += arr[j];
          const mean = sum / n;
          let varSum = 0;
          for (let j = i - n + 1; j <= i; j++) {
            const d = arr[j] - mean;
            varSum += d * d;
          }
          const std = Math.sqrt(varSum / n);
          upper[i] = mean + k * std;
          lower[i] = mean - k * std;
        }
        return { upper, lower };
      };

      const traces = [
        {
          type: "candlestick",
          x, open, high, low, close,
          name: ticker, xaxis: "x", yaxis: "y",
          increasing: {line: {color: "#38d39f"}, fillcolor: "rgba(56,211,159,0.85)"},
          decreasing: {line: {color: "#ff6b6b"}, fillcolor: "rgba(255,107,107,0.85)"}
        },
        { type: "scatter", mode: "lines", x, y: ma(close, 20), name: "MA20", line: {color:"#6aa9ff", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 50), name: "MA50", line: {color:"#f8c24e", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 100), name: "MA100", line: {color:"#38d39f", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 200), name: "MA200", line: {color:"#c07bff", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "bar", x, y: vol, name: "Volume", marker: {color: volColor}, xaxis:"x2", yaxis:"y2" }
      ];
      if (showBollinger) {
        const bb = bollinger(close, 20, 2);
        traces.push({
          type: "scatter",
          mode: "lines",
          x,
          y: bb.upper,
          name: "BB Upper (20,2)",
          line: { color: "rgba(106,169,255,0.75)", width: 1.1, dash: "dot" },
          xaxis: "x",
          yaxis: "y",
        });
        traces.push({
          type: "scatter",
          mode: "lines",
          x,
          y: bb.lower,
          name: "BB Lower (20,2)",
          line: { color: "rgba(106,169,255,0.75)", width: 1.1, dash: "dot" },
          fill: "tonexty",
          fillcolor: "rgba(106,169,255,0.08)",
          xaxis: "x",
          yaxis: "y",
        });
      }

      const candlePatterns = payload.candlestick_patterns || [];
      if (candlePatterns.length > 0) {
        const bullish = candlePatterns.filter(p => String(p.bias || "").toLowerCase() === "bullish");
        const bearish = candlePatterns.filter(p => String(p.bias || "").toLowerCase() === "bearish");
        if (bullish.length > 0) {
          traces.push({
            type: "scatter", mode: "markers",
            x: bullish.map(p => p.date),
            y: bullish.map(p => { const i = x.indexOf(p.date); return i >= 0 ? low[i] * 0.994 : null; }),
            name: "Bullish Signal",
            marker: {symbol: "triangle-up", size: 9, color: "#38d39f"},
            hovertext: bullish.map(p => `${p.pattern} (${fmt(p.confidence)})`),
            hoverinfo: "text+x", xaxis: "x", yaxis: "y"
          });
        }
        if (bearish.length > 0) {
          traces.push({
            type: "scatter", mode: "markers",
            x: bearish.map(p => p.date),
            y: bearish.map(p => { const i = x.indexOf(p.date); return i >= 0 ? high[i] * 1.006 : null; }),
            name: "Bearish Signal",
            marker: {symbol: "triangle-down", size: 9, color: "#ff6b6b"},
            hovertext: bearish.map(p => `${p.pattern} (${fmt(p.confidence)})`),
            hoverinfo: "text+x", xaxis: "x", yaxis: "y"
          });
        }
      }

      const lastDate = x.length ? x[x.length - 1] : null;
      const selectedMonths = DEFAULT_MONTHS; // default view window; use rangeselector to zoom
      const defaultX0 = (() => {
        if (!lastDate) return null;
        if (selectedMonths <= 0) return x.length ? x[0] : null;
        const d = new Date(lastDate);
        d.setMonth(d.getMonth() - selectedMonths);
        return d.toISOString().slice(0, 10);
      })();
      const defaultX1 = lastDate || null;
      const levelValues = levels.map((r) => Number(r.level)).filter(Number.isFinite);
      const baseDefaultY = computeYRangeForXWindow(x, low, high, defaultX0, defaultX1);
      const defaultY = extendYRangeWithLevelValues(baseDefaultY, levelValues);

      const isMobile = window.innerWidth < 640;
      const shapes = [];
      const annotations = [];

      levels.forEach(r => {
        const lvl = Number(r.level);
        if (Number.isNaN(lvl)) return;
        const color = r.type === "support" ? "#3f8cff" : "#ff7b5b";
        const tier = (r.tier || "primary").toLowerCase();
        const dash = tier === "primary" ? "solid" : (tier === "secondary" ? "dot" : "dash");
        const width = tier === "primary" ? 2 : (tier === "secondary" ? 1 : 1.5);
        const tierLabel = tier === "primary" ? "PRIMARY" : (tier === "secondary" ? "SECONDARY" : "FALLBACK");
        const z0 = Number(r.zone_low);
        const z1 = Number(r.zone_high);
        if (!Number.isNaN(z0) && !Number.isNaN(z1)) {
          shapes.push({
            type: "rect", xref: "paper", yref: "y",
            x0: 0, x1: 1, y0: Math.min(z0, z1), y1: Math.max(z0, z1),
            fillcolor: r.type === "support" ? "rgba(63,140,255,0.10)" : "rgba(255,123,91,0.10)",
            line: {width: 0}
          });
        }
        shapes.push({
          type: "line", xref: "paper", yref: "y",
          x0: 0, x1: 1, y0: lvl, y1: lvl,
          line: {color, width, dash}
        });
        annotations.push({
          xref: "paper", yref: "y", x: 1.0, y: lvl,
          text: isMobile
            ? fmt(lvl)
            : `${tierLabel} ${String(r.type).toUpperCase()}<br>${fmt(lvl)} (${r.touches ?? "-"})`,
          showarrow: false, xanchor: "left", yanchor: "middle", align: "left",
          xshift: 4, borderpad: 2,
          bgcolor: "rgba(18,25,39,0.9)", bordercolor: color,
          font: {color, size: isMobile ? 10 : 11}
        });
      });

      earningsMarkers.forEach((marker, idx) => {
        const markerDate = String(marker.date || "").trim();
        if (!markerDate) return;
        const session = String(marker.session || "TBD").toUpperCase();
        const color = session === "BMO" ? "#38bdf8" : (session === "AMC" ? "#a855f7" : "#94a3b8");
        shapes.push({
          type: "line",
          xref: "x",
          yref: "paper",
          x0: markerDate,
          x1: markerDate,
          y0: 0,
          y1: 1,
          line: { color, width: 1.6, dash: "dot" },
        });
        annotations.push({
          xref: "x",
          yref: "paper",
          x: markerDate,
          y: 1,
          yshift: -18 - (idx * 18),
          text: `E ${escHtml(session)}${marker.days_until != null ? ` • ${escHtml(String(marker.days_until))}d` : ""}`,
          showarrow: false,
          xanchor: "left",
          bgcolor: "rgba(18,25,39,0.92)",
          bordercolor: color,
          borderpad: 3,
          font: { color, size: isMobile ? 10 : 11 },
        });
      });

      gaps.forEach(g => {
        const y0 = Number(g.gap_low), y1 = Number(g.gap_high);
        if (Number.isNaN(y0) || Number.isNaN(y1)) return;
        shapes.push({
          type: "rect", xref: "x", yref: "y",
          x0: g.date, x1: x[x.length - 1], y0, y1,
          fillcolor: g.type === "bull_gap" ? "rgba(248,194,78,0.22)" : "rgba(106,169,255,0.20)",
          line: {width: 1, color: "rgba(142,160,189,0.6)"}
        });
      });

      if (showTrendlines) trendlines.forEach(t => {
        const y0 = Number(t.y0);
        const y1 = Number(t.y1);
        if (Number.isNaN(y0) || Number.isNaN(y1)) return;
        const color = String(t.type || "").includes("support") ? "#38d39f" : "#ff6b6b";
        shapes.push({
          type: "line",
          xref: "x",
          yref: "y",
          x0: t.x0_date,
          x1: t.x1_date,
          y0,
          y1,
          line: {color, width: 1.6, dash: "dot"}
        });
      });

      if (showPatterns) {
        const patternColor = (nameRaw) => {
          const name = String(nameRaw || "").toLowerCase();
          if (
            name.includes("bull")
            || name.includes("falling_wedge")
            || name.includes("ascending_triangle")
            || name.includes("double_bottom")
            || name.includes("inv_head")
          ) return "#38d39f";
          if (
            name.includes("bear")
            || name.includes("rising_wedge")
            || name.includes("descending_triangle")
            || name.includes("double_top")
            || name.includes("head_and_shoulders")
          ) return "#ff6b6b";
          return "#f8c24e";
        };
        const sourceDash = (sRaw) => {
          const s = String(sRaw || "").toLowerCase();
          if (s === "hybrid_rule") return "solid";
          return "dot";
        };

        let overlays = patternOverlays.filter((p) => {
          const src = String(p.source || "");
          if (src === "cv_proxy") return false;
          if (!showRuleClassLines && (src === "rule" || src === "hybrid_rule")) return false;
          return true;
        });

        if (!overlays.length) {
          overlays = patterns.slice(0, 4).map((p) => ({
            source: "rule",
            class_name: p.pattern,
            status: p.status,
            confidence: p.confidence,
            x0_date: p.x0_date,
            x1_date: p.x1_date,
            y0: p.y0,
            y1: p.y1,
            y0b: p.y0b,
            y1b: p.y1b,
            notes: p.notes,
          }));
        }

        overlays = overlays
          .slice()
          .sort((a, b) => Number(b.confidence || 0) - Number(a.confidence || 0))
          .slice(0, 10);

        overlays.forEach((p, idx) => {
          const y0 = Number(p.y0);
          const y1 = Number(p.y1);
          const y0b = Number(p.y0b);
          const y1b = Number(p.y1b);
          if ([y0, y1, y0b, y1b].some(Number.isNaN)) return;
          const className = String(p.class_name || p.pattern || "pattern");
          const status = String(p.status || "forming");
          const source = String(p.source || "rule");
          const conf = Number(p.confidence);
          const color = patternColor(className);
          const dash = sourceDash(source);
          const width = source === "hybrid_rule" ? 2.1 : 1.7;
          const shortSrc = source === "hybrid_rule" ? "HYB" : "RULE";

          shapes.push({
            type: "line",
            xref: "x",
            yref: "y",
            x0: p.x0_date,
            x1: p.x1_date,
            y0,
            y1,
            line: {color, width, dash},
          });
          shapes.push({
            type: "line",
            xref: "x",
            yref: "y",
            x0: p.x0_date,
            x1: p.x1_date,
            y0: y0b,
            y1: y1b,
            line: {color, width, dash},
          });
          if (!isMobile) {
            annotations.push({
              xref: "paper",
              yref: "paper",
              x: 0.01,
              y: 0.98 - idx * 0.045,
              text: `${className.replaceAll("_", " ")} • ${shortSrc} • ${status} • ${fmt(conf, 2)}`,
              showarrow: false,
              xanchor: "left",
              yanchor: "top",
              bgcolor: "rgba(18,25,39,0.85)",
              bordercolor: color,
              font: {color, size: 11},
            });
          }
        });
      }

      if (showYoloPatterns && yoloPatterns.length > 0) {
        const yoloColorMap = {
          bull: {stroke: "#38d39f", fill: "rgba(56,211,159,0.07)"},
          bear: {stroke: "#ff6b6b", fill: "rgba(255,107,107,0.07)"},
          neutral: {stroke: "#f8c24e", fill: "rgba(248,194,78,0.07)"},
        };
        const yoloLabel = (nameRaw, compact = false) => {
          const raw = String(nameRaw || "").replaceAll("_", " ").trim();
          const map = {
            "Head and shoulders bottom": "H&S Bottom",
            "Head and shoulders top": "H&S Top",
            "M Head": "M Head",
            "W Bottom": "W Bottom",
            "StockLine": "Stock Line",
          };
          let label = map[raw] || raw || "Pattern";
          if (compact) {
            const compactMap = {
              "H&S Bottom": "H&S Bot",
              "H&S Top":    "H&S Top",
              "W Bottom":   "W Bot",
              "M Head":     "M Head",
              "Stock Line": "StkLine",
              "Triangle":   "Triangle",
            };
            label = compactMap[label] ?? (label.length > 10 ? `${label.slice(0, 10)}…` : label);
          }
          return label;
        };
        const yoloStyle = (nameRaw) => {
          const n = String(nameRaw || "").toLowerCase();
          if (n.includes("bottom") || n.includes("w_bottom") || n.includes("shoulders bottom")) return yoloColorMap.bull;
          if (n.includes("top") || n.includes("m_head") || n.includes("shoulders top")) return yoloColorMap.bear;
          return yoloColorMap.neutral;
        };
        // Keep weekly charts timeframe-aligned: weekly candles should not be cluttered
        // by daily YOLO boxes. Daily view may still show both.
        const dailyPatterns = yoloPatterns.filter(p => (p.timeframe || "daily") === "daily");
        const weeklyPatterns = yoloPatterns.filter(p => p.timeframe === "weekly");

        const renderYoloGroup = (group, isWeekly) => {
          const maxLabels = isMobile ? (isWeekly ? 2 : 3) : 5;
          let labelCount = 0;
          group.forEach((p) => {
            const y0 = Number(p.y0), y1 = Number(p.y1);
            if (Number.isNaN(y0) || Number.isNaN(y1)) return;
            const baseStyle = yoloStyle(p.pattern);
            const age = Number(p.age_days);
            const staleCutoff = isWeekly ? 120 : 45;
            const agingCutoff = isWeekly ? 70 : 25;
            const isStale = Number.isFinite(age) && age > staleCutoff;
            const isAging = !isStale && Number.isFinite(age) && age > agingCutoff;
            const borderWidth = isStale ? 1.0 : (isWeekly ? 2.2 : 1.5);
            const borderDash = isStale ? "dot" : (isWeekly ? "dash" : "dot");
            const fillOpacity = isStale ? "0.02" : (isAging ? "0.04" : (isWeekly ? "0.05" : "0.07"));
            // Weekly uses slightly muted colours to not compete with daily boxes
            const stroke = isStale
              ? baseStyle.stroke + "99"
              : (isWeekly ? baseStyle.stroke + "cc" : baseStyle.stroke);
            const fill = baseStyle.fill.replace(/[\d.]+\)$/, `${fillOpacity})`);
            const conf = Number(p.confidence);
            const label = isWeekly ? "W" : "D";
            shapes.push({
              type: "rect",
              xref: "x",
              yref: "y",
              x0: p.x0_date,
              x1: p.x1_date,
              y0: Math.min(y0, y1),
              y1: Math.max(y0, y1),
              line: {color: stroke, width: borderWidth, dash: borderDash},
              fillcolor: fill,
            });
            if (labelCount < maxLabels) {
              const confPct = Number.isFinite(conf) ? `${(conf * 100).toFixed(0)}%` : "";
              const ageText = Number.isFinite(age)
                ? (isStale ? ` • old ${Math.round(age)}d` : (age > 0 ? ` • ${Math.round(age)}d` : " • fresh"))
                : "";
              const labelName = yoloLabel(p.pattern, isMobile);
              const text = isMobile
                ? `${label}:${labelName} ${confPct}${ageText}`
                : `[${label}] ${yoloLabel(p.pattern, false)} ${confPct}${ageText}`;
              const yTop = Math.max(y0, y1);
              annotations.push({
                xref: "x",
                yref: "y",
                x: isMobile ? p.x0_date : p.x1_date,
                y: yTop,
                text,
                showarrow: false,
                xanchor: "left",
                yanchor: isMobile ? "top" : "bottom",
                xshift: isMobile ? 2 : 4,
                yshift: isMobile ? -2 : 0,
                bgcolor: "rgba(18,25,39,0.85)",
                bordercolor: baseStyle.stroke,
                font: {color: baseStyle.stroke, size: isMobile ? 8 : (isWeekly ? 9 : 10)},
              });
              labelCount++;
            }
          });
        };

        if (isWeeklyChart) {
          renderYoloGroup(weeklyPatterns, true);
        } else {
          renderYoloGroup(dailyPatterns, false);
          renderYoloGroup(weeklyPatterns, true);
        }
      }

      const layout = {
        paper_bgcolor: "#121927",
        plot_bgcolor: "#121927",
        font: {color: "#e9eef8"},
        margin: isMobile ? {t: 40, l: 45, r: 80, b: 40} : {t: 40, l: 60, r: 235, b: 50},
        dragmode: "zoom",
        legend: isMobile
          ? {orientation: "h", y: -0.08, x: 0, xanchor: "left", font: {size: 10}}
          : {orientation: "h", y: -0.04, x: 0, xanchor: "left"},
        xaxis: {
          domain: [0, 1], anchor: "y", rangeslider: {visible: false},
          showgrid: true, gridcolor: "#25334f",
          range: defaultX0 && defaultX1 ? [defaultX0, defaultX1] : undefined,
          rangebreaks: isWeeklyChart
            ? [{bounds: ["sat", "mon"]}]
            : [
                {bounds: ["sat", "mon"]},
                ...(missingWeekdayBreaks.length ? [{values: missingWeekdayBreaks}] : []),
              ],
          rangeselector: {
            bgcolor: "#e9eef8",
            activecolor: "#6aa9ff",
            bordercolor: "#0b0f16",
            borderwidth: 1,
            font: {color: "#0b0f16", size: 12},
            buttons: [
              {count: 3, step: "month", stepmode: "backward", label: "3M"},
              {count: 6, step: "month", stepmode: "backward", label: "6M"},
              {count: 1, step: "year", stepmode: "todate", label: "YTD"},
              {count: 1, step: "year", stepmode: "backward", label: "1Y"},
              {count: 2, step: "year", stepmode: "backward", label: "2Y"},
              {step: "all", label: "ALL"}
            ]
          }
        },
        yaxis: {
          domain: [0.30, 1],
          showgrid: true,
          gridcolor: "#25334f",
          title: "Price",
          range: defaultY || undefined,
          autorange: !defaultY
        },
        xaxis2: {domain: [0, 1], anchor: "y2", matches: "x", showgrid: false},
        yaxis2: {domain: [0, 0.24], showgrid: true, gridcolor: "#25334f", title: "Volume"},
        shapes,
        annotations
      };

      Plotly.newPlot("chart", traces, layout, {responsive: true, scrollZoom: true, displayModeBar: true});
      const chartEl = $("chart");
      let ySyncLock = false;
      chartEl.on("plotly_relayout", (ev) => {
        if (ySyncLock) return;
        const hasXRange = "xaxis.range[0]" in ev || Array.isArray(ev["xaxis.range"]);
        const allX = ev["xaxis.autorange"] === true;
        if (!hasXRange && !allX) return; // ignore Y-only or unrelated events — prevents snap-back
        const r0 = ev["xaxis.range[0]"] ?? (Array.isArray(ev["xaxis.range"]) ? ev["xaxis.range"][0] : null);
        const r1 = ev["xaxis.range[1]"] ?? (Array.isArray(ev["xaxis.range"]) ? ev["xaxis.range"][1] : null);
        const baseYr = allX
          ? computeYRangeForXWindow(x, low, high, x[0], x[x.length - 1])
          : computeYRangeForXWindow(x, low, high, r0 || x[0], r1 || x[x.length - 1]);
        const yr = extendYRangeWithLevelValues(baseYr, levelValues);
        if (!yr) return;
        ySyncLock = true;
        Plotly.relayout("chart", {"yaxis.range": yr})
          .catch(() => {})
          .finally(() => { ySyncLock = false; });
      });
    }

    function syncChartToggleState(payload) {
      const trendCount = Array.isArray(payload?.trendlines) ? payload.trendlines.length : 0;
      const overlayCount = Array.isArray(payload?.pattern_overlays)
        ? payload.pattern_overlays.filter((p) => String((p && p.source) || "") !== "cv_proxy").length
        : 0;
      const fallbackPatternCount = Array.isArray(payload?.patterns) ? payload.patterns.length : 0;
      const visibleRuleCount = overlayCount || fallbackPatternCount;
      const yoloCount = Array.isArray(payload?.yolo_patterns) ? payload.yolo_patterns.length : 0;

      const setToggle = (inputId, labelId, baseText, count) => {
        const input = $(inputId);
        const label = $(labelId);
        if (!input || !label) return;
        const hasData = count > 0;
        input.disabled = !hasData;
        if (!hasData) input.checked = false;
        label.textContent = `${baseText}${hasData ? ` (${count})` : " (none)"}`;
        label.style.opacity = hasData ? "1" : "0.55";
      };

      setToggle("showTrendlines", "showTrendlinesLabel", "Trendlines", trendCount);
      setToggle("showPatterns", "showPatternsLabel", "YOLO Boxes", yoloCount);
      setToggle("showRuleClassLines", "showRuleClassLinesLabel", "Rule/Hybrid Lines", visibleRuleCount);
    }

    function setOpportunityFilters({view, minDiscount, maxPeg, overvaluedThreshold, limitRows}) {
      if (view !== undefined) $("opView").value = String(view);
      if (minDiscount !== undefined) $("minDiscount").value = String(minDiscount);
      if (maxPeg !== undefined) $("maxPeg").value = String(maxPeg);
      if (overvaluedThreshold !== undefined) $("overvaluedThreshold").value = String(overvaluedThreshold);
      if (limitRows !== undefined) $("limitRows").value = String(limitRows);
    }

    function applyOpportunityPreset(name) {
      if ($("opSearch")) $("opSearch").value = "";
      if (name === "all") {
        setOpportunityFilters({ view: "all", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "undervalued") {
        setOpportunityFilters({ view: "undervalued", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "deep_value") {
        setOpportunityFilters({ view: "deep_value", minDiscount: 20, maxPeg: 1.5, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "overvalued") {
        setOpportunityFilters({ view: "overvalued", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else {
        setOpportunityFilters({ view: "all", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      }
      loadOpportunities();
    }

    async function loadOpportunities() {
      const base = getApiBase();
      const view = String($("opView").value || "all");
      const apiView = view === "deep_value" ? "undervalued" : view;
      const minDiscount = Number($("minDiscount").value || 10);
      const maxPeg = Number($("maxPeg").value || 2);
      const overvaluedThreshold = Number($("overvaluedThreshold").value || -10);
      const limitRows = Number($("limitRows").value || 500);
      const btn = $("loadOpBtn");
      btn.disabled = true;
      $("opStatus").innerHTML = `<span class="status-plain">Loading opportunities...</span>`;
      setGlobalStatus("Loading opportunities...");
      try {
        const q = new URLSearchParams({
          limit: String(limitRows),
          min_discount: String(minDiscount),
          max_peg: String(maxPeg),
          overvalued_threshold: String(overvaluedThreshold),
          view: apiView,
        });
        const resp = await apiFetch(`${base}/api/opportunities?${q.toString()}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        const rows = payload.rows || [];
        renderOpFilterHelp(payload.filter_help || null);
        renderSimpleTable(
          "opTable",
          ["ticker", "price", "pe", "peg", "target_price", "discount_pct", "valuation_label", "eps_growth_5y"],
          rows,
          true,
          (row) => {
            $("ticker").value = row.ticker;
            activateTab("chart");
            loadChart();
          },
          { sortable: true, searchInputId: "opSearch" }
        );
        renderOpStatus(payload, view, rows.length);
        setGlobalStatus("Opportunities loaded");
      } catch (err) {
        console.error(err);
        $("opStatus").innerHTML = `<span class="status-plain" style="color:#ff8a8a;">Failed: ${escHtml(err.message)}</span>`;
        setGlobalStatus("Failed loading opportunities");
      } finally {
        btn.disabled = false;
      }
    }

    async function loadChart() {
      const ticker = ($("ticker").value || "SPY").trim().toUpperCase();
      const months = 0; // always fetch all data; view window controlled by rangeselector
      const base = getApiBase();
      const btn = $("loadChartBtn");
      btn.disabled = true;
      $("chartStatus").textContent = `Loading ${ticker}...`;
      setGlobalStatus(`Loading ${ticker} dashboard...`);
      try {
        const resp = await apiFetch(`${base}/api/dashboard/${ticker}?months=${months}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        syncChartToggleState(payload);
        fillCards(payload);
        renderChart(payload);
        renderSimpleTable("levelsTable", ["type", "level", "zone_low", "zone_high", "tier", "touches", "last_touch_date"], payload.levels || [], false, null, { sortable: true });
        renderSimpleTable("gapsTable", ["date", "type", "gap_low", "gap_high"], payload.gaps || [], false, null, { sortable: true });
        renderSimpleTable("trendlinesTable", ["type", "touch_count", "score", "last_touch_date"], payload.trendlines || [], false, null, { sortable: true });
        renderSimpleTable("patternsTable", ["pattern", "status", "confidence", "start_date", "end_date"], payload.patterns || [], false, null, { sortable: true });
        renderSimpleTable(
          "hybridPatternsTable",
          ["pattern", "status", "hybrid_confidence", "base_confidence", "candle_score", "volume_score", "breakout_score", "candle_bias", "vol_ratio", "start_date", "end_date"],
          payload.hybrid_patterns || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable(
          "patternOverlaysTable",
          ["source", "class_name", "status", "confidence", "start_date", "end_date"],
          payload.pattern_overlays || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable("candlesTable", ["date", "pattern", "bias", "confidence", "explanation"], payload.candlestick_patterns || [], false, null, { sortable: true });
        renderSimpleTable("yoloPatternsTable", ["timeframe", "pattern", "confidence", "x0_date", "x1_date", "y0", "y1", "as_of_date"], payload.yolo_patterns || [], false, null, { sortable: true });
        $("chartStatus").textContent = `asof ${payload.asof || "-"} • ${ticker}`;
        setGlobalStatus(`Done (${ticker})`);
      } catch (err) {
        console.error(err);
        $("chartStatus").textContent = `Failed: ${err.message}`;
        setGlobalStatus(`Failed (${ticker})`);
      } finally {
        btn.disabled = false;
      }
    }

    async function loadTickerUniverse() {
      const base = getApiBase();
      try {
        const resp = await apiFetch(`${base}/api/tickers?limit=2000`);
        if (!resp.ok) throw new Error(`${resp.status}`);
        const payload = await resp.json();
        const list = $("tickerList");
        if (!list) return;
        list.innerHTML = "";
        (payload.tickers || []).forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          list.appendChild(opt);
        });
      } catch (err) {
        console.warn("ticker universe load failed", err);
      }
    }

    function loadTickerQuick(t) {
      $("ticker").value = t;
      activateTab("chart");
      loadChart();
    }

    function jumpToTicker(ticker) {
      loadTickerQuick(ticker);
    }
    window.jumpToTicker = jumpToTicker;

    function normalizeTickerSymbol(v) {
      return String(v || "").trim().toUpperCase().replace(/\s+/g, "");
    }

    function getStoredWatchlist() {
      try {
        const raw = localStorage.getItem(WATCHLIST_STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return [...new Set(arr.map(normalizeTickerSymbol).filter(Boolean))];
      } catch {
        return [];
      }
    }

    function saveStoredWatchlist(list) {
      localStorage.setItem(WATCHLIST_STORAGE_KEY, JSON.stringify([...new Set((list || []).map(normalizeTickerSymbol).filter(Boolean))]));
    }

    function addTickerToWatchlist(ticker) {
      const symbol = normalizeTickerSymbol(ticker);
      if (!symbol) return false;
      const list = getStoredWatchlist();
      if (!list.includes(symbol)) list.push(symbol);
      saveStoredWatchlist(list);
      renderWatchlistTable();
      return true;
    }
    window.addTickerToWatchlist = addTickerToWatchlist;

    function removeTickerFromWatchlist(ticker) {
      const symbol = normalizeTickerSymbol(ticker);
      const list = getStoredWatchlist().filter((t) => t !== symbol);
      saveStoredWatchlist(list);
      renderWatchlistTable();
    }
    window.removeTickerFromWatchlist = removeTickerFromWatchlist;

    function renderWatchlistTable() {
      const el = $("reportWatchTable");
      if (!el) return;
      const hint = $("reportWatchHint");
      const list = getStoredWatchlist();
      const setupMap = new Map((LAST_REPORT_SETUP_ROWS || []).map((r) => [String(r.ticker || "").toUpperCase(), r]));

      const head = "<tr><th>ticker</th><th>score</th><th>pct_change</th><th>setup_tier</th><th>yolo_pattern</th><th>actions</th></tr>";
      if (!list.length) {
        el.innerHTML = `${head}<tr><td colspan=\"6\">No watchlist tickers yet</td></tr>`;
        if (hint) hint.textContent = "Tip: Add symbols manually or import top setup candidates.";
        return;
      }

      const rowsHtml = list
        .map((ticker) => {
          const row = setupMap.get(ticker) || {};
          const score = row.score ?? "-";
          const pct = row.pct_change ?? "-";
          const tier = row.setup_tier ?? "-";
          const yolo = row.yolo_pattern || "-";
          return (
            `<tr>` +
            `<td>${escHtml(ticker)}</td>` +
            `<td>${escHtml(score)}</td>` +
            `<td>${escHtml(pct)}</td>` +
            `<td>${escHtml(tier)}</td>` +
            `<td>${escHtml(yolo)}</td>` +
            `<td>` +
            `<button type="button" data-watch-load="${escHtml(ticker)}" style="width:auto; padding:5px 8px; margin-right:6px;">Load</button>` +
            `<button type="button" data-watch-remove="${escHtml(ticker)}" style="width:auto; padding:5px 8px;">Remove</button>` +
            `</td>` +
            `</tr>`
          );
        })
        .join("");
      el.innerHTML = head + rowsHtml;
      if (hint) hint.textContent = `${list.length} ticker(s) saved locally in this browser.`;

      el.querySelectorAll("button[data-watch-load]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-watch-load");
          if (t) loadTickerQuick(t);
        });
      });
      el.querySelectorAll("button[data-watch-remove]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-watch-remove");
          if (t) removeTickerFromWatchlist(t);
        });
      });
    }

    async function loadReport() {
      const base = getApiBase();
      $("reportStatus").textContent = "Loading...";
      try {
        const resp = await apiFetch(`${base}/api/daily-report?limit=20`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        const latest = data.latest || {};
        const counts = latest.counts || {};
        const yoloBlock = latest.yolo || {};
        const yoloSummary = yoloBlock.summary || {};
        const ingestRun = latest.latest_ingest_run || {};
        const signals = latest.signals || {};
        const hasReport = data.ok && Object.keys(latest).length > 0;

        $("reportNoData").style.display = hasReport ? "none" : "block";
        if (!hasReport) { $("reportStatus").textContent = "No report yet"; return; }

        const makeCard = (label, val) =>
          `<div class="card"><div class="label">${label}</div><div class="value">${val ?? "—"}</div></div>`;

        $("reportSummaryCards").innerHTML = [
          makeCard("Generated (UTC)", (latest.generated_ts || "—").slice(0, 16).replace("T", " ")),
          makeCard("Tracked Tickers", counts.tracked_tickers ?? "—"),
          makeCard("Price Rows", (counts.price_rows ?? 0).toLocaleString()),
          makeCard("Latest Price Date", (latest.latest_data || {}).price_date ?? "—"),
          makeCard("Last Ingest", ingestRun.status ?? "—"),
        ].join("");

        const tfDaily  = (yoloBlock.timeframes || []).find(t => t.timeframe === "daily")  || {};
        const tfWeekly = (yoloBlock.timeframes || []).find(t => t.timeframe === "weekly") || {};
        $("reportYoloCards").innerHTML = [
          makeCard("YOLO Total Rows", yoloSummary.rows_total ?? "—"),
          makeCard("YOLO Tickers", yoloSummary.tickers_with_patterns ?? "—"),
          makeCard("Daily Tickers", tfDaily.tickers_with_patterns  ?? "—"),
          makeCard("Weekly Tickers", tfWeekly.tickers_with_patterns ?? "—"),
        ].join("");

        const keyChanges = signals.tonight_key_changes || [];
        $("reportKeyChangesList").innerHTML = keyChanges.length
          ? keyChanges
              .slice(0, 5)
              .map((row) => `<li><b>${escHtml(row.title || "Change")}:</b> ${escHtml(row.detail || "-")}</li>`)
              .join("")
          : "<li>No material changes captured.</li>";

        const risk = latest.risk_filters || {};
        const riskMode = String(risk.trade_mode || "normal");
        const hardBlocks = Number(risk.hard_blocks || 0);
        const softFlags = Number(risk.soft_flags || 0);
        $("reportRiskSummary").innerHTML =
          `Mode: <b>${escHtml(riskMode.toUpperCase())}</b>` +
          ` • Hard blocks: <b>${hardBlocks}</b>` +
          ` • Soft flags: <b>${softFlags}</b>`;
        const riskRows = Array.isArray(risk.conditions) ? risk.conditions : [];
        $("reportRiskList").innerHTML = riskRows.length
          ? riskRows
              .slice(0, 10)
              .map((row) => `<li>[${escHtml(String(row.severity || "soft").toUpperCase())}] ${escHtml(row.reason || row.code || "-")}</li>`)
              .join("")
          : "<li>No active no-trade conditions.</li>";

        const setupRows = (signals.setup_quality_top || []).slice(0, 40);
        const compactSetupRows = buildCompactSetupRows(setupRows.slice(0, 15));
        LAST_REPORT_SETUP_ROWS = setupRows;
        $("reportSetupSummary").textContent = setupRows.length
          ? `Compact view keeps the nightly workflow tight: top ${Math.min(15, setupRows.length)} names first, with what is happening and the next reasonable action.`
          : "No confluence rows available yet.";
        $("reportSetupExplain").textContent = setupRows.length
          ? "Read it in order: bias, where price sits versus support/resistance and trend, then whether the move is actionable now or better left for a pullback / breakdown confirmation."
          : "";
        renderSimpleTable(
          "reportSetupCompactTable",
          [
            { key: "ticker", label: "Ticker" },
            { key: "score", label: "Score" },
            { key: "setup_tier", label: "Tier" },
            { key: "why_high", label: "Observation" },
            { key: "action", label: "Reasonable Action" },
            { key: "technical_read", label: "Technical Read" },
          ],
          compactSetupRows,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        renderSimpleTable(
          "reportSetupQualityTable",
          [
            { key: "ticker", label: "Ticker" },
            { key: "score", label: "Score" },
            { key: "setup_tier", label: "Tier" },
            { key: "signal_bias", label: "Bias" },
            { key: "observation", label: "Observation" },
            { key: "action", label: "Reasonable Action" },
            { key: "risk_note", label: "Risk" },
            { key: "sector", label: "Sector" },
            { key: "pct_change", label: "Today %" },
            { key: "discount_pct", label: "Discount %" },
            { key: "peg", label: "PEG" },
            { key: "atr_pct_14", label: "ATR %" },
            { key: "realized_vol_20", label: "RV20 %" },
            { key: "bb_width_20", label: "BB Width %" },
            { key: "yolo_pattern", label: "YOLO Pattern" },
            { key: "yolo_confidence", label: "YOLO Conf" },
            { key: "yolo_age_days", label: "YOLO Age (d)" },
            { key: "candle_pattern", label: "Candle" },
            { key: "candle_bias", label: "Candle Bias" },
          ],
          setupRows.slice(0, 25),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        $("reportSetupQuickAdds").innerHTML = setupRows
          .slice(0, 10)
          .map((row) => `<button type="button" data-watch-add="${escHtml(row.ticker)}">+ ${escHtml(row.ticker)}</button>`)
          .join("");
        $("reportSetupQuickAdds").querySelectorAll("button[data-watch-add]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const t = btn.getAttribute("data-watch-add");
            if (!t) return;
            addTickerToWatchlist(t);
          });
        });
        setReportSetupMode(REPORT_SETUP_SHOW_MORE);

        const sectorRows = signals.sector_heatmap || [];
        const maxAbs = Math.max(1, ...sectorRows.map((r) => Math.abs(Number(r.avg_pct_change || 0))));
        $("reportSectorHeatmap").innerHTML = sectorRows
          .slice(0, 12)
          .map((r) => {
            const avg = Number(r.avg_pct_change || 0);
            const width = Math.max(2, Math.round((Math.abs(avg) / maxAbs) * 100));
            const color = avg >= 0 ? "linear-gradient(90deg,#1f8f66,#38d39f)" : "linear-gradient(90deg,#cc5a5a,#ff6b6b)";
            return (
              `<div class="heat-row">` +
              `<div>${escHtml(r.sector || "Unknown")}</div>` +
              `<div class="heat-track"><div class="heat-fill" style="width:${width}%; background:${color};"></div></div>` +
              `<div style="text-align:right;">${escHtml((avg >= 0 ? "+" : "") + avg.toFixed(2) + "%")}</div>` +
              `</div>`
            );
          })
          .join("");
        renderSimpleTable(
          "reportSectorHeatTable",
          ["sector", "avg_pct_change", "pct_advancing", "tickers", "near_high_count", "near_low_count"],
          sectorRows.slice(0, 20),
          false,
          null,
          { sortable: true },
        );
        renderWatchlistTable();

        const yoloDeltaDaily = yoloBlock.delta_daily || yoloBlock.delta || {};
        const yoloDeltaWeekly = yoloBlock.delta_weekly || {};
        const yoloDelta = yoloDeltaDaily;
        const yoloNew = yoloDelta.new_patterns || [];
        const yoloLost = yoloDelta.lost_patterns || [];
        const wkNew = Number(yoloDeltaWeekly.new_count || 0);
        const wkLost = Number(yoloDeltaWeekly.lost_count || 0);
        $("reportYoloDeltaSummary").textContent =
          `Comparing ${yoloDelta.prev_asof || "?"} -> ${yoloDelta.today_asof || "?"}` +
          ` • New: ${yoloDelta.new_count ?? yoloNew.length}` +
          ` • No longer detected: ${yoloDelta.lost_count ?? yoloLost.length}` +
          (yoloDeltaWeekly && Object.keys(yoloDeltaWeekly).length
            ? ` • Weekly: +${wkNew} / -${wkLost}`
            : "");
        renderSimpleTable(
          "reportYoloNewTable",
          ["ticker", "timeframe", "pattern", "confidence", "x0_date", "x1_date"],
          yoloNew.slice(0, 20),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        const yoloPersistence = yoloBlock.persistence || {};
        const persistDaily = ((yoloPersistence.daily || {}).rows || []).slice(0, 15);
        const persistWeekly = ((yoloPersistence.weekly || {}).rows || []).slice(0, 15);
        const pDailyMeta = yoloPersistence.daily || {};
        const pWeeklyMeta = yoloPersistence.weekly || {};
        $("reportYoloPersistenceSummary").textContent =
          `Daily window: ${pDailyMeta.lookback_asof ?? "?"} as-ofs (latest ${pDailyMeta.latest_asof || "?"})` +
          ` • Weekly window: ${pWeeklyMeta.lookback_asof ?? "?"} as-ofs (latest ${pWeeklyMeta.latest_asof || "?"})`;
        renderSimpleTable(
          "reportYoloPersistenceDailyTable",
          ["ticker", "pattern", "streak", "seen_in_lookback", "coverage_pct", "latest_confidence"],
          persistDaily,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        renderSimpleTable(
          "reportYoloPersistenceWeeklyTable",
          ["ticker", "pattern", "streak", "seen_in_lookback", "coverage_pct", "latest_confidence"],
          persistWeekly,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        renderSimpleTable(
          "reportYoloLostTable",
          ["ticker", "timeframe", "pattern", "confidence", "x0_date", "x1_date"],
          yoloLost.slice(0, 20),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        const breadth = signals.market_breadth || {};
        const pctAdv = breadth.pct_advancing ?? "—";
        const adv = breadth.advancers ?? 0;
        const dec = breadth.decliners ?? 0;
        const unch = breadth.unchanged ?? 0;
        const avgMove = breadth.avg_pct_change ?? "—";
        const medianMove = breadth.median_pct_change ?? "—";
        const moveThresh = breadth.large_move_threshold_pct ?? "—";
        const moveCount = breadth.large_move_count ?? 0;
        $("reportBreadthSummary").innerHTML =
          `Breadth: <b>${adv}</b> up / <b>${dec}</b> down / <b>${unch}</b> flat` +
          ` • Advancing: <b>${pctAdv}%</b>` +
          ` • Avg move: <b>${avgMove}%</b>` +
          ` • Median move: <b>${medianMove}%</b>` +
          ` • |move| >= ${moveThresh}%: <b>${moveCount}</b>`;

        renderSimpleTable(
          "reportMoversUpTable",
          ["ticker", "pct_change", "close", "prev_close", "pct_from_high"],
          (signals.movers_up_today || []).slice(0, 12),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );
        renderSimpleTable(
          "reportMoversDownTable",
          ["ticker", "pct_change", "close", "prev_close", "pct_from_low"],
          (signals.movers_down_today || []).slice(0, 12),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        // 52W extremes
        const nearHigh = signals.near_52w_high || [];
        const nearLow  = signals.near_52w_low  || [];
        const fmt52w = (arr, field, refField, color) =>
          arr.length
            ? arr.map(t =>
                `<span style="display:inline-block; margin-right:10px;">` +
                `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
                `<span style="color:var(--fg)">$${t.close}</span> ` +
                `<span style="color:var(--muted); font-size:0.75rem;">(${t[field].toFixed(2)}% from ${refField} $${t[refField === 'high_52w' ? 'high_52w' : 'low_52w']})</span>` +
                `</span>`
              ).join("")
            : `<span style="color:var(--muted)">None</span>`;

        $("report52wHigh").innerHTML = nearHigh.length
          ? nearHigh.map(t =>
              `<span style="display:inline-block; margin-right:12px; margin-bottom:2px;">` +
              `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
              `<span>$${t.close}</span> ` +
              `<span style="color:var(--muted); font-size:0.75rem;">(${t.pct_from_high.toFixed(2)}% below $${t.high_52w})</span>` +
              `</span>`
            ).join("")
          : `<span style="color:var(--muted)">None</span>`;

        $("report52wLow").innerHTML = nearLow.length
          ? nearLow.map(t =>
              `<span style="display:inline-block; margin-right:12px; margin-bottom:2px;">` +
              `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
              `<span>$${t.close}</span> ` +
              `<span style="color:var(--muted); font-size:0.75rem;">(${t.pct_from_low.toFixed(2)}% above $${t.low_52w})</span>` +
              `</span>`
            ).join("")
          : `<span style="color:var(--muted)">None</span>`;

        // Top YOLO patterns at close
        renderSimpleTable("reportYoloTopTable",
          ["ticker", "timeframe", "pattern", "confidence", "age_days", "x0_date", "x1_date", "as_of_date"],
          signals.yolo_top_today || [],
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false });

        // Candle signals at close
        renderSimpleTable("reportCandleTable",
          ["ticker", "pattern", "bias", "confidence"],
          signals.candle_patterns_today || [],
          false, null, { sortable: false });

        renderSimpleTable("reportHistoryTable",
          ["file", "size_bytes", "modified_ts"],
          data.history || [],
          false, null, { sortable: false });

        const asOf = `As of ${(latest.generated_ts || "").slice(0, 16).replace("T", " ")} UTC`;
        $("reportStatus").textContent = data.detail ? `${asOf} • ${data.detail}` : asOf;
      } catch (err) {
        $("reportStatus").textContent = `Error: ${err.message}`;
        console.error(err);
      }
    }

    async function loadEarnings() {
      const base = getApiBase();
      if (!base) return;
      const days = Math.max(1, Math.min(90, Number($("earningsDays").value || 21)));
      const watchOnly = !!$("earningsWatchOnly").checked;
      const watchlist = getStoredWatchlist();
      if (watchOnly && !watchlist.length) {
        $("earningsStatus").textContent = "Watchlist is empty.";
        $("earningsSummaryCards").innerHTML = "";
        $("earningsSummary").textContent = "Add tickers to the Daily Report watchlist first, then reload this tab.";
        $("earningsNoData").style.display = "block";
        renderEarningsBoard([]);
        renderSimpleTable("earningsTable", ["ticker", "earnings_date", "earnings_session"], []);
        return;
      }
      const qs = new URLSearchParams({ days: String(days), limit: "250" });
      if (watchOnly && watchlist.length) qs.set("tickers", watchlist.join(","));
      $("earningsStatus").textContent = "Loading...";
      try {
        const resp = await apiFetch(`${base}/api/earnings-calendar?${qs.toString()}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        const rows = payload.rows || [];
        const summary = payload.summary || {};
        const providerStatus = payload.provider_status || {};
        LAST_EARNINGS_ROWS = rows;
        LAST_EARNINGS_LOOKUP = Object.fromEntries(rows.map((row) => [earningsRowKey(row), row]));
        LAST_EARNINGS_SELECTED = rows.length ? earningsRowKey(rows[0]) : "";
        $("earningsNoData").style.display = rows.length ? "none" : "block";
        $("earningsStatus").textContent = payload.detail || `As of ${payload.market_date || "—"}`;
        const makeCard = (label, val) =>
          `<div class="card"><div class="label">${label}</div><div class="value">${val ?? "—"}</div></div>`;
        $("earningsSummaryCards").innerHTML = [
          makeCard("Window", `${days}d`),
          makeCard("Matches", payload.count ?? 0),
          makeCard("Setup Ready", summary.setup_ready ?? 0),
          makeCard("Watch", summary.watch ?? 0),
          makeCard("Calendar Only", summary.calendar_only ?? 0),
          makeCard("Unverified", summary.unverified ?? 0),
          makeCard("Provider", formatEarningsProvider(payload.provider || "fundamentals")),
        ].join("");
        $("earningsSummary").textContent = watchOnly
          ? `Watchlist filter enabled. ${watchlist.length} local ticker(s) sent to the server. ${providerStatus.detail || ""}`.trim()
          : (`${providerStatus.detail || "Showing upcoming earnings."} Default scope is the tracked universe only. Date-only / unverified rows stay watch-only until timing is confirmed.`).trim();
        renderEarningsBoard(payload.groups || []);
        renderEarningsDetail(rows[0] || null);
        renderSimpleTable(
          "earningsTable",
          [
            { key: "earnings_date", label: "Date" },
            { key: "earnings_session", label: "Session" },
            { key: "schedule_quality", label: "Timing" },
            { key: "days_until", label: "Days" },
            { key: "ticker", label: "Ticker" },
            { key: "recommendation_state", label: "State" },
            { key: "score", label: "Score" },
            { key: "signal_bias", label: "Bias" },
            { key: "earnings_risk", label: "Risk" },
            { key: "yolo_pattern", label: "YOLO" },
            { key: "sector", label: "Sector" },
            { key: "price", label: "Price" },
            { key: "discount_pct", label: "Discount %" },
            { key: "peg", label: "PEG" },
            { key: "observation", label: "Observation" },
            { key: "action", label: "Reasonable Action" },
          ],
          rows,
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
      } catch (err) {
        $("earningsStatus").textContent = `Error: ${err.message}`;
        $("earningsSummaryCards").innerHTML = "";
        $("earningsSummary").textContent = "";
        LAST_EARNINGS_ROWS = [];
        LAST_EARNINGS_LOOKUP = {};
        LAST_EARNINGS_SELECTED = "";
        renderEarningsBoard([]);
        renderEarningsDetail(null);
        renderSimpleTable("earningsTable", ["ticker", "earnings_date", "earnings_session"], []);
      }
    }

    function setChartTimeframe(tf) {
      CHART_TIMEFRAME = tf;
      $("tfDailyBtn").style.background  = tf === "daily"  ? "var(--blue)" : "var(--card)";
      $("tfDailyBtn").style.color        = tf === "daily"  ? "#fff"        : "var(--muted)";
      $("tfDailyBtn").style.border       = tf === "daily"  ? "none"        : "1px solid var(--border)";
      $("tfWeeklyBtn").style.background  = tf === "weekly" ? "var(--blue)" : "var(--card)";
      $("tfWeeklyBtn").style.color        = tf === "weekly" ? "#fff"        : "var(--muted)";
      $("tfWeeklyBtn").style.border       = tf === "weekly" ? "none"        : "1px solid var(--border)";
      if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD);
    }

    $("loadOpBtn").addEventListener("click", loadOpportunities);
    $("presetAllBtn").addEventListener("click", () => applyOpportunityPreset("all"));
    $("presetUndervaluedBtn").addEventListener("click", () => applyOpportunityPreset("undervalued"));
    $("presetDeepValueBtn").addEventListener("click", () => applyOpportunityPreset("deep_value"));
    $("presetOvervaluedBtn").addEventListener("click", () => applyOpportunityPreset("overvalued"));
    $("presetResetBtn").addEventListener("click", () => applyOpportunityPreset("reset"));
    $("clearOpSearchBtn").addEventListener("click", () => {
      if ($("opSearch")) $("opSearch").value = "";
      loadOpportunities();
    });
    $("loadChartBtn").addEventListener("click", loadChart);
    $("reportWatchAddBtn").addEventListener("click", () => {
      const input = $("reportWatchTickerInput");
      if (!input) return;
      const symbol = normalizeTickerSymbol(input.value);
      if (!symbol) return;
      addTickerToWatchlist(symbol);
      input.value = "";
    });
    $("reportWatchImportBtn").addEventListener("click", () => {
      const picks = (LAST_REPORT_SETUP_ROWS || []).slice(0, 5).map((r) => r.ticker).filter(Boolean);
      if (!picks.length) return;
      const merged = [...new Set([...getStoredWatchlist(), ...picks])];
      saveStoredWatchlist(merged);
      renderWatchlistTable();
    });
    $("reportWatchClearBtn").addEventListener("click", () => {
      saveStoredWatchlist([]);
      renderWatchlistTable();
    });
    $("reportWatchTickerInput").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      $("reportWatchAddBtn").click();
    });
    $("reportSetupCompactBtn").addEventListener("click", () => setReportSetupMode(false));
    $("reportSetupMoreBtn").addEventListener("click", () => setReportSetupMode(true));
    $("loadEarningsBtn").addEventListener("click", loadEarnings);
    $("tfDailyBtn").addEventListener("click", () => setChartTimeframe("daily"));
    $("tfWeeklyBtn").addEventListener("click", () => setChartTimeframe("weekly"));
    window.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const active = document.activeElement;
      const tag = String(active?.tagName || "").toLowerCase();
      if (tag === "textarea") return;
      if (active && ["reportWatchTickerInput"].includes(active.id)) return;
      if (!tabChart.classList.contains("hidden")) loadChart();
    });
    $("showTrendlines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showPatterns").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showRuleClassLines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showBollinger").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showYoloPatterns").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("earningsCalendarModeBtn").addEventListener("click", () => setEarningsViewMode("calendar"));
    $("earningsListModeBtn").addEventListener("click", () => setEarningsViewMode("list"));

    (async () => {
      await initApiBase();
      setReportSetupMode(false);
      setEarningsViewMode("calendar");
      activateTab("guide");
      await refreshServiceStatus();
      await loadTickerUniverse();
      await loadOpportunities();
      setInterval(refreshServiceStatus, 120000);
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") refreshServiceStatus();
      });
    })();
  </script>
</body>
</html>
