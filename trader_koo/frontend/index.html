<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>trader_koo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root {
      --bg: #0b0f16;
      --panel: #121927;
      --muted: #8ea0bd;
      --text: #e9eef8;
      --line: #25334f;
      --green: #38d39f;
      --red: #ff6b6b;
      --amber: #f8c24e;
      --blue: #6aa9ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "IBM Plex Sans", ui-monospace, SFMono-Regular, Menlo, monospace;
      background: radial-gradient(1200px 600px at 10% -10%, #1d2740 0%, var(--bg) 45%);
      color: var(--text);
    }
    .wrap { max-width: 1360px; margin: 0 auto; padding: 24px; }

    /* ── Nav ── */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0 16px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 0;
      font-family: 'Inter', sans-serif;
    }
    .nav-logo {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: .04em;
      color: var(--text);
      text-decoration: none;
    }
    .nav-links { display: flex; gap: 28px; }
    .nav-links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 13.5px;
      letter-spacing: .02em;
      transition: color .2s;
    }
    .nav-links a:hover { color: var(--text); }

    /* ── Hero ── */
    .hero {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 18px;
      padding: 22px 0 20px;
      font-family: 'Inter', sans-serif;
    }
    .hero-title {
      font-size: clamp(30px, 6vw, 46px);
      font-weight: 700;
      line-height: 1.05;
      letter-spacing: -.03em;
      margin: 0 0 6px;
      background: linear-gradient(135deg, #e9eef8 28%, #6aa9ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-sub {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
      font-weight: 400;
    }
    .status-pill {
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: 12px;
      padding: 8px 14px;
      color: var(--muted);
      font-size: 12px;
      font-family: 'Inter', sans-serif;
      word-break: break-word;
    }
    input, select, button {
      width: 100%;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
    }
    .status { color: var(--muted); font-size: 0.9rem; }
    .tabs { display: flex; gap: 8px; margin-bottom: 14px; }
    .tab-btn {
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--muted);
      padding: 9px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .tab-btn.active {
      color: white;
      background: linear-gradient(90deg, #1f7bff, #4e9cff);
      border: none;
    }
    .hidden { display: none; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
    }
    .op-toolbar {
      display: grid;
      grid-template-columns: 170px 150px 150px 140px 170px minmax(170px, 1fr) 120px 120px;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .preset-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 0 0 10px 0;
    }
    .preset-toolbar button {
      width: auto;
      padding: 8px 12px;
      border-radius: 9px;
      font-size: 0.82rem;
      background: #0f1624;
      color: var(--text);
      border: 1px solid var(--line);
      cursor: pointer;
    }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { color: var(--muted); font-size: 0.72rem; }
    .op-help {
      margin-bottom: 8px;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0f1624;
    }
    .op-help-title {
      color: var(--text);
      font-size: 0.82rem;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .op-help-grid {
      display: grid;
      grid-template-columns: 170px 1fr;
      gap: 6px 10px;
      align-items: start;
    }
    .op-help-key { color: var(--muted); font-size: 0.8rem; }
    .op-help-val { color: var(--text); font-size: 0.82rem; }
    .op-status {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      min-height: 34px;
      max-width: 100%;
      overflow-x: auto;
      padding: 2px 0;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 0.78rem;
      white-space: normal;
      word-break: break-word;
    }
    .status-chip .k { color: var(--muted); }
    .status-chip .v { color: var(--text); font-weight: 700; }
    .status-plain {
      color: var(--muted);
      font-size: 0.88rem;
    }
    .chart-toolbar {
      display: grid;
      grid-template-columns: 180px 150px 125px 125px 135px 135px 110px 75px 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .cards {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 10px;
      margin: 10px 0 14px;
    }
    .card {
      background: linear-gradient(180deg, #141d2f, #101726);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      min-height: 72px;
    }
    .report-list {
      margin: 0;
      padding-left: 20px;
      line-height: 1.6;
      color: var(--text);
      font-size: 0.84rem;
    }
    .report-list li { margin-bottom: 6px; }
    .mini-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .mini-actions button {
      width: auto;
      padding: 5px 9px;
      border-radius: 8px;
      font-size: 0.74rem;
      border: 1px solid var(--line);
      background: #0f1624;
      color: var(--text);
      cursor: pointer;
    }
    .mini-actions button:hover { border-color: var(--blue); }
    .report-watch-wrap {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }
    .report-watch-wrap input {
      flex: 1 1 180px;
      min-width: 160px;
      width: auto;
    }
    .report-watch-wrap button {
      width: auto;
      padding: 8px 10px;
      font-size: 0.76rem;
    }
    .heatmap-grid {
      display: grid;
      gap: 6px;
      margin-bottom: 8px;
    }
    .heat-row {
      display: grid;
      grid-template-columns: 120px 1fr 70px;
      gap: 8px;
      align-items: center;
      font-size: 0.78rem;
    }
    .heat-track {
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #0f1624;
      overflow: hidden;
      position: relative;
    }
    .heat-fill {
      height: 100%;
      border-radius: 999px;
    }
    .label { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .value { font-size: 1.05rem; font-weight: 700; margin-top: 8px; }
    #chart { width: 100%; height: 760px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
    th, td { border-bottom: 1px solid var(--line); padding: 8px; text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tr.clickable:hover { background: rgba(106,169,255,0.12); cursor: pointer; }
    .table-wrap { margin-top: 12px; display: grid; grid-template-columns: repeat(2, minmax(420px, 1fr)); gap: 12px; }
    .table-wrap > .panel { min-width: 0; overflow-x: auto; }
    #tabReport .panel { min-width: 0; }
    #reportStatus,
    #reportBreadthSummary,
    #reportYoloDeltaSummary,
    #reportSetupSummary,
    #reportWatchHint {
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .guide,
    .guide p,
    .guide li,
    .guide-v,
    .guide summary,
    .guide-callout,
    .site-footnote {
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .mkt-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }
    .mkt-bar button {
      width: auto;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
      background: #0f1624;
      color: var(--muted);
      border: 1px solid var(--line);
      cursor: pointer;
    }
    .mkt-bar button:hover { color: var(--text); border-color: var(--blue); }
    @media (max-width: 1100px) {
      .op-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
      .op-toolbar .field { flex: 1 1 140px; }
      .op-toolbar button { flex: 0 0 auto; width: auto; }
      .chart-toolbar { display: flex; flex-wrap: wrap; gap: 8px; }
      .chart-toolbar > * { flex: 1 1 130px; min-width: 0; }
      .chart-toolbar button { flex: 0 0 auto; width: auto; }
    }
    @media (max-width: 640px) {
      .wrap { padding: 12px; }
      #chart { height: 420px; }
      .table-wrap { grid-template-columns: 1fr; }
      .cards { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .card { min-height: 64px; padding: 8px 10px; }
      .label { font-size: 0.68rem; }
      .value { font-size: 0.95rem; }
      .hero { flex-direction: column; align-items: flex-start; gap: 12px; }
      .status-pill { width: 100%; border-radius: 10px; }
      nav { flex-wrap: wrap; gap: 10px; }
      .nav-links { gap: 14px; flex-wrap: wrap; }
      .tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .tab-btn { padding: 8px 10px; font-size: 0.82rem; }
      #tabReport .panel { padding: 8px; overflow-x: auto; }
      #tabReport table { min-width: 560px; font-size: 0.78rem; }
      #report52wHigh span, #report52wLow span {
        display: block !important;
        margin-right: 0 !important;
      }
      .report-watch-wrap { flex-direction: column; align-items: stretch; }
      .report-watch-wrap input, .report-watch-wrap button { width: 100%; }
      .mini-actions button { flex: 1 1 calc(50% - 6px); }
      .heat-row { grid-template-columns: 86px 1fr 58px; gap: 6px; font-size: 0.74rem; }
    }
    @media (max-width: 420px) {
      .tabs { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
      .mini-actions button { flex: 1 1 100%; }
      #tabReport table { min-width: 500px; }
    }
    .guide {
      line-height: 1.55;
      color: var(--text);
      font-size: 0.92rem;
    }
    .guide h3 {
      margin: 12px 0 8px;
      font-size: 1rem;
      color: var(--text);
    }
    .guide p {
      margin: 0 0 8px;
      color: var(--muted);
    }
    .guide-list {
      margin: 0 0 10px 18px;
      padding: 0;
      color: var(--muted);
    }
    .guide-list li { margin: 0 0 6px; }
    .guide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }
    .guide-card {
      background: #0f1624;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .guide-k {
      color: var(--muted);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
    }
    .guide-v {
      color: var(--text);
      font-size: 0.84rem;
      line-height: 1.45;
    }
    .guide-callout {
      background: rgba(255,107,107,0.12);
      border: 1px solid #ff6b6b;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .guide-callout-title {
      color: #ff8a8a;
      font-weight: 700;
      font-size: 0.92rem;
      margin-bottom: 4px;
    }
    .guide details {
      background: #0f1624;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
    }
    .guide summary {
      cursor: pointer;
      color: var(--text);
      font-weight: 600;
      font-size: 0.86rem;
      outline: none;
    }
    .guide details p,
    .guide details ul { margin-top: 8px; }
    .site-footnote {
      margin: 14px auto 24px;
      max-width: 1360px;
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.5;
      text-align: center;
    }
    .site-footnote strong {
      color: #ff8a8a;
      font-weight: 700;
    }
    @media (max-width: 640px) {
      .guide { font-size: 0.88rem; }
      .guide-list { margin-left: 14px; }
      .guide details { padding: 8px; }
      .guide summary { font-size: 0.82rem; }
      .site-footnote { padding: 10px 12px; font-size: 0.76rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a class="nav-logo" href="https://kooexperience.com">HK</a>
      <div class="nav-links">
        <a href="https://kooexperience.com">Home</a>
        <a href="https://github.com/haomingkoo" target="_blank" rel="noopener">GitHub</a>
      </div>
    </nav>
    <section class="hero">
      <div>
        <h1 class="hero-title">trader_koo</h1>
        <p class="hero-sub">S&amp;P 500 swing dashboard — AI pattern detection, valuation screening, and after-close signals.</p>
      </div>
      <div id="serviceStatus" class="status-pill">Connecting...</div>
    </section>
    <div id="globalStatus" class="status" style="margin-bottom: 10px; font-size: 0.82rem;"></div>
    <input id="apiBase" type="hidden" value="" />


    <div class="tabs">
      <button id="tabGuideBtn" class="tab-btn active">Guide</button>
      <button id="tabOpBtn" class="tab-btn">Opportunities (PEG)</button>
      <button id="tabChartBtn" class="tab-btn">Chart + Levels</button>
      <button id="tabReportBtn" class="tab-btn">Daily Report</button>
    </div>

    <section id="tabOp" class="panel hidden">
      <div id="opFilterHelp" class="op-help">
        Default is full S&P500 universe. Use presets for quick screens, then sort/search table.
      </div>
      <div class="preset-toolbar">
        <button id="presetAllBtn" type="button">All S&P 500</button>
        <button id="presetUndervaluedBtn" type="button">Undervalued</button>
        <button id="presetDeepValueBtn" type="button">Deep Value</button>
        <button id="presetOvervaluedBtn" type="button">Overvalued</button>
        <button id="presetResetBtn" type="button">Reset</button>
      </div>
      <div class="op-toolbar">
        <div class="field">
          <label for="opView">View</label>
          <select id="opView">
            <option value="undervalued">Undervalued</option>
            <option value="deep_value">Deep Value</option>
            <option value="overvalued">Overvalued</option>
            <option value="all" selected>All (Full Universe)</option>
          </select>
        </div>
        <div class="field">
          <label for="minDiscount">Min Discount %</label>
          <input id="minDiscount" type="number" step="1" value="10" />
        </div>
        <div class="field">
          <label for="maxPeg">Max PEG</label>
          <input id="maxPeg" type="number" step="0.1" value="2.0" />
        </div>
        <div class="field">
          <label for="overvaluedThreshold">Overvalued Threshold %</label>
          <input id="overvaluedThreshold" type="number" step="1" value="-10" />
        </div>
        <div class="field">
          <label for="limitRows">Max Rows</label>
          <input id="limitRows" type="number" step="1" value="500" />
        </div>
        <div class="field">
          <label for="opSearch">Search Table</label>
          <input id="opSearch" type="text" placeholder="ticker, reason, etc" />
        </div>
        <button id="clearOpSearchBtn" type="button">Clear Search</button>
        <button id="loadOpBtn">Load</button>
      </div>
      <div id="opStatus" class="op-status"><span class="status-plain">Auto-loading full S&P500 table...</span></div>
      <div style="overflow-x: auto; max-width: 100%;"><table id="opTable"></table></div>
    </section>

    <section id="tabChart" class="hidden">
      <div class="panel">
        <div class="chart-toolbar">
          <input id="ticker" list="tickerList" value="SPY" placeholder="Ticker e.g. NVDA" />
          <datalist id="tickerList"></datalist>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showTrendlines" type="checkbox" style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Show Trendlines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showPatterns" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Show Patterns</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showRuleClassLines" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">Rule/Hybrid Lines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showCvClassLines" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">CV Proxy Lines</span>
          </label>
          <label class="field" style="display:flex; flex-direction:row; align-items:center; gap:6px;">
            <input id="showYoloPatterns" type="checkbox" checked style="width:auto; padding:0; margin:0;" />
            <span style="font-size:0.8rem; color:var(--muted);">YOLO Patterns</span>
          </label>
          <div class="field" style="display:flex; flex-direction:row; align-items:center; gap:4px;">
            <span style="font-size:0.75rem; color:var(--muted);">Bars:</span>
            <button id="tfDailyBtn" style="padding:2px 9px; font-size:0.78rem; background:var(--blue); color:#fff; border:none; border-radius:3px; cursor:pointer;">D</button>
            <button id="tfWeeklyBtn" style="padding:2px 9px; font-size:0.78rem; background:var(--card); color:var(--muted); border:1px solid var(--border); border-radius:3px; cursor:pointer;">W</button>
          </div>
          <button id="loadChartBtn">Load</button>
          <div id="chartStatus" class="status">Select ticker and load</div>
        </div>
        <div class="mkt-bar">
          <span style="color:var(--muted); font-size:0.75rem;">Market:</span>
          <button onclick="loadTickerQuick('SPY')">SPY</button>
          <button onclick="loadTickerQuick('QQQ')">QQQ</button>
          <button onclick="loadTickerQuick('^VIX')">VIX</button>
          <button onclick="loadTickerQuick('SVIX')">SVIX</button>
          <button onclick="loadTickerQuick('^GSPC')">SPX</button>
          <button onclick="loadTickerQuick('^DJI')">DJI</button>
          <button onclick="loadTickerQuick('^TNX')">TNX</button>
        </div>

        <div class="cards">
          <div class="card"><div class="label">Price</div><div id="c-price" class="value">-</div></div>
          <div class="card"><div class="label">PE</div><div id="c-pe" class="value">-</div></div>
          <div class="card"><div class="label">PEG</div><div id="c-peg" class="value">-</div></div>
          <div class="card"><div class="label">Target</div><div id="c-target" class="value">-</div></div>
          <div class="card"><div class="label">Discount %</div><div id="c-discount" class="value">-</div></div>
          <div class="card"><div class="label">Put/Call OI</div><div id="c-pcr" class="value">-</div></div>
        </div>

        <div id="chart"></div>
      </div>

      <div class="table-wrap">
        <div class="panel">
          <div class="label">Levels</div>
          <table id="levelsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Open Gaps</div>
          <table id="gapsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Trendlines</div>
          <table id="trendlinesTable"></table>
        </div>
        <div class="panel">
          <div class="label">Pattern Candidates</div>
          <table id="patternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Hybrid Pattern Scores</div>
          <table id="hybridPatternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">CV Proxy Pattern Scores</div>
          <table id="cvProxyPatternsTable"></table>
        </div>
        <div class="panel">
          <div class="label">Hybrid vs CV Compare</div>
          <table id="hybridCvCompareTable"></table>
        </div>
        <div class="panel">
          <div class="label">Pattern Overlays (Drawn)</div>
          <table id="patternOverlaysTable"></table>
        </div>
        <div class="panel">
          <div class="label">Candlestick Signals</div>
          <table id="candlesTable"></table>
        </div>
        <div class="panel">
          <div class="label">YOLO AI Patterns</div>
          <table id="yoloPatternsTable"></table>
        </div>
      </div>
    </section>

    <section id="tabReport" class="panel hidden">
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
        <h2 style="margin:0; font-size:1.1rem;">Daily Report</h2>
        <span id="reportStatus" style="font-size:0.8rem; color:var(--muted);"></span>
      </div>
      <div id="reportSummaryCards" class="cards" style="margin-bottom:14px;"></div>
      <div id="reportYoloCards" class="cards" style="margin-bottom:14px;"></div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Tonight's 5 Key Changes</div>
        <ol id="reportKeyChangesList" class="report-list"></ol>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Watchlist</div>
        <div class="report-watch-wrap">
          <input id="reportWatchTickerInput" type="text" placeholder="Add ticker (e.g. NVDA)" />
          <button id="reportWatchAddBtn" type="button">Add</button>
          <button id="reportWatchImportBtn" type="button">Import Top 5 Setups</button>
          <button id="reportWatchClearBtn" type="button">Clear</button>
        </div>
        <div id="reportWatchHint" style="font-size:0.78rem; color:var(--muted); margin-bottom:8px;"></div>
        <table id="reportWatchTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Setup Quality Score</div>
        <div id="reportSetupSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:8px;"></div>
        <div id="reportSetupQuickAdds" class="mini-actions"></div>
        <table id="reportSetupQualityTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Sector Heatmap</div>
        <div id="reportSectorHeatmap" class="heatmap-grid"></div>
        <table id="reportSectorHeatTable"></table>
      </div>

      <!-- YOLO delta -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">YOLO Changes vs Previous Run</div>
        <div id="reportYoloDeltaSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEW PATTERNS</div>
            <table id="reportYoloNewTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NO LONGER DETECTED</div>
            <table id="reportYoloLostTable"></table>
          </div>
        </div>
      </div>

      <!-- Large moves + breadth -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Large Moves Today (vs Prior Close)</div>
        <div id="reportBreadthSummary" style="font-size:0.82rem; color:var(--muted); margin-bottom:10px;"></div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">TOP GAINERS</div>
            <table id="reportMoversUpTable"></table>
          </div>
          <div style="flex:1; min-width:280px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">TOP LOSERS</div>
            <table id="reportMoversDownTable"></table>
          </div>
        </div>
      </div>

      <!-- 52W Extremes -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">52-Week Extremes (within 3% of high/low)</div>
        <div style="display:flex; gap:16px; flex-wrap:wrap;">
          <div style="flex:1; min-width:220px;">
            <div style="font-size:0.72rem; color:var(--green); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEAR 52W HIGH</div>
            <div id="report52wHigh" style="font-size:0.82rem; line-height:1.7;"></div>
          </div>
          <div style="flex:1; min-width:220px;">
            <div style="font-size:0.72rem; color:var(--red); font-weight:600; margin-bottom:6px; letter-spacing:.05em;">NEAR 52W LOW</div>
            <div id="report52wLow" style="font-size:0.82rem; line-height:1.7;"></div>
          </div>
        </div>
      </div>

      <!-- Top YOLO patterns at close -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Top AI Patterns at Close (YOLO)</div>
        <table id="reportYoloTopTable"></table>
      </div>

      <!-- Candle signals at close -->
      <div class="panel" style="margin-bottom:12px;">
        <div class="label" style="margin-bottom:8px;">Candle Signals at Close</div>
        <table id="reportCandleTable"></table>
      </div>

      <div class="panel" style="margin-bottom:12px;">
        <div class="label">Report History</div>
        <table id="reportHistoryTable"></table>
      </div>
      <div id="reportNoData" style="display:none; color:var(--muted); padding:20px 0;">
        No reports generated yet. Reports are written after the first daily cron run (22:00 UTC Mon–Fri).
      </div>
    </section>

    <section id="tabGuide" class="panel">
      <div class="guide">
        <div class="guide-callout">
          <div class="guide-callout-title">Not Financial Advice</div>
          <p style="margin:0;">This dashboard is for research only. Signals can be wrong, delayed, or incomplete. You are responsible for risk management and execution decisions.</p>
        </div>

        <h3>Quick Start (2 Minutes)</h3>
        <ol class="guide-list">
          <li>Open <b>Daily Report</b> after the nightly run completes.</li>
          <li>Review <b>Tonight's 5 Key Changes</b> first for the fast market summary.</li>
          <li>Check <b>YOLO Changes</b> for new patterns and patterns no longer detected.</li>
          <li>Use <b>Setup Quality Score</b> and <b>Sector Heatmap</b> to prioritize candidates.</li>
          <li>Click any ticker to jump into <b>Chart + Levels</b>.</li>
          <li>Add names to <b>Watchlist</b> so you can revisit the same basket quickly.</li>
        </ol>

        <h3>What Each Tab Does</h3>
        <div class="guide-grid">
          <div class="guide-card">
            <div class="guide-k">Guide</div>
            <div class="guide-v">How to use the app, read signals, and avoid common mistakes.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Opportunities (PEG)</div>
            <div class="guide-v">Valuation screener for S&amp;P 500. Filter by discount, PEG, and view presets.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Chart + Levels</div>
            <div class="guide-v">Per-ticker chart with support/resistance, gaps, trendlines, candlestick signals, and YOLO boxes.</div>
          </div>
          <div class="guide-card">
            <div class="guide-k">Daily Report</div>
            <div class="guide-v">Nightly summary of what changed, strongest patterns, movers, and regime context.</div>
          </div>
        </div>

        <h3>Daily Report Read Order</h3>
        <ol class="guide-list">
          <li><b>Tonight's 5 Key Changes</b>: one-screen summary of what materially changed.</li>
          <li><b>Setup Quality Score</b>: ranked candidates combining valuation, momentum, and YOLO freshness.</li>
          <li><b>Sector Heatmap</b>: identify leadership/laggards and rotation.</li>
          <li><b>YOLO Changes vs Previous Run</b>: actionable delta, not raw count noise.</li>
          <li><b>Large Moves + 52-week Extremes</b>: momentum continuation or exhaustion candidates.</li>
        </ol>

        <h3>Chart + Levels Workflow</h3>
        <ol class="guide-list">
          <li>Load ticker from report or search box.</li>
          <li>Mark location versus <b>primary/secondary support/resistance</b>.</li>
          <li>Check <b>open gaps</b> and <b>trendlines</b> for context.</li>
          <li>Enable <b>YOLO patterns</b> and compare with rule/hybrid and CV proxy overlays.</li>
          <li>Decide only when multiple signals agree (structure + momentum + valuation).</li>
        </ol>

        <h3>Signal Glossary (Short)</h3>
        <details open>
          <summary>YOLO Patterns</summary>
          <ul class="guide-list">
            <li>Computer-vision detections on candlestick images (daily/weekly timeframe).</li>
            <li><b>x0_date/x1_date</b> define the detected pattern window.</li>
            <li><b>age_days</b> shows how old the pattern end-date is relative to run date.</li>
            <li>Use <b>YOLO Changes</b> to identify truly new or invalidated patterns.</li>
          </ul>
        </details>
        <details>
          <summary>Valuation Fields</summary>
          <ul class="guide-list">
            <li><b>Discount %</b>: upside/downside versus analyst target.</li>
            <li><b>PEG</b>: P/E adjusted for growth; lower can indicate better value for growth.</li>
            <li><b>Deep Value</b> preset is stricter than Undervalued.</li>
          </ul>
        </details>
        <details>
          <summary>Technical Structure</summary>
          <ul class="guide-list">
            <li><b>Support</b>: area where buyers previously stepped in.</li>
            <li><b>Resistance</b>: area where sellers previously stepped in.</li>
            <li><b>Gaps</b>: unfilled zones often retested later.</li>
          </ul>
        </details>

        <h3>Run Schedule</h3>
        <ul class="guide-list">
          <li>Daily pipeline: weekdays at <b>22:00 UTC</b> (ingest → YOLO → report).</li>
          <li>Weekly YOLO pass: Saturday (regenerates report after run).</li>
          <li>Report tab always shows the latest completed run; no manual refresh button is required.</li>
        </ul>

        <h3>Common Mistakes</h3>
        <ul class="guide-list">
          <li>Trading one signal in isolation.</li>
          <li>Ignoring timeframe mismatch (weekly pattern vs short-term trade horizon).</li>
          <li>Treating old patterns as fresh without checking <b>age_days</b>.</li>
          <li>Ignoring liquidity/volume when evaluating breakouts.</li>
        </ul>

        <div style="margin-top:14px; padding:10px 14px; border-top:1px solid var(--line); color:var(--muted); font-size:0.82rem;">
          trader_koo uses public market data and may contain delays or gaps. Past performance is not indicative of future results.
        </div>
      </div>
    </section>
  </div>
  <footer class="site-footnote">
    <strong>Not Financial Advice.</strong> trader_koo is a research dashboard only. Market data and model outputs may be delayed, incomplete, or incorrect. Any investment decision and risk taken is solely your responsibility.
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);
    const tabOpBtn = $("tabOpBtn");
    const tabChartBtn = $("tabChartBtn");
    const tabGuideBtn = $("tabGuideBtn");
    const tabReportBtn = $("tabReportBtn");
    const tabOp = $("tabOp");
    const tabChart = $("tabChart");
    const tabGuide = $("tabGuide");
    const tabReport = $("tabReport");
    const API_BASE_STORAGE_KEY = "trader_koo_api_base";
    const ADMIN_KEY_STORAGE_KEY = "trader_koo_admin_api_key";
    const WATCHLIST_STORAGE_KEY = "trader_koo_watchlist";
    const TABLE_STATE = {};
    const DEFAULT_MONTHS = 3;
    let LAST_CHART_PAYLOAD = null;
    let LAST_REPORT_SETUP_ROWS = [];
    let CHART_TIMEFRAME = "daily"; // "daily" | "weekly"
    let _apiKey = "";

    function fmt(v, d = 2) {
      if (v === null || v === undefined || v === "" || Number.isNaN(Number(v))) return "-";
      return Number(v).toFixed(d);
    }

    function escHtml(v) {
      return String(v ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    const PERCENT_COLUMNS = new Set(["discount_pct", "eps_growth_5y", "atr_pct"]);
    const DECIMAL_BY_COLUMN = {
      price: 2,
      pe: 2,
      peg: 2,
      target_price: 2,
      discount_pct: 2,
      eps_growth_5y: 2,
      level: 2,
      zone_low: 2,
      zone_high: 2,
      gap_low: 2,
      gap_high: 2,
      score: 2,
      touches: 0,
      touch_count: 0,
      contracts: 0,
      call_oi: 0,
      put_oi: 0,
    };

    function formatTableValue(col, raw) {
      if (raw === null || raw === undefined || raw === "") return "-";
      if (typeof raw === "string" && /^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
      const n = Number(raw);
      if (!Number.isFinite(n)) return String(raw);

      if (PERCENT_COLUMNS.has(col)) {
        let v = n;
        if (col === "eps_growth_5y" && Math.abs(v) <= 2) v *= 100;
        return `${v.toFixed(DECIMAL_BY_COLUMN[col] ?? 2)}%`;
      }

      const d = DECIMAL_BY_COLUMN[col] ?? 2;
      return n.toLocaleString(undefined, {
        minimumFractionDigits: d,
        maximumFractionDigits: d,
      });
    }

    function renderOpFilterHelp(help) {
      const el = $("opFilterHelp");
      if (!el) return;
      if (!help) {
        el.innerHTML = `<div class="op-help-title">Filter Guide</div><div class="status-plain">Use presets, then refine using the fields.</div>`;
        return;
      }
      const rows = [
        ["View", help.view],
        ["Min Discount %", help.min_discount],
        ["Max PEG", help.max_peg],
        ["Overvalued Threshold %", help.overvalued_threshold],
      ];
      el.innerHTML = `
        <div class="op-help-title">Filter Guide</div>
        <div class="op-help-grid">
          ${rows.map(([k, v]) => `<div class="op-help-key">${escHtml(k)}</div><div class="op-help-val">${escHtml(v)}</div>`).join("")}
        </div>
      `;
    }

    function renderOpStatus(payload, view, rowCount) {
      const el = $("opStatus");
      if (!el) return;
      const snapRaw = payload.snapshot_ts || "";
      const snapDate = snapRaw ? new Date(snapRaw) : null;
      const hasSnap = snapDate && !Number.isNaN(snapDate.getTime());
      const snapUtc = hasSnap
        ? snapDate.toISOString().slice(0, 16).replace("T", " ") + " UTC"
        : (snapRaw || "-");
      const snapLocal = hasSnap
        ? snapDate.toLocaleString(undefined, {
            year: "numeric",
            month: "short",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
            timeZoneName: "short",
          })
        : "-";
      const sc = payload.source_counts || {};
      const chips = [
        ["Snapshot (UTC)", snapUtc],
        ["Local Time", snapLocal],
        ["View", view],
        ["Shown", rowCount ?? 0],
        ["Eligible", payload.eligible_count ?? "-"],
        ["Universe", payload.universe_count ?? "-"],
        ["Analyst", sc.analyst_target ?? 0],
        ["Model", sc.model_eps_pe ?? 0],
        ["Other", sc.other ?? 0],
      ];
      el.innerHTML = chips
        .map(([k, v]) => `<span class="status-chip"><span class="k">${escHtml(k)}</span><span class="v">${escHtml(v)}</span></span>`)
        .join("");
    }

    function normalizeBase(base) {
      return String(base || "").trim().replace(/\/+$/, "");
    }

    function getApiBase() {
      return normalizeBase($("apiBase").value);
    }

    function apiFetch(url, opts = {}) {
      const headers = { ...(opts.headers || {}) };
      if (_apiKey) headers["X-API-Key"] = _apiKey;
      return fetch(url, { ...opts, headers });
    }

    function setAdminApiKey(key) {
      _apiKey = String(key || "").trim();
      if (_apiKey) sessionStorage.setItem(ADMIN_KEY_STORAGE_KEY, _apiKey);
      else sessionStorage.removeItem(ADMIN_KEY_STORAGE_KEY);
    }

    async function adminFetch(url, opts = {}) {
      let resp = await apiFetch(url, opts);
      if (resp.status !== 401) return resp;
      const entered = window.prompt("Admin API key required. Paste key:");
      if (entered === null) return resp;
      setAdminApiKey(entered);
      resp = await apiFetch(url, opts);
      return resp;
    }

    async function initApiKey() {
      const params = new URLSearchParams(window.location.search);
      if (params.has("admin_key")) {
        // Never load admin keys from URL; strip if user pasted one.
        params.delete("admin_key");
        const qs = params.toString();
        const next = qs ? `${window.location.pathname}?${qs}${window.location.hash}` : `${window.location.pathname}${window.location.hash}`;
        window.history.replaceState({}, document.title, next);
      }
      setAdminApiKey(sessionStorage.getItem(ADMIN_KEY_STORAGE_KEY) || "");
    }

    function setApiBase(base, persist = true) {
      const clean = normalizeBase(base);
      $("apiBase").value = clean;
      if (persist && clean) localStorage.setItem(API_BASE_STORAGE_KEY, clean);
    }

    function buildApiCandidates() {
      const params = new URLSearchParams(window.location.search);
      const fromQuery = normalizeBase(params.get("api"));
      const fromStorage = normalizeBase(localStorage.getItem(API_BASE_STORAGE_KEY));
      const fromInput = normalizeBase($("apiBase").value);
      const isHttp = window.location.protocol === "http:" || window.location.protocol === "https:";
      const sameOrigin = isHttp ? normalizeBase(window.location.origin) : "";
      const host = window.location.hostname || "127.0.0.1";
      const host8000 = `http://${host}:8000`;
      const defaults = ["http://127.0.0.1:8000", "http://localhost:8000"];
      const candidates = [fromInput, fromQuery, fromStorage, sameOrigin, host8000, ...defaults].filter(Boolean);
      return [...new Set(candidates)];
    }

    async function probeApi(base, timeoutMs = 1200) {
      try {
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), timeoutMs);
        const resp = await fetch(`${base}/api/health`, { signal: controller.signal });
        clearTimeout(timer);
        return resp.ok;
      } catch {
        return false;
      }
    }

    async function initApiBase() {
      const candidates = buildApiCandidates();
      for (const c of candidates) {
        if (await probeApi(c)) {
          setApiBase(c, true);
          return;
        }
      }
      setApiBase(candidates[0] || "http://127.0.0.1:8000", true);
    }

    function setGlobalStatus(s) { $("globalStatus").textContent = s; }
    function setServiceStatus(s, bad = false) {
      const el = $("serviceStatus");
      el.textContent = s;
      el.style.color = bad ? "#ff8a8a" : "#8ea0bd";
    }

    async function refreshServiceStatus() {
      if (document.visibilityState === "hidden") return;
      const base = getApiBase();
      if (!base) {
        setServiceStatus("Service status: missing API base", true);
        return;
      }
      try {
        const resp = await apiFetch(`${base}/api/status`);
        if (!resp.ok) throw new Error(`${resp.status}`);
        const payload = await resp.json();
        const run = payload.latest_run || {};
        const pipe = payload.pipeline || {};
        const processed = run.tickers_processed ?? null;
        const total = run.tickers_total ?? null;
        const progress = (processed !== null && total !== null) ? `${processed}/${total}` : null;
        const txt = [
          `Connected`,
          `run=${run.status || "n/a"}`,
          `stage=${pipe.stage || payload.pipeline_stage || "n/a"}`,
          progress ? `progress=${progress}` : null,
          `tickers=${payload.counts?.tracked_tickers ?? "-"}`,
          `price_age=${payload.freshness?.price_age_days ?? "-"}d`
        ].filter(Boolean).join(" • ");
        setServiceStatus(txt, false);
      } catch (err) {
        setServiceStatus(`Offline (${err.message})`, true);
      }
    }

    async function triggerUpdate() {
      const base = getApiBase();
      if (!base) { alert("API base not resolved yet."); return; }
      const btn = $("triggerUpdateBtn");
      btn.disabled = true;
      btn.textContent = "Triggering...";
      try {
        const resp = await adminFetch(`${base}/api/admin/trigger-update`, { method: "POST" });
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        btn.textContent = "Triggered ✓";
        setTimeout(() => { btn.textContent = "Run Update"; btn.disabled = false; }, 5000);
      } catch (err) {
        alert(`Failed: ${err.message}`);
        btn.textContent = "Run Update";
        btn.disabled = false;
      }
    }

    function activateTab(which) {
      const all = { op: [tabOpBtn, tabOp], chart: [tabChartBtn, tabChart], guide: [tabGuideBtn, tabGuide], report: [tabReportBtn, tabReport] };
      for (const [k, [btn, sec]] of Object.entries(all)) {
        if (k === which) { btn.classList.add("active"); sec.classList.remove("hidden"); }
        else             { btn.classList.remove("active"); sec.classList.add("hidden"); }
      }
      if (which === "report") loadReport();
    }

    tabOpBtn.addEventListener("click", () => activateTab("op"));
    tabChartBtn.addEventListener("click", () => activateTab("chart"));
    tabGuideBtn.addEventListener("click", () => activateTab("guide"));
    tabReportBtn.addEventListener("click", () => activateTab("report"));

    function fillCards(payload) {
      const f = payload.fundamentals || {};
      const o = payload.options_summary || {};
      $("c-price").textContent = fmt(f.price);
      $("c-pe").textContent = fmt(f.pe);
      $("c-peg").textContent = fmt(f.peg);
      $("c-target").textContent = fmt(f.target_price);
      $("c-discount").textContent = fmt(f.discount_pct);
      $("c-pcr").textContent = fmt(o.put_call_oi_ratio, 3);
    }

    function renderSimpleTable(elId, columns, rows, clickable = false, onClick = null, opts = {}) {
      const state = TABLE_STATE[elId] || { sortCol: null, sortAsc: false };
      TABLE_STATE[elId] = state;
      const el = $(elId);
      let viewRows = [...rows];
      const searchId = opts.searchInputId || "";
      if (searchId && $(searchId)) {
        const q = String($(searchId).value || "").trim().toLowerCase();
        if (q) {
          viewRows = viewRows.filter((r) =>
            columns.some((c) => String(r[c] ?? "").toLowerCase().includes(q))
          );
        }
      }

      if (opts.sortable && state.sortCol) {
        const col = state.sortCol;
        const dir = state.sortAsc ? 1 : -1;
        viewRows.sort((a, b) => {
          const av = a[col], bv = b[col];
          const an = Number(av), bn = Number(bv);
          if (Number.isFinite(an) && Number.isFinite(bn)) return (an - bn) * dir;
          return String(av ?? "").localeCompare(String(bv ?? "")) * dir;
        });
      }

      const head = `<tr>${columns.map((c) => {
        if (!opts.sortable) return `<th>${c}</th>`;
        const marker = state.sortCol === c ? (state.sortAsc ? " ▲" : " ▼") : "";
        return `<th data-sort-col="${c}" style="cursor:pointer;">${c}${marker}</th>`;
      }).join("")}</tr>`;

      const body = viewRows.length
        ? viewRows.map((r, idx) => {
            const cls = clickable ? "clickable" : "";
            return `<tr class="${cls}" data-idx="${idx}">${columns.map(c => `<td>${formatTableValue(c, r[c])}</td>`).join("")}</tr>`;
          }).join("")
        : `<tr><td colspan="${columns.length}">No data</td></tr>`;
      el.innerHTML = head + body;

      if (opts.sortable) {
        el.querySelectorAll("th[data-sort-col]").forEach((th) => {
          th.addEventListener("click", () => {
            const c = th.getAttribute("data-sort-col");
            if (!c) return;
            if (state.sortCol === c) state.sortAsc = !state.sortAsc;
            else {
              state.sortCol = c;
              state.sortAsc = true;
            }
            renderSimpleTable(elId, columns, rows, clickable, onClick, opts);
          });
        });
      }

      if (searchId && $(searchId)) {
        $(searchId).oninput = () => renderSimpleTable(elId, columns, rows, clickable, onClick, opts);
      }

      if (clickable && onClick) {
        el.querySelectorAll("tr.clickable").forEach((tr) => {
          tr.addEventListener("click", () => {
            const idx = Number(tr.getAttribute("data-idx"));
            onClick(viewRows[idx]);
          });
        });
      }
    }

    function computeYRangeForXWindow(x, low, high, x0, x1) {
      if (!x.length) return null;
      const t0 = x0 ? new Date(x0).getTime() : -Infinity;
      const t1 = x1 ? new Date(x1).getTime() : Infinity;
      let minY = Number.POSITIVE_INFINITY;
      let maxY = Number.NEGATIVE_INFINITY;
      for (let i = 0; i < x.length; i++) {
        const t = new Date(x[i]).getTime();
        if (Number.isNaN(t) || t < t0 || t > t1) continue;
        const lo = Number(low[i]);
        const hi = Number(high[i]);
        if (Number.isFinite(lo)) minY = Math.min(minY, lo);
        if (Number.isFinite(hi)) maxY = Math.max(maxY, hi);
      }
      if (!Number.isFinite(minY) || !Number.isFinite(maxY)) {
        const allLow = low.filter(Number.isFinite);
        const allHigh = high.filter(Number.isFinite);
        if (!allLow.length || !allHigh.length) return null;
        minY = Math.min(...allLow);
        maxY = Math.max(...allHigh);
      }
      const span = Math.max(maxY - minY, Math.abs(maxY) * 0.01, 1e-6);
      const pad = span * 0.08;
      return [minY - pad, maxY + pad];
    }

    function extendYRangeWithLevelValues(range, levelValues) {
      if (!range || !Array.isArray(range) || range.length !== 2) return range;
      const baseLo = Number(range[0]);
      const baseHi = Number(range[1]);
      if (!Number.isFinite(baseLo) || !Number.isFinite(baseHi)) return range;
      const span = Math.max(baseHi - baseLo, Math.abs(baseHi) * 0.01, 1e-6);
      const nearLo = baseLo - span * 0.35;
      const nearHi = baseHi + span * 0.35;

      let lo = baseLo;
      let hi = baseHi;
      for (const vRaw of (levelValues || [])) {
        const v = Number(vRaw);
        if (!Number.isFinite(v)) continue;
        if (v < nearLo || v > nearHi) continue;
        lo = Math.min(lo, v);
        hi = Math.max(hi, v);
      }
      const newSpan = Math.max(hi - lo, Math.abs(hi) * 0.01, 1e-6);
      const pad = newSpan * 0.08;
      return [lo - pad, hi + pad];
    }

    function resampleToWeekly(chart) {
      // ISO week key → use last trading day of that week as the bar date
      const isoWeek = (ds) => {
        const d = new Date(ds + "T12:00:00Z");
        const day = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - day); // Thursday anchor
        const yr = d.getUTCFullYear();
        const jan4 = new Date(Date.UTC(yr, 0, 4));
        const wk = Math.ceil(((d - jan4) / 864e5 + (jan4.getUTCDay() || 7)) / 7);
        return `${yr}-${String(wk).padStart(2, "0")}`;
      };
      const weeks = new Map();
      for (const row of chart) {
        const key = isoWeek(row.date);
        if (!weeks.has(key)) {
          weeks.set(key, { date: row.date, open: Number(row.open), high: Number(row.high), low: Number(row.low), close: Number(row.close), volume: Number(row.volume) || 0 });
        } else {
          const w = weeks.get(key);
          w.high = Math.max(w.high, Number(row.high));
          w.low  = Math.min(w.low,  Number(row.low));
          w.close = Number(row.close);
          w.date  = row.date; // last trading day of the week
          w.volume += Number(row.volume) || 0;
        }
      }
      return Array.from(weeks.values());
    }

    function renderChart(payload) {
      LAST_CHART_PAYLOAD = payload;
      const isWeeklyChart = CHART_TIMEFRAME === "weekly";
      const rawChart = payload.chart || [];
      const chart = isWeeklyChart ? resampleToWeekly(rawChart) : rawChart;
      const levels = payload.levels || [];
      const gaps = payload.gaps || [];
      const trendlines = payload.trendlines || [];
      const patterns = payload.patterns || [];
      const patternOverlays = payload.pattern_overlays || [];
      const yoloPatterns = payload.yolo_patterns || [];
      const ticker = payload.ticker || "N/A";
      const showTrendlines = $("showTrendlines") ? Boolean($("showTrendlines").checked) : false;
      const showPatterns = $("showPatterns") ? Boolean($("showPatterns").checked) : true;
      const showRuleClassLines = $("showRuleClassLines") ? Boolean($("showRuleClassLines").checked) : true;
      const showCvClassLines = $("showCvClassLines") ? Boolean($("showCvClassLines").checked) : true;
      const showYoloPatterns = $("showYoloPatterns") ? Boolean($("showYoloPatterns").checked) : true;

      const x = chart.map(r => r.date);
      const open = chart.map(r => Number(r.open));
      const high = chart.map(r => Number(r.high));
      const low = chart.map(r => Number(r.low));
      const close = chart.map(r => Number(r.close));
      const vol = chart.map(r => Number(r.volume || 0));
      const volColor = chart.map(r => Number(r.close) >= Number(r.open) ? "rgba(56,211,159,0.7)" : "rgba(255,107,107,0.7)");

      const ma = (arr, n) => arr.map((_, i) => {
        if (i < n - 1) return null;
        let s = 0;
        for (let j = i - n + 1; j <= i; j++) s += arr[j];
        return s / n;
      });

      const traces = [
        {
          type: "candlestick",
          x, open, high, low, close,
          name: ticker, xaxis: "x", yaxis: "y",
          increasing: {line: {color: "#38d39f"}, fillcolor: "rgba(56,211,159,0.85)"},
          decreasing: {line: {color: "#ff6b6b"}, fillcolor: "rgba(255,107,107,0.85)"}
        },
        { type: "scatter", mode: "lines", x, y: ma(close, 20), name: "MA20", line: {color:"#6aa9ff", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 50), name: "MA50", line: {color:"#f8c24e", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 100), name: "MA100", line: {color:"#38d39f", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "scatter", mode: "lines", x, y: ma(close, 200), name: "MA200", line: {color:"#c07bff", width:1.2}, xaxis:"x", yaxis:"y" },
        { type: "bar", x, y: vol, name: "Volume", marker: {color: volColor}, xaxis:"x2", yaxis:"y2" }
      ];

      const candlePatterns = payload.candlestick_patterns || [];
      if (candlePatterns.length > 0) {
        const bullish = candlePatterns.filter(p => String(p.bias || "").toLowerCase() === "bullish");
        const bearish = candlePatterns.filter(p => String(p.bias || "").toLowerCase() === "bearish");
        if (bullish.length > 0) {
          traces.push({
            type: "scatter", mode: "markers",
            x: bullish.map(p => p.date),
            y: bullish.map(p => { const i = x.indexOf(p.date); return i >= 0 ? low[i] * 0.994 : null; }),
            name: "Bullish Signal",
            marker: {symbol: "triangle-up", size: 9, color: "#38d39f"},
            hovertext: bullish.map(p => `${p.pattern} (${fmt(p.confidence)})`),
            hoverinfo: "text+x", xaxis: "x", yaxis: "y"
          });
        }
        if (bearish.length > 0) {
          traces.push({
            type: "scatter", mode: "markers",
            x: bearish.map(p => p.date),
            y: bearish.map(p => { const i = x.indexOf(p.date); return i >= 0 ? high[i] * 1.006 : null; }),
            name: "Bearish Signal",
            marker: {symbol: "triangle-down", size: 9, color: "#ff6b6b"},
            hovertext: bearish.map(p => `${p.pattern} (${fmt(p.confidence)})`),
            hoverinfo: "text+x", xaxis: "x", yaxis: "y"
          });
        }
      }

      const lastDate = x.length ? x[x.length - 1] : null;
      const selectedMonths = DEFAULT_MONTHS; // default view window; use rangeselector to zoom
      const defaultX0 = (() => {
        if (!lastDate) return null;
        if (selectedMonths <= 0) return x.length ? x[0] : null;
        const d = new Date(lastDate);
        d.setMonth(d.getMonth() - selectedMonths);
        return d.toISOString().slice(0, 10);
      })();
      const defaultX1 = lastDate || null;
      const levelValues = levels.map((r) => Number(r.level)).filter(Number.isFinite);
      const baseDefaultY = computeYRangeForXWindow(x, low, high, defaultX0, defaultX1);
      const defaultY = extendYRangeWithLevelValues(baseDefaultY, levelValues);

      const isMobile = window.innerWidth < 640;
      const shapes = [];
      const annotations = [];

      levels.forEach(r => {
        const lvl = Number(r.level);
        if (Number.isNaN(lvl)) return;
        const color = r.type === "support" ? "#3f8cff" : "#ff7b5b";
        const tier = (r.tier || "primary").toLowerCase();
        const dash = tier === "primary" ? "solid" : (tier === "secondary" ? "dot" : "dash");
        const width = tier === "primary" ? 2 : (tier === "secondary" ? 1 : 1.5);
        const tierLabel = tier === "primary" ? "PRIMARY" : (tier === "secondary" ? "SECONDARY" : "FALLBACK");
        const z0 = Number(r.zone_low);
        const z1 = Number(r.zone_high);
        if (!Number.isNaN(z0) && !Number.isNaN(z1)) {
          shapes.push({
            type: "rect", xref: "paper", yref: "y",
            x0: 0, x1: 1, y0: Math.min(z0, z1), y1: Math.max(z0, z1),
            fillcolor: r.type === "support" ? "rgba(63,140,255,0.10)" : "rgba(255,123,91,0.10)",
            line: {width: 0}
          });
        }
        shapes.push({
          type: "line", xref: "paper", yref: "y",
          x0: 0, x1: 1, y0: lvl, y1: lvl,
          line: {color, width, dash}
        });
        annotations.push({
          xref: "paper", yref: "y", x: 1.0, y: lvl,
          text: isMobile
            ? fmt(lvl)
            : `${tierLabel} ${String(r.type).toUpperCase()}<br>${fmt(lvl)} (${r.touches ?? "-"})`,
          showarrow: false, xanchor: "left", yanchor: "middle", align: "left",
          xshift: 4, borderpad: 2,
          bgcolor: "rgba(18,25,39,0.9)", bordercolor: color,
          font: {color, size: isMobile ? 10 : 11}
        });
      });

      gaps.forEach(g => {
        const y0 = Number(g.gap_low), y1 = Number(g.gap_high);
        if (Number.isNaN(y0) || Number.isNaN(y1)) return;
        shapes.push({
          type: "rect", xref: "x", yref: "y",
          x0: g.date, x1: x[x.length - 1], y0, y1,
          fillcolor: g.type === "bull_gap" ? "rgba(248,194,78,0.22)" : "rgba(106,169,255,0.20)",
          line: {width: 1, color: "rgba(142,160,189,0.6)"}
        });
      });

      if (showTrendlines) trendlines.forEach(t => {
        const y0 = Number(t.y0);
        const y1 = Number(t.y1);
        if (Number.isNaN(y0) || Number.isNaN(y1)) return;
        const color = String(t.type || "").includes("support") ? "#38d39f" : "#ff6b6b";
        shapes.push({
          type: "line",
          xref: "x",
          yref: "y",
          x0: t.x0_date,
          x1: t.x1_date,
          y0,
          y1,
          line: {color, width: 1.6, dash: "dot"}
        });
      });

      if (showPatterns) {
        const patternColor = (nameRaw) => {
          const name = String(nameRaw || "").toLowerCase();
          if (
            name.includes("bull")
            || name.includes("falling_wedge")
            || name.includes("ascending_triangle")
            || name.includes("double_bottom")
            || name.includes("inv_head")
          ) return "#38d39f";
          if (
            name.includes("bear")
            || name.includes("rising_wedge")
            || name.includes("descending_triangle")
            || name.includes("double_top")
            || name.includes("head_and_shoulders")
          ) return "#ff6b6b";
          return "#f8c24e";
        };
        const sourceDash = (sRaw) => {
          const s = String(sRaw || "").toLowerCase();
          if (s === "cv_proxy") return "dashdot";
          if (s === "hybrid_rule") return "solid";
          return "dot";
        };

        let overlays = patternOverlays.filter((p) => {
          const src = String(p.source || "");
          if (!showRuleClassLines && (src === "rule" || src === "hybrid_rule")) return false;
          if (!showCvClassLines && src === "cv_proxy") return false;
          return true;
        });

        if (!overlays.length) {
          overlays = patterns.slice(0, 4).map((p) => ({
            source: "rule",
            class_name: p.pattern,
            status: p.status,
            confidence: p.confidence,
            x0_date: p.x0_date,
            x1_date: p.x1_date,
            y0: p.y0,
            y1: p.y1,
            y0b: p.y0b,
            y1b: p.y1b,
            notes: p.notes,
          }));
        }

        overlays = overlays
          .slice()
          .sort((a, b) => Number(b.confidence || 0) - Number(a.confidence || 0))
          .slice(0, 10);

        overlays.forEach((p, idx) => {
          const y0 = Number(p.y0);
          const y1 = Number(p.y1);
          const y0b = Number(p.y0b);
          const y1b = Number(p.y1b);
          if ([y0, y1, y0b, y1b].some(Number.isNaN)) return;
          const className = String(p.class_name || p.pattern || "pattern");
          const status = String(p.status || "forming");
          const source = String(p.source || "rule");
          const conf = Number(p.confidence);
          const color = patternColor(className);
          const dash = sourceDash(source);
          const width = source === "hybrid_rule" ? 2.1 : 1.7;
          const shortSrc = source === "hybrid_rule" ? "HYB" : (source === "cv_proxy" ? "CV" : "RULE");

          shapes.push({
            type: "line",
            xref: "x",
            yref: "y",
            x0: p.x0_date,
            x1: p.x1_date,
            y0,
            y1,
            line: {color, width, dash},
          });
          shapes.push({
            type: "line",
            xref: "x",
            yref: "y",
            x0: p.x0_date,
            x1: p.x1_date,
            y0: y0b,
            y1: y1b,
            line: {color, width, dash},
          });
          if (!isMobile) {
            annotations.push({
              xref: "paper",
              yref: "paper",
              x: 0.01,
              y: 0.98 - idx * 0.045,
              text: `${className.replaceAll("_", " ")} • ${shortSrc} • ${status} • ${fmt(conf, 2)}`,
              showarrow: false,
              xanchor: "left",
              yanchor: "top",
              bgcolor: "rgba(18,25,39,0.85)",
              bordercolor: color,
              font: {color, size: 11},
            });
          }
        });
      }

      if (showYoloPatterns && yoloPatterns.length > 0) {
        const yoloColorMap = {
          bull: {stroke: "#38d39f", fill: "rgba(56,211,159,0.07)"},
          bear: {stroke: "#ff6b6b", fill: "rgba(255,107,107,0.07)"},
          neutral: {stroke: "#f8c24e", fill: "rgba(248,194,78,0.07)"},
        };
        const yoloLabel = (nameRaw, compact = false) => {
          const raw = String(nameRaw || "").replaceAll("_", " ").trim();
          const map = {
            "Head and shoulders bottom": "H&S Bottom",
            "Head and shoulders top": "H&S Top",
            "M Head": "M Head",
            "W Bottom": "W Bottom",
            "StockLine": "Stock Line",
          };
          let label = map[raw] || raw || "Pattern";
          if (compact) {
            const compactMap = {
              "H&S Bottom": "H&S Bot",
              "H&S Top":    "H&S Top",
              "W Bottom":   "W Bot",
              "M Head":     "M Head",
              "Stock Line": "StkLine",
              "Triangle":   "Triangle",
            };
            label = compactMap[label] ?? (label.length > 10 ? `${label.slice(0, 10)}…` : label);
          }
          return label;
        };
        const yoloStyle = (nameRaw) => {
          const n = String(nameRaw || "").toLowerCase();
          if (n.includes("bottom") || n.includes("w_bottom") || n.includes("shoulders bottom")) return yoloColorMap.bull;
          if (n.includes("top") || n.includes("m_head") || n.includes("shoulders top")) return yoloColorMap.bear;
          return yoloColorMap.neutral;
        };
        // Separate daily vs weekly so weekly renders with a wider, dashed border
        const dailyPatterns = yoloPatterns.filter(p => (p.timeframe || "daily") === "daily");
        const weeklyPatterns = yoloPatterns.filter(p => p.timeframe === "weekly");

        const renderYoloGroup = (group, isWeekly) => {
          const borderWidth = isWeekly ? 2.2 : 1.5;
          const borderDash = isWeekly ? "dash" : "dot";
          const fillOpacity = isWeekly ? "0.05" : "0.07";
          const maxLabels = isMobile ? (isWeekly ? 2 : 3) : 5;
          let labelCount = 0;
          group.forEach((p) => {
            const y0 = Number(p.y0), y1 = Number(p.y1);
            if (Number.isNaN(y0) || Number.isNaN(y1)) return;
            const baseStyle = yoloStyle(p.pattern);
            // Weekly uses slightly muted colours to not compete with daily boxes
            const stroke = isWeekly ? baseStyle.stroke + "cc" : baseStyle.stroke;
            const fill = baseStyle.fill.replace(/[\d.]+\)$/, `${fillOpacity})`);
            const conf = Number(p.confidence);
            const label = isWeekly ? "W" : "D";
            shapes.push({
              type: "rect",
              xref: "x",
              yref: "y",
              x0: p.x0_date,
              x1: p.x1_date,
              y0: Math.min(y0, y1),
              y1: Math.max(y0, y1),
              line: {color: stroke, width: borderWidth, dash: borderDash},
              fillcolor: fill,
            });
            if (labelCount < maxLabels) {
              const confPct = Number.isFinite(conf) ? `${(conf * 100).toFixed(0)}%` : "";
              const labelName = yoloLabel(p.pattern, isMobile);
              const text = isMobile
                ? `${label}:${labelName} ${confPct}`
                : `[${label}] ${yoloLabel(p.pattern, false)} ${confPct}`;
              const yTop = Math.max(y0, y1);
              annotations.push({
                xref: "x",
                yref: "y",
                x: isMobile ? p.x0_date : p.x1_date,
                y: yTop,
                text,
                showarrow: false,
                xanchor: "left",
                yanchor: isMobile ? "top" : "bottom",
                xshift: isMobile ? 2 : 4,
                yshift: isMobile ? -2 : 0,
                bgcolor: "rgba(18,25,39,0.85)",
                bordercolor: baseStyle.stroke,
                font: {color: baseStyle.stroke, size: isMobile ? 8 : (isWeekly ? 9 : 10)},
              });
              labelCount++;
            }
          });
        };

        renderYoloGroup(dailyPatterns, false);
        renderYoloGroup(weeklyPatterns, true);
      }

      const layout = {
        paper_bgcolor: "#121927",
        plot_bgcolor: "#121927",
        font: {color: "#e9eef8"},
        margin: isMobile ? {t: 40, l: 45, r: 80, b: 40} : {t: 40, l: 60, r: 235, b: 50},
        dragmode: "zoom",
        legend: isMobile
          ? {orientation: "h", y: -0.08, x: 0, xanchor: "left", font: {size: 10}}
          : {orientation: "h", y: -0.04, x: 0, xanchor: "left"},
        xaxis: {
          domain: [0, 1], anchor: "y", rangeslider: {visible: false},
          showgrid: true, gridcolor: "#25334f",
          range: defaultX0 && defaultX1 ? [defaultX0, defaultX1] : undefined,
          rangebreaks: [{bounds: ["sat", "mon"]}],
          rangeselector: {
            bgcolor: "#e9eef8",
            activecolor: "#6aa9ff",
            bordercolor: "#0b0f16",
            borderwidth: 1,
            font: {color: "#0b0f16", size: 12},
            buttons: [
              {count: 3, step: "month", stepmode: "backward", label: "3M"},
              {count: 6, step: "month", stepmode: "backward", label: "6M"},
              {count: 1, step: "year", stepmode: "todate", label: "YTD"},
              {count: 1, step: "year", stepmode: "backward", label: "1Y"},
              {count: 2, step: "year", stepmode: "backward", label: "2Y"},
              {step: "all", label: "ALL"}
            ]
          }
        },
        yaxis: {
          domain: [0.30, 1],
          showgrid: true,
          gridcolor: "#25334f",
          title: "Price",
          range: defaultY || undefined,
          autorange: !defaultY
        },
        xaxis2: {domain: [0, 1], anchor: "y2", matches: "x", showgrid: false},
        yaxis2: {domain: [0, 0.24], showgrid: true, gridcolor: "#25334f", title: "Volume"},
        shapes,
        annotations
      };

      Plotly.newPlot("chart", traces, layout, {responsive: true, scrollZoom: true, displayModeBar: true});
      const chartEl = $("chart");
      let ySyncLock = false;
      chartEl.on("plotly_relayout", (ev) => {
        if (ySyncLock) return;
        const hasXRange = "xaxis.range[0]" in ev || Array.isArray(ev["xaxis.range"]);
        const allX = ev["xaxis.autorange"] === true;
        if (!hasXRange && !allX) return; // ignore Y-only or unrelated events — prevents snap-back
        const r0 = ev["xaxis.range[0]"] ?? (Array.isArray(ev["xaxis.range"]) ? ev["xaxis.range"][0] : null);
        const r1 = ev["xaxis.range[1]"] ?? (Array.isArray(ev["xaxis.range"]) ? ev["xaxis.range"][1] : null);
        const baseYr = allX
          ? computeYRangeForXWindow(x, low, high, x[0], x[x.length - 1])
          : computeYRangeForXWindow(x, low, high, r0 || x[0], r1 || x[x.length - 1]);
        const yr = extendYRangeWithLevelValues(baseYr, levelValues);
        if (!yr) return;
        ySyncLock = true;
        Plotly.relayout("chart", {"yaxis.range": yr})
          .catch(() => {})
          .finally(() => { ySyncLock = false; });
      });
    }

    function setOpportunityFilters({view, minDiscount, maxPeg, overvaluedThreshold, limitRows}) {
      if (view !== undefined) $("opView").value = String(view);
      if (minDiscount !== undefined) $("minDiscount").value = String(minDiscount);
      if (maxPeg !== undefined) $("maxPeg").value = String(maxPeg);
      if (overvaluedThreshold !== undefined) $("overvaluedThreshold").value = String(overvaluedThreshold);
      if (limitRows !== undefined) $("limitRows").value = String(limitRows);
    }

    function applyOpportunityPreset(name) {
      if ($("opSearch")) $("opSearch").value = "";
      if (name === "all") {
        setOpportunityFilters({ view: "all", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "undervalued") {
        setOpportunityFilters({ view: "undervalued", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "deep_value") {
        setOpportunityFilters({ view: "deep_value", minDiscount: 20, maxPeg: 1.5, overvaluedThreshold: -10, limitRows: 500 });
      } else if (name === "overvalued") {
        setOpportunityFilters({ view: "overvalued", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      } else {
        setOpportunityFilters({ view: "all", minDiscount: 10, maxPeg: 2.0, overvaluedThreshold: -10, limitRows: 500 });
      }
      loadOpportunities();
    }

    async function loadOpportunities() {
      const base = getApiBase();
      const view = String($("opView").value || "all");
      const apiView = view === "deep_value" ? "undervalued" : view;
      const minDiscount = Number($("minDiscount").value || 10);
      const maxPeg = Number($("maxPeg").value || 2);
      const overvaluedThreshold = Number($("overvaluedThreshold").value || -10);
      const limitRows = Number($("limitRows").value || 500);
      const btn = $("loadOpBtn");
      btn.disabled = true;
      $("opStatus").innerHTML = `<span class="status-plain">Loading opportunities...</span>`;
      setGlobalStatus("Loading opportunities...");
      try {
        const q = new URLSearchParams({
          limit: String(limitRows),
          min_discount: String(minDiscount),
          max_peg: String(maxPeg),
          overvalued_threshold: String(overvaluedThreshold),
          view: apiView,
        });
        const resp = await apiFetch(`${base}/api/opportunities?${q.toString()}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        const rows = payload.rows || [];
        renderOpFilterHelp(payload.filter_help || null);
        renderSimpleTable(
          "opTable",
          ["ticker", "price", "pe", "peg", "target_price", "discount_pct", "valuation_label", "eps_growth_5y"],
          rows,
          true,
          (row) => {
            $("ticker").value = row.ticker;
            activateTab("chart");
            loadChart();
          },
          { sortable: true, searchInputId: "opSearch" }
        );
        renderOpStatus(payload, view, rows.length);
        setGlobalStatus("Opportunities loaded");
      } catch (err) {
        console.error(err);
        $("opStatus").innerHTML = `<span class="status-plain" style="color:#ff8a8a;">Failed: ${escHtml(err.message)}</span>`;
        setGlobalStatus("Failed loading opportunities");
      } finally {
        btn.disabled = false;
      }
    }

    async function loadChart() {
      const ticker = ($("ticker").value || "SPY").trim().toUpperCase();
      const months = 0; // always fetch all data; view window controlled by rangeselector
      const base = getApiBase();
      const btn = $("loadChartBtn");
      btn.disabled = true;
      $("chartStatus").textContent = `Loading ${ticker}...`;
      setGlobalStatus(`Loading ${ticker} dashboard...`);
      try {
        const resp = await apiFetch(`${base}/api/dashboard/${ticker}?months=${months}`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const payload = await resp.json();
        fillCards(payload);
        renderChart(payload);
        renderSimpleTable("levelsTable", ["type", "level", "zone_low", "zone_high", "tier", "touches", "last_touch_date"], payload.levels || [], false, null, { sortable: true });
        renderSimpleTable("gapsTable", ["date", "type", "gap_low", "gap_high"], payload.gaps || [], false, null, { sortable: true });
        renderSimpleTable("trendlinesTable", ["type", "touch_count", "score", "last_touch_date"], payload.trendlines || [], false, null, { sortable: true });
        renderSimpleTable("patternsTable", ["pattern", "status", "confidence", "start_date", "end_date"], payload.patterns || [], false, null, { sortable: true });
        renderSimpleTable(
          "hybridPatternsTable",
          ["pattern", "status", "hybrid_confidence", "base_confidence", "candle_score", "volume_score", "breakout_score", "candle_bias", "vol_ratio", "start_date", "end_date"],
          payload.hybrid_patterns || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable(
          "cvProxyPatternsTable",
          ["pattern", "status", "cv_confidence", "method", "start_date", "end_date", "notes"],
          payload.cv_proxy_patterns || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable(
          "hybridCvCompareTable",
          ["pattern", "hybrid_status", "cv_status", "hybrid_confidence", "cv_confidence", "consensus_confidence", "agreement", "confidence_gap"],
          payload.hybrid_cv_compare || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable(
          "patternOverlaysTable",
          ["source", "class_name", "status", "confidence", "start_date", "end_date"],
          payload.pattern_overlays || [],
          false,
          null,
          { sortable: true }
        );
        renderSimpleTable("candlesTable", ["date", "pattern", "bias", "confidence", "explanation"], payload.candlestick_patterns || [], false, null, { sortable: true });
        renderSimpleTable("yoloPatternsTable", ["timeframe", "pattern", "confidence", "x0_date", "x1_date", "y0", "y1", "as_of_date"], payload.yolo_patterns || [], false, null, { sortable: true });
        $("chartStatus").textContent = `asof ${payload.asof || "-"} • ${ticker}`;
        setGlobalStatus(`Done (${ticker})`);
      } catch (err) {
        console.error(err);
        $("chartStatus").textContent = `Failed: ${err.message}`;
        setGlobalStatus(`Failed (${ticker})`);
      } finally {
        btn.disabled = false;
      }
    }

    async function loadTickerUniverse() {
      const base = getApiBase();
      try {
        const resp = await apiFetch(`${base}/api/tickers?limit=2000`);
        if (!resp.ok) throw new Error(`${resp.status}`);
        const payload = await resp.json();
        const list = $("tickerList");
        if (!list) return;
        list.innerHTML = "";
        (payload.tickers || []).forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t;
          list.appendChild(opt);
        });
      } catch (err) {
        console.warn("ticker universe load failed", err);
      }
    }

    function loadTickerQuick(t) {
      $("ticker").value = t;
      activateTab("chart");
      loadChart();
    }

    function jumpToTicker(ticker) {
      loadTickerQuick(ticker);
    }
    window.jumpToTicker = jumpToTicker;

    function normalizeTickerSymbol(v) {
      return String(v || "").trim().toUpperCase().replace(/\s+/g, "");
    }

    function getStoredWatchlist() {
      try {
        const raw = localStorage.getItem(WATCHLIST_STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return [...new Set(arr.map(normalizeTickerSymbol).filter(Boolean))];
      } catch {
        return [];
      }
    }

    function saveStoredWatchlist(list) {
      localStorage.setItem(WATCHLIST_STORAGE_KEY, JSON.stringify([...new Set((list || []).map(normalizeTickerSymbol).filter(Boolean))]));
    }

    function addTickerToWatchlist(ticker) {
      const symbol = normalizeTickerSymbol(ticker);
      if (!symbol) return false;
      const list = getStoredWatchlist();
      if (!list.includes(symbol)) list.push(symbol);
      saveStoredWatchlist(list);
      renderWatchlistTable();
      return true;
    }
    window.addTickerToWatchlist = addTickerToWatchlist;

    function removeTickerFromWatchlist(ticker) {
      const symbol = normalizeTickerSymbol(ticker);
      const list = getStoredWatchlist().filter((t) => t !== symbol);
      saveStoredWatchlist(list);
      renderWatchlistTable();
    }
    window.removeTickerFromWatchlist = removeTickerFromWatchlist;

    function renderWatchlistTable() {
      const el = $("reportWatchTable");
      if (!el) return;
      const hint = $("reportWatchHint");
      const list = getStoredWatchlist();
      const setupMap = new Map((LAST_REPORT_SETUP_ROWS || []).map((r) => [String(r.ticker || "").toUpperCase(), r]));

      const head = "<tr><th>ticker</th><th>score</th><th>pct_change</th><th>setup_tier</th><th>yolo_pattern</th><th>actions</th></tr>";
      if (!list.length) {
        el.innerHTML = `${head}<tr><td colspan=\"6\">No watchlist tickers yet</td></tr>`;
        if (hint) hint.textContent = "Tip: Add symbols manually or import top setup candidates.";
        return;
      }

      const rowsHtml = list
        .map((ticker) => {
          const row = setupMap.get(ticker) || {};
          const score = row.score ?? "-";
          const pct = row.pct_change ?? "-";
          const tier = row.setup_tier ?? "-";
          const yolo = row.yolo_pattern || "-";
          return (
            `<tr>` +
            `<td>${escHtml(ticker)}</td>` +
            `<td>${escHtml(score)}</td>` +
            `<td>${escHtml(pct)}</td>` +
            `<td>${escHtml(tier)}</td>` +
            `<td>${escHtml(yolo)}</td>` +
            `<td>` +
            `<button type="button" data-watch-load="${escHtml(ticker)}" style="width:auto; padding:5px 8px; margin-right:6px;">Load</button>` +
            `<button type="button" data-watch-remove="${escHtml(ticker)}" style="width:auto; padding:5px 8px;">Remove</button>` +
            `</td>` +
            `</tr>`
          );
        })
        .join("");
      el.innerHTML = head + rowsHtml;
      if (hint) hint.textContent = `${list.length} ticker(s) saved locally in this browser.`;

      el.querySelectorAll("button[data-watch-load]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-watch-load");
          if (t) loadTickerQuick(t);
        });
      });
      el.querySelectorAll("button[data-watch-remove]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.getAttribute("data-watch-remove");
          if (t) removeTickerFromWatchlist(t);
        });
      });
    }

    async function loadReport() {
      const base = getApiBase();
      $("reportStatus").textContent = "Loading...";
      try {
        const resp = await apiFetch(`${base}/api/daily-report?limit=20`);
        if (!resp.ok) throw new Error(`${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        const latest = data.latest || {};
        const counts = latest.counts || {};
        const yoloBlock = latest.yolo || {};
        const yoloSummary = yoloBlock.summary || {};
        const ingestRun = latest.latest_ingest_run || {};
        const signals = latest.signals || {};
        const hasReport = data.ok && Object.keys(latest).length > 0;

        $("reportNoData").style.display = hasReport ? "none" : "block";
        if (!hasReport) { $("reportStatus").textContent = "No report yet"; return; }

        const makeCard = (label, val) =>
          `<div class="card"><div class="label">${label}</div><div class="value">${val ?? "—"}</div></div>`;

        $("reportSummaryCards").innerHTML = [
          makeCard("Generated (UTC)", (latest.generated_ts || "—").slice(0, 16).replace("T", " ")),
          makeCard("Tracked Tickers", counts.tracked_tickers ?? "—"),
          makeCard("Price Rows", (counts.price_rows ?? 0).toLocaleString()),
          makeCard("Latest Price Date", (latest.latest_data || {}).price_date ?? "—"),
          makeCard("Last Ingest", ingestRun.status ?? "—"),
        ].join("");

        const tfDaily  = (yoloBlock.timeframes || []).find(t => t.timeframe === "daily")  || {};
        const tfWeekly = (yoloBlock.timeframes || []).find(t => t.timeframe === "weekly") || {};
        $("reportYoloCards").innerHTML = [
          makeCard("YOLO Total Rows", yoloSummary.rows_total ?? "—"),
          makeCard("YOLO Tickers", yoloSummary.tickers_with_patterns ?? "—"),
          makeCard("Daily Tickers", tfDaily.tickers_with_patterns  ?? "—"),
          makeCard("Weekly Tickers", tfWeekly.tickers_with_patterns ?? "—"),
        ].join("");

        const keyChanges = signals.tonight_key_changes || [];
        $("reportKeyChangesList").innerHTML = keyChanges.length
          ? keyChanges
              .slice(0, 5)
              .map((row) => `<li><b>${escHtml(row.title || "Change")}:</b> ${escHtml(row.detail || "-")}</li>`)
              .join("")
          : "<li>No material changes captured.</li>";

        const setupRows = (signals.setup_quality_top || []).slice(0, 40);
        LAST_REPORT_SETUP_ROWS = setupRows;
        $("reportSetupSummary").textContent = setupRows.length
          ? `Score combines valuation (discount/PEG), one-day momentum, 52W proximity, and latest YOLO confidence/age. Top ${Math.min(25, setupRows.length)} shown below.`
          : "No setup-quality rows available yet.";
        renderSimpleTable(
          "reportSetupQualityTable",
          ["ticker", "score", "setup_tier", "sector", "pct_change", "discount_pct", "peg", "yolo_pattern", "yolo_confidence", "yolo_age_days"],
          setupRows.slice(0, 25),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: true },
        );
        $("reportSetupQuickAdds").innerHTML = setupRows
          .slice(0, 10)
          .map((row) => `<button type="button" data-watch-add="${escHtml(row.ticker)}">+ ${escHtml(row.ticker)}</button>`)
          .join("");
        $("reportSetupQuickAdds").querySelectorAll("button[data-watch-add]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const t = btn.getAttribute("data-watch-add");
            if (!t) return;
            addTickerToWatchlist(t);
          });
        });

        const sectorRows = signals.sector_heatmap || [];
        const maxAbs = Math.max(1, ...sectorRows.map((r) => Math.abs(Number(r.avg_pct_change || 0))));
        $("reportSectorHeatmap").innerHTML = sectorRows
          .slice(0, 12)
          .map((r) => {
            const avg = Number(r.avg_pct_change || 0);
            const width = Math.max(2, Math.round((Math.abs(avg) / maxAbs) * 100));
            const color = avg >= 0 ? "linear-gradient(90deg,#1f8f66,#38d39f)" : "linear-gradient(90deg,#cc5a5a,#ff6b6b)";
            return (
              `<div class="heat-row">` +
              `<div>${escHtml(r.sector || "Unknown")}</div>` +
              `<div class="heat-track"><div class="heat-fill" style="width:${width}%; background:${color};"></div></div>` +
              `<div style="text-align:right;">${escHtml((avg >= 0 ? "+" : "") + avg.toFixed(2) + "%")}</div>` +
              `</div>`
            );
          })
          .join("");
        renderSimpleTable(
          "reportSectorHeatTable",
          ["sector", "avg_pct_change", "pct_advancing", "tickers", "near_high_count", "near_low_count"],
          sectorRows.slice(0, 20),
          false,
          null,
          { sortable: true },
        );
        renderWatchlistTable();

        const yoloDelta = yoloBlock.delta || {};
        const yoloNew = yoloDelta.new_patterns || [];
        const yoloLost = yoloDelta.lost_patterns || [];
        $("reportYoloDeltaSummary").textContent =
          `Comparing ${yoloDelta.prev_asof || "?"} -> ${yoloDelta.today_asof || "?"}` +
          ` • New: ${yoloDelta.new_count ?? yoloNew.length}` +
          ` • No longer detected: ${yoloDelta.lost_count ?? yoloLost.length}`;
        renderSimpleTable(
          "reportYoloNewTable",
          ["ticker", "timeframe", "pattern", "confidence", "x0_date", "x1_date"],
          yoloNew.slice(0, 20),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );
        renderSimpleTable(
          "reportYoloLostTable",
          ["ticker", "timeframe", "pattern", "confidence", "x0_date", "x1_date"],
          yoloLost.slice(0, 20),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        const breadth = signals.market_breadth || {};
        const pctAdv = breadth.pct_advancing ?? "—";
        const adv = breadth.advancers ?? 0;
        const dec = breadth.decliners ?? 0;
        const unch = breadth.unchanged ?? 0;
        const avgMove = breadth.avg_pct_change ?? "—";
        const medianMove = breadth.median_pct_change ?? "—";
        const moveThresh = breadth.large_move_threshold_pct ?? "—";
        const moveCount = breadth.large_move_count ?? 0;
        $("reportBreadthSummary").innerHTML =
          `Breadth: <b>${adv}</b> up / <b>${dec}</b> down / <b>${unch}</b> flat` +
          ` • Advancing: <b>${pctAdv}%</b>` +
          ` • Avg move: <b>${avgMove}%</b>` +
          ` • Median move: <b>${medianMove}%</b>` +
          ` • |move| >= ${moveThresh}%: <b>${moveCount}</b>`;

        renderSimpleTable(
          "reportMoversUpTable",
          ["ticker", "pct_change", "close", "prev_close", "pct_from_high"],
          (signals.movers_up_today || []).slice(0, 12),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );
        renderSimpleTable(
          "reportMoversDownTable",
          ["ticker", "pct_change", "close", "prev_close", "pct_from_low"],
          (signals.movers_down_today || []).slice(0, 12),
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false },
        );

        // 52W extremes
        const nearHigh = signals.near_52w_high || [];
        const nearLow  = signals.near_52w_low  || [];
        const fmt52w = (arr, field, refField, color) =>
          arr.length
            ? arr.map(t =>
                `<span style="display:inline-block; margin-right:10px;">` +
                `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
                `<span style="color:var(--fg)">$${t.close}</span> ` +
                `<span style="color:var(--muted); font-size:0.75rem;">(${t[field].toFixed(2)}% from ${refField} $${t[refField === 'high_52w' ? 'high_52w' : 'low_52w']})</span>` +
                `</span>`
              ).join("")
            : `<span style="color:var(--muted)">None</span>`;

        $("report52wHigh").innerHTML = nearHigh.length
          ? nearHigh.map(t =>
              `<span style="display:inline-block; margin-right:12px; margin-bottom:2px;">` +
              `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
              `<span>$${t.close}</span> ` +
              `<span style="color:var(--muted); font-size:0.75rem;">(${t.pct_from_high.toFixed(2)}% below $${t.high_52w})</span>` +
              `</span>`
            ).join("")
          : `<span style="color:var(--muted)">None</span>`;

        $("report52wLow").innerHTML = nearLow.length
          ? nearLow.map(t =>
              `<span style="display:inline-block; margin-right:12px; margin-bottom:2px;">` +
              `<b style="cursor:pointer; color:var(--blue);" onclick="jumpToTicker('${t.ticker}')">${t.ticker}</b> ` +
              `<span>$${t.close}</span> ` +
              `<span style="color:var(--muted); font-size:0.75rem;">(${t.pct_from_low.toFixed(2)}% above $${t.low_52w})</span>` +
              `</span>`
            ).join("")
          : `<span style="color:var(--muted)">None</span>`;

        // Top YOLO patterns at close
        renderSimpleTable("reportYoloTopTable",
          ["ticker", "timeframe", "pattern", "confidence", "age_days", "x0_date", "x1_date", "as_of_date"],
          signals.yolo_top_today || [],
          true,
          (row) => row && row.ticker ? loadTickerQuick(row.ticker) : null,
          { sortable: false });

        // Candle signals at close
        renderSimpleTable("reportCandleTable",
          ["ticker", "pattern", "bias", "confidence"],
          signals.candle_patterns_today || [],
          false, null, { sortable: false });

        renderSimpleTable("reportHistoryTable",
          ["file", "size_bytes", "modified_ts"],
          data.history || [],
          false, null, { sortable: false });

        const asOf = `As of ${(latest.generated_ts || "").slice(0, 16).replace("T", " ")} UTC`;
        $("reportStatus").textContent = data.detail ? `${asOf} • ${data.detail}` : asOf;
      } catch (err) {
        $("reportStatus").textContent = `Error: ${err.message}`;
        console.error(err);
      }
    }

    function setChartTimeframe(tf) {
      CHART_TIMEFRAME = tf;
      $("tfDailyBtn").style.background  = tf === "daily"  ? "var(--blue)" : "var(--card)";
      $("tfDailyBtn").style.color        = tf === "daily"  ? "#fff"        : "var(--muted)";
      $("tfDailyBtn").style.border       = tf === "daily"  ? "none"        : "1px solid var(--border)";
      $("tfWeeklyBtn").style.background  = tf === "weekly" ? "var(--blue)" : "var(--card)";
      $("tfWeeklyBtn").style.color        = tf === "weekly" ? "#fff"        : "var(--muted)";
      $("tfWeeklyBtn").style.border       = tf === "weekly" ? "none"        : "1px solid var(--border)";
      if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD);
    }

    $("loadOpBtn").addEventListener("click", loadOpportunities);
    $("presetAllBtn").addEventListener("click", () => applyOpportunityPreset("all"));
    $("presetUndervaluedBtn").addEventListener("click", () => applyOpportunityPreset("undervalued"));
    $("presetDeepValueBtn").addEventListener("click", () => applyOpportunityPreset("deep_value"));
    $("presetOvervaluedBtn").addEventListener("click", () => applyOpportunityPreset("overvalued"));
    $("presetResetBtn").addEventListener("click", () => applyOpportunityPreset("reset"));
    $("clearOpSearchBtn").addEventListener("click", () => {
      if ($("opSearch")) $("opSearch").value = "";
      loadOpportunities();
    });
    $("loadChartBtn").addEventListener("click", loadChart);
    $("reportWatchAddBtn").addEventListener("click", () => {
      const input = $("reportWatchTickerInput");
      if (!input) return;
      const symbol = normalizeTickerSymbol(input.value);
      if (!symbol) return;
      addTickerToWatchlist(symbol);
      input.value = "";
    });
    $("reportWatchImportBtn").addEventListener("click", () => {
      const picks = (LAST_REPORT_SETUP_ROWS || []).slice(0, 5).map((r) => r.ticker).filter(Boolean);
      if (!picks.length) return;
      const merged = [...new Set([...getStoredWatchlist(), ...picks])];
      saveStoredWatchlist(merged);
      renderWatchlistTable();
    });
    $("reportWatchClearBtn").addEventListener("click", () => {
      saveStoredWatchlist([]);
      renderWatchlistTable();
    });
    $("reportWatchTickerInput").addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      $("reportWatchAddBtn").click();
    });
    $("tfDailyBtn").addEventListener("click", () => setChartTimeframe("daily"));
    $("tfWeeklyBtn").addEventListener("click", () => setChartTimeframe("weekly"));
    window.addEventListener("keydown", (e) => { if (e.key === "Enter") loadChart(); });
    $("showTrendlines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showPatterns").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showRuleClassLines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showCvClassLines").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });
    $("showYoloPatterns").addEventListener("change", () => { if (LAST_CHART_PAYLOAD) renderChart(LAST_CHART_PAYLOAD); });

    (async () => {
      activateTab("guide");
      await initApiBase();
      await initApiKey();
      await refreshServiceStatus();
      await loadTickerUniverse();
      await loadOpportunities();
      setInterval(refreshServiceStatus, 120000);
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") refreshServiceStatus();
      });
    })();
  </script>
</body>
</html>
